import{r as ae,s as re,t as le,j as e,v as ie,w as ce,x as de,y as me,z as ue,A as pe,B as he,C as ge,D as ye}from"./index-Ckq3KRsQ.js";import{r as c}from"./vendor-react-B6URQkMn.js";import{C as xe}from"./customhead-w2z64GoN.js";import{P as fe}from"./papaparse.min-CPTD01QN.js";import{F as Ce,B as je}from"./index-D-k-o6LC.js";import{x as we,y as ke,z as ve,a9 as O,A as Re,n as y,P as _,g as Se,S as q,T as E,Z as Ae,_ as N,o as Pe,$ as be,p as De,ab as Fe,ac as g}from"./vendor-coreui-BDhfDOiu.js";import{l}from"./activityLogger-D-LBOaus.js";import"./vendor-redux-DipIbRRz.js";import"./axiosInstance-CG7fZnUU.js";const V=({visible:j,onClose:w,userId:f})=>{const[k,M]=c.useState([]),U=sessionStorage.getItem("name"),p=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:x,isLoading:A,error:b}=ae(f),P=Array.isArray(x==null?void 0:x.permissions)?x.permissions:Array.isArray(x)?x:[],[$]=re(),[u]=le(),v=n=>{n.stopPropagation()},R=n=>{M(D=>D.includes(n)?D.filter(B=>B!==n):[...D,n])},T=async()=>{if(!f){console.error("❌ Error: userId is null before making the API request.");return}try{await $({userId:f,newPermissions:k,grantedBy:U}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),w()}catch(n){console.error("❌ Error granting access:",n),alert("Failed to grant access.")}},I=async()=>{if(!f){console.error("❌ Error: userId is null before making the API request.");return}try{await u({userId:f,permissionsToRemove:k}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),w()}catch(n){console.error("❌ Error revoking access:",n),alert("Failed to revoke access.")}};return A?e.jsx("div",{children:"Loading permissions..."}):b?e.jsxs("div",{children:["Error loading permissions: ",b.toString()]}):e.jsxs(we,{visible:j,onClose:w,onClick:v,children:[e.jsx(ke,{onClick:v,children:"Manage Access Permission"}),e.jsxs(ve,{onClick:v,children:[e.jsx("h5",{children:"Grant Access"}),p.map(n=>e.jsx(O,{label:n.name,checked:k.includes(n.to),onChange:()=>R(n.to)},n.to)),e.jsx("h5",{children:"Revoke Access"}),P.map(n=>e.jsx(O,{label:n,checked:k.includes(n),onChange:()=>R(n)},n))]}),e.jsxs(Re,{onClick:v,children:[e.jsx(y,{color:"secondary",onClick:w,children:"Cancel"}),e.jsx(y,{color:"primary",onClick:T,children:"Grant Access"}),e.jsx(y,{color:"danger",onClick:I,children:"Revoke Access"})]})]})};V.propTypes={visible:_.bool.isRequired,onClose:_.func.isRequired,userId:_.string.isRequired};const Oe=()=>{const{data:j,isLoading:w,error:f}=ie(),[k]=ce(),[M]=de(),[U]=me(),[p,x]=c.useState(null),[A,b]=c.useState(""),[P,$]=c.useState({}),[u,v]=c.useState("all"),[R,T]=c.useState("all"),[I,n]=c.useState(null),[D,B]=c.useState(!1),[Ee,Me]=c.useState({userId:null,userName:null,newRole:null}),[Ue,$e]=c.useState({userId:null,userName:null}),[Q,L]=c.useState(!1),[G,z]=c.useState(!1),[W]=ue(),a=sessionStorage.getItem("role"),r=sessionStorage.getItem("department"),i=sessionStorage.getItem("name"),[Z]=pe(),[J]=he(),[K]=ge(),[X]=ye();if(c.useEffect(()=>{p&&(console.log("🟢 Opening Modal with userId:",p),L(!0))},[p]),c.useEffect(()=>{l({name:i,role:a,department:r,route:"/employees",action:"Page Visit",description:"User visited the Employees page"})},[]),w)return e.jsx("div",{children:"Loading..."});if(f)return e.jsxs("div",{children:["Error: ",f.message]});const Y=async s=>{const o=P[s]||"";if(!o){alert("Please select a role before updating.");return}try{await k({userId:s,newRole:o}),alert("Role updated successfully!");const t=j.find(C=>C._id===s),m=t?t.name:"Unknown User";l({name:m,role:a,department:r,route:"/employees",action:"Role Change",description:`Changed role for ${(t==null?void 0:t.name)||"Unknown User"} to ${o}`})}catch{alert("Error updating role"),l({name:i,role:a,department:r,route:"/employees",action:"Role Change Failed",description:`Failed to change role for user ID: ${s}`})}},ee=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{const o=j.find(m=>m._id===s),t=o?o.name:"Unknown User";await M({userId:s}),alert("User deleted successfully!"),l({name:i,role:a,department:r,route:"/employees",action:"Delete User",description:`Deleted user: ${t}`})}catch{alert("Error deleting user"),l({name:i,role:a,department:r,route:"/employees",action:"Delete User Failed",description:`Failed to delete user ID: ${s}`})}},se=()=>{const s=["Username","Name","Email","Phone Number","Country","Occupation","Role","Department"],o=F.map(d=>[d.username,d.name,d.email,d.phoneNumber,d.country,d.occupation,d.role,d.department]),t=fe.unparse([s,...o]),m=new Blob([t],{type:"text/csv;charset=utf-8;"}),C=URL.createObjectURL(m),h=document.createElement("a");h.href=C,h.download="All_Employees.csv",h.click(),URL.revokeObjectURL(C),l({name:i,role:a,department:r,route:"/employees",action:"Download Data",description:`Downloaded employee data (${F.length} records)`})},F=j.filter(s=>{const o=s.username||"",t=s.email||"",m=o.toLowerCase().includes(A.toLowerCase())||t.toLowerCase().includes(A.toLowerCase()),C=u==="all"||s.department===u,h=R==="all"||s.role===R;return m&&C&&h}),H=async(s,o)=>{try{const t=await U(s).unwrap(),{token:m,message:C}=t;n(m),alert(C);const h=j.find(ne=>ne._id===s),d={...h,oauthToken:m,department:o.toUpperCase()};let S;switch(o.toLowerCase()){case"hr":S=await Z({payload:d}).unwrap();break;case"finance":S=await J({payload:d}).unwrap();break;case"core":S=await K({payload:d}).unwrap();break;case"logistics":S=await X({payload:d}).unwrap();break;default:throw new Error("Invalid department")}console.log(`Response from ${o}:`,S),alert(S.message),l({name:i,role:a,department:r,route:"/employees",action:"Send to Department",description:`Sent user ${(h==null?void 0:h.name)||"Unknown"} data to ${o} department`})}catch(t){console.error("Error during generation and sending:",t),alert("Failed to generate token or send data."),l({name:i,role:a,department:r,route:"/employees",action:"Send to Department Failed",description:`Failed to send user data to ${o} department`})}},oe=()=>{if(u==="all"){alert("Please select a department to generate token.");return}const s=F.filter(o=>o.department===u);if(s.length===0){alert(`No employees found in ${u} department.`);return}s.forEach(o=>{H(o._id,u)}),l({name:i,role:a,department:r,route:"/employees",action:"Bulk Send to Department",description:`Sent ${s.length} employees' data to ${u} department`})},te=async s=>{try{const o=j.find(m=>m._id===s);if(!o||!o.email){alert("User email not found");return}const t=await W(o.email).unwrap();alert(t.message||"Reset password link sent successfully"),l({name:i,role:a,department:r,route:"/employees",action:"Password Reset",description:`Sent password reset link to ${o.name} (${o.email})`})}catch(o){console.error("Error resetting password:",o),alert(o.message||"Failed to send reset password link"),l({name:i,role:a,department:r,route:"/employees",action:"Password Reset Failed",description:`Failed to send password reset link to user ID: ${s}`})}};return e.jsx(Se,{m:"1.5rem 2.5rem",children:e.jsxs(q,{children:[e.jsx(xe,{title:"Employees",subtitle:"List of Employees"}),e.jsx(E,{xs:"12",className:"mb-3",children:e.jsx(Ae,{placeholder:"Search by Username or Email",value:A,onChange:s=>{b(s.target.value),s.target.value&&s.target.value.length>=3&&l({name:i,role:a,department:r,route:"/employees",action:"Search",description:`User searched for: "${s.target.value}"`})}})}),e.jsxs(q,{className:"mb-3",children:[e.jsx(E,{xs:"4",children:e.jsxs(N,{value:u,onChange:s=>{v(s.target.value),s.target.value!=="all"&&l({name:i,role:a,department:r,route:"/employees",action:"Filter",description:`Filtered employees by department: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(E,{xs:"4",children:e.jsxs(N,{value:R,onChange:s=>{T(s.target.value),s.target.value!=="all"&&l({name:i,role:a,department:r,route:"/employees",action:"Filter",description:`Filtered employees by role: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(E,{xs:"4",className:"d-flex justify-content-end",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs(y,{color:"info",onClick:se,size:"sm",className:"me-2",children:[e.jsx(Ce,{icon:je})," Download All"]}),e.jsxs(y,{color:"success",onClick:oe,size:"sm",children:["Send to ",u," Department"]})]})})]}),F.map(s=>e.jsxs(Pe,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),p!==s._id&&l({name:i,role:a,department:r,route:"/employees",action:"View Employee",description:`Viewed details for employee: ${s.name}`}),x(t=>t===s._id?null:s._id),z(!1))},children:[e.jsxs(be,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),e.jsx(y,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),l({name:i,role:a,department:r,route:"/employees",action:"Access Management",description:`Opened access management for: ${s.name}`}),x(s._id),z(!0),setTimeout(()=>{L(!0)},100)},children:"Access"})]}),p&&G&&e.jsx(V,{visible:Q,onClose:()=>{L(!1),l({name:i,role:a,department:r,route:"/employees",action:"Close Access Management",description:`Closed access management modal for employee ID: ${p}`})},userId:p}),p===s._id&&!G&&e.jsx(De,{children:e.jsxs(Fe,{children:[e.jsxs(g,{children:["Email: ",s.email]}),e.jsxs(g,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(g,{children:["Country: ",s.country]}),e.jsxs(g,{children:["Occupation: ",s.occupation]}),e.jsxs(g,{children:["Role: ",s.role]}),e.jsxs(g,{children:["Department: ",s.department]}),e.jsx(g,{children:e.jsxs(N,{value:P[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>{const t=o.target.value;$({...P,[s._id]:t}),t&&l({name:i,role:a,department:r,route:"/employees",action:"Select Role",description:`Selected role ${t} for ${s.name}`})},children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(g,{children:[e.jsx(y,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),Y(s._id)},children:"Change Role"}),e.jsx(y,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),ee(s._id)},children:"Fire User"})]}),e.jsx(g,{children:s.department!=="Administrative"&&e.jsxs(y,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),H(s._id,s.department)},children:["Send to ",s.department]})}),e.jsx(g,{children:e.jsx(y,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),te(s._id)},children:"Send link to reset password"})})]})})]},s._id))]})})};export{Oe as default};
