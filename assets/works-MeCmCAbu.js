import{o as ye,p as je,q as fe,j as e,r as we,s as Ce,t as ve,v as ke}from"./index-Cn-1NiAH.js";import{r as l}from"./vendor-react-BHxUanFt.js";import{C as Se}from"./customhead-CvriITrM.js";import"./papaparse.min-BRjzmhib.js";import{F as h,L as be,m as Ae,c as P,K as Re,Y as Ne,ai as De}from"./index-BbcC8ntF.js";import{H as ee,I as se,K as oe,z as J,O as ae,l as g,P as T,C as Pe,a as X,b as F,k as Fe,B,Q as Ee,R as Ue,S as Me,T as b,d as Le,n as Ie,e as _e,a0 as $e,a1 as x,g as ze}from"./vendor-coreui-blXmWd_E.js";import{a as Te}from"./axiosInstance-Bq-uIJjs.js";import{l as c}from"./activityLogger-D6Lc4RsL.js";import"./vendor-redux-CSji-Y9p.js";import"./index-xsH4HHeE.js";const re=({visible:j,onClose:f,userId:y})=>{const[w,E]=l.useState([]),m=localStorage.getItem("name"),A=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:d,isLoading:U,error:C}=ye(y),M=Array.isArray(d==null?void 0:d.permissions)?d.permissions:Array.isArray(d)?d:[],[v]=je(),[L]=fe(),u=t=>{t.stopPropagation()},R=t=>{E(N=>N.includes(t)?N.filter(q=>q!==t):[...N,t])},G=async()=>{if(!y){console.error("❌ Error: userId is null before making the API request.");return}try{await v({userId:y,newPermissions:w,grantedBy:m}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),f()}catch(t){console.error("❌ Error granting access:",t),alert("Failed to grant access.")}},H=async()=>{if(!y){console.error("❌ Error: userId is null before making the API request.");return}try{await L({userId:y,permissionsToRemove:w}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),f()}catch(t){console.error("❌ Error revoking access:",t),alert("Failed to revoke access.")}};return U?e.jsx("div",{children:"Loading permissions..."}):C?e.jsxs("div",{children:["Error loading permissions: ",C.toString()]}):e.jsxs(ee,{visible:j,onClose:f,onClick:u,children:[e.jsx(se,{onClick:u,children:"Manage Access Permission"}),e.jsxs(oe,{onClick:u,children:[e.jsx("h5",{children:"Grant Access"}),A.map(t=>e.jsx(J,{label:t.name,checked:w.includes(t.to),onChange:()=>R(t.to)},t.to)),e.jsx("h5",{children:"Revoke Access"}),M.map(t=>e.jsx(J,{label:t,checked:w.includes(t),onChange:()=>R(t)},t))]}),e.jsxs(ae,{onClick:u,children:[e.jsx(g,{color:"secondary",onClick:f,children:"Cancel"}),e.jsx(g,{color:"primary",onClick:G,children:"Grant Access"}),e.jsx(g,{color:"danger",onClick:H,children:"Revoke Access"})]})]})};re.propTypes={visible:T.bool.isRequired,onClose:T.func.isRequired,userId:T.string.isRequired};const Xe=()=>{const{data:j,isLoading:f,error:y}=we(),[w]=Ce(),[E]=ve(),[m,A]=l.useState(null),[d,U]=l.useState(""),[C,M]=l.useState({}),[v,L]=l.useState("all"),[u,R]=l.useState("all"),[G,H]=l.useState(!1),[t,N]=l.useState({userId:null,userName:null,newRole:null}),[q,Be]=l.useState({userId:null,userName:null}),[te,I]=l.useState(!1),[O,Q]=l.useState(!1),[ne,_]=l.useState(!1),[V,le]=l.useState(""),[ie,ce]=l.useState(""),[K,W]=l.useState(!1),[Ge,Y]=l.useState(!1),[de]=ke(),n=localStorage.getItem("role"),a=localStorage.getItem("department"),i=localStorage.getItem("name"),Z=localStorage.getItem("username"),D=n==="superadmin"&&a==="Administrative";if(l.useEffect(()=>{m&&(console.log("🟢 Opening Modal with userId:",m),I(!0))},[m]),l.useEffect(()=>{c({name:i,role:n,department:a,route:"/employees",action:"Page Visit",description:"User visited the Employees page"})},[]),f)return e.jsx("div",{children:"Loading..."});if(y)return e.jsxs("div",{children:["Error: ",y.message]});const me=async s=>{const o=C[s]||"";if(!o){alert("Please select a role before updating.");return}try{await w({userId:s,newRole:o}),alert("Role updated successfully!");const r=j.find(S=>S._id===s),p=r?r.name:"Unknown User";c({name:p,role:n,department:a,route:"/employees",action:"Role Change",description:`Changed role for ${(r==null?void 0:r.name)||"Unknown User"} to ${o}`})}catch{alert("Error updating role"),c({name:i,role:n,department:a,route:"/employees",action:"Role Change Failed",description:`Failed to change role for user ID: ${s}`})}},ue=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{const o=j.find(p=>p._id===s),r=o?o.name:"Unknown User";await E({userId:s}),alert("User deleted successfully!"),c({name:i,role:n,department:a,route:"/employees",action:"Delete User",description:`Deleted user: ${r}`})}catch{alert("Error deleting user"),c({name:i,role:n,department:a,route:"/employees",action:"Delete User Failed",description:`Failed to delete user ID: ${s}`})}},$=async s=>{try{Y(!0);let o="",r={};switch(s){case"all":o="All_Employees";break;case"current-filter":o="Filtered_Employees",r={searchTerm:d,department:v,role:u};break}const p=await Te.post("/management/downloadZip",{name:i,role:n,username:Z,downloadType:s,filterParams:r},{responseType:"blob"}),S=i.substring(0,2)+n.charAt(0)+Z.slice(-6);le(S),ce(`${o}_Protected.zip`),_(!0);const z=window.URL.createObjectURL(new Blob([p.data])),k=document.createElement("a");k.href=z,k.setAttribute("download",`${o}_Protected.zip`),document.body.appendChild(k),k.click(),document.body.removeChild(k),c({name:i,role:n,department:a,route:"/employees",action:"Download Protected Data",description:`Downloaded ${o} as password-protected zip`})}catch(o){console.error("Error creating protected zip:",o),alert("Failed to create protected download. Please try again.")}finally{Y(!1)}},pe=()=>{navigator.clipboard.writeText(V),W(!0),setTimeout(()=>W(!1),3e3)},he=j.filter(s=>{const o=s.username||"",r=s.email||"",p=o.toLowerCase().includes(d.toLowerCase())||r.toLowerCase().includes(d.toLowerCase()),S=v==="all"||s.department===v,z=u==="all"||s.role===u,ge=!["HR","Core","Finance","Logistics"].includes(a)||s.department===a;return p&&S&&z&&ge}),xe=async s=>{try{const o=j.find(p=>p._id===s);if(!o||!o.email){alert("User email not found");return}const r=await de(o.email).unwrap();alert(r.message||"Reset password link sent successfully"),c({name:i,role:n,department:a,route:"/employees",action:"Password Reset",description:`Sent password reset link to ${o.name} (${o.email})`})}catch(o){console.error("Error resetting password:",o),alert(o.message||"Failed to send reset password link"),c({name:i,role:n,department:a,route:"/employees",action:"Password Reset Failed",description:`Failed to send password reset link to user ID: ${s}`})}};return e.jsxs(Pe,{m:"1.5rem 2.5rem",children:[e.jsxs(X,{children:[e.jsx(Se,{title:"Employees",subtitle:"List of Employees"}),e.jsx(F,{xs:"12",className:"mb-3",children:e.jsx(Fe,{placeholder:"Search by Username or Email",value:d,onChange:s=>{U(s.target.value),s.target.value&&s.target.value.length>=3&&c({name:i,role:n,department:a,route:"/employees",action:"Search",description:`User searched for: "${s.target.value}"`})}})}),e.jsxs(X,{className:"mb-3",children:[e.jsx(F,{xs:"4",children:e.jsxs(B,{value:v,onChange:s=>{L(s.target.value),s.target.value!=="all"&&c({name:i,role:n,department:a,route:"/employees",action:"Filter",description:`Filtered employees by department: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(F,{xs:"4",children:e.jsxs(B,{value:u,onChange:s=>{R(s.target.value),s.target.value!=="all"&&c({name:i,role:n,department:a,route:"/employees",action:"Filter",description:`Filtered employees by role: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(F,{xs:"4",className:"d-flex justify-content-end",children:e.jsx("div",{className:"d-flex align-items-center",children:(D||["HR","Core","Finance","Logistics"].includes(a))&&e.jsxs(Ee,{className:"download-dropdown",children:[e.jsxs(Ue,{color:"primary",size:"sm",className:"d-flex align-items-center",children:[e.jsx(h,{icon:be,className:"me-2"}),e.jsx("span",{children:"Export Data"})]}),e.jsxs(Me,{className:"shadow-sm p-2",children:[e.jsx("h6",{className:"dropdown-header text-primary",children:"Quick Export"}),e.jsxs(b,{onClick:()=>$("all"),className:"d-flex align-items-center",children:[e.jsx(h,{icon:Ae,className:"me-2 text-secondary"}),e.jsx(h,{icon:P,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"All Employees (Protected)"})]}),e.jsxs(b,{onClick:()=>$("current-filter"),className:"d-flex align-items-center",children:[e.jsx(h,{icon:Re,className:"me-2 text-secondary"}),e.jsx(h,{icon:P,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Current Filter Results (Protected)"})]}),e.jsx(b,{divider:!0,className:"my-2"}),e.jsx(b,{header:!0,className:"text-primary",children:"By Department"}),e.jsx("div",{className:"department-items",children:e.jsxs(b,{onClick:()=>$(a.toLowerCase()),className:"d-flex align-items-center",children:[e.jsx(h,{icon:Ne,className:"me-2 text-secondary"}),e.jsx(h,{icon:P,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:a})]})})]})]})})})]}),he.map(s=>e.jsxs(Le,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),m!==s._id&&c({name:i,role:n,department:a,route:"/employees",action:"View Employee",description:`Viewed details for employee: ${s.name}`}),A(r=>r===s._id?null:s._id),Q(!1))},children:[e.jsxs(Ie,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),D&&e.jsx(g,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),c({name:i,role:n,department:a,route:"/employees",action:"Access Management",description:`Opened access management for: ${s.name}`}),A(s._id),Q(!0),setTimeout(()=>{I(!0)},100)},children:"Access"})]}),m&&O&&D&&e.jsx(re,{visible:te,onClose:()=>{I(!1),c({name:i,role:n,department:a,route:"/employees",action:"Close Access Management",description:`Closed access management modal for employee ID: ${m}`})},userId:m}),m===s._id&&!O&&e.jsx(_e,{children:e.jsxs($e,{children:[e.jsxs(x,{children:["Email: ",s.email]}),e.jsxs(x,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(x,{children:["Country: ",s.country]}),e.jsxs(x,{children:["Occupation: ",s.occupation]}),e.jsxs(x,{children:["Role: ",s.role]}),e.jsxs(x,{children:["Department: ",s.department]}),D&&e.jsxs(e.Fragment,{children:[e.jsx(x,{children:e.jsxs(B,{value:C[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>{const r=o.target.value;M({...C,[s._id]:r}),r&&c({name:i,role:n,department:a,route:"/employees",action:"Select Role",description:`Selected role ${r} for ${s.name}`})},children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(x,{children:[e.jsx(g,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),me(s._id)},children:"Change Role"}),e.jsx(g,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),ue(s._id)},children:"Fire User"})]}),e.jsx(x,{children:e.jsx(g,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),xe(s._id)},children:"Send link to reset password"})})]})]})})]},s._id))]}),e.jsxs(ee,{visible:ne,onClose:()=>_(!1),alignment:"center",children:[e.jsx(se,{closeButton:!0,children:e.jsx("h5",{className:"mb-0",children:"Secure Download Information"})}),e.jsxs(oe,{children:[e.jsxs(ze,{color:"info",className:"d-flex align-items-center mb-3",children:[e.jsx(h,{icon:P,className:"me-2"}),e.jsxs("div",{children:["Your file ",e.jsx("strong",{children:ie})," is being downloaded as a password-protected zip file for security."]})]}),e.jsx("p",{className:"mb-4",children:"To open this file, you'll need the following password:"}),e.jsx("div",{className:"password-container p-3 bg-light border rounded mb-4",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("code",{className:"password-display fs-5",children:V}),e.jsxs(g,{color:"secondary",size:"sm",onClick:pe,disabled:K,children:[e.jsx(h,{icon:De,className:"me-1"}),K?"Copied!":"Copy"]})]})}),e.jsx("p",{className:"small text-muted",children:"This password is securely generated based on your account details and is unique to you. Please keep it confidential and do not share it with unauthorized personnel."})]}),e.jsx(ae,{children:e.jsx(g,{color:"primary",onClick:()=>_(!1),children:"Close"})})]})]})};export{Xe as default};
