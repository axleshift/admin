import{o as je,p as ge,q as ye,j as e,r as fe,s as Ce,t as we,v as ke}from"./index-Bf0IcOp-.js";import{r as l}from"./vendor-react-B6URQkMn.js";import{C as ve}from"./customhead-B3xrZeJV.js";import"./papaparse.min-CPTD01QN.js";import{F as o,A as Ne,U as Ae,u,V as be,W as Se,J as Re,X as Pe,Y as De,Z as Fe,_ as Ee,$ as Ue,f as Me,a0 as ze}from"./index-CL47NU8L.js";import{s as ee,t as se,v as ae,a4 as J,w as oe,j as f,P as T,c as _e,N as K,O as E,V as Ie,W as B,e as $e,f as Le,g as Te,h as m,k as Be,X as Ge,l as qe,a6 as He,a7 as y,S as Oe}from"./vendor-coreui-BN8uYOBb.js";import{a as Ve}from"./axiosInstance-Dv2jt_v_.js";import{l as d}from"./activityLogger-dj-FpP-1.js";import"./vendor-redux-C7peqcPR.js";import"./index-t--hEgTQ.js";const ne=({visible:w,onClose:k,userId:C})=>{const[v,U]=l.useState([]),x=localStorage.getItem("name"),R=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:p,isLoading:M,error:N}=je(C),z=Array.isArray(p==null?void 0:p.permissions)?p.permissions:Array.isArray(p)?p:[],[A]=ge(),[_]=ye(),j=r=>{r.stopPropagation()},P=r=>{U(D=>D.includes(r)?D.filter(H=>H!==r):[...D,r])},G=async()=>{if(!C){console.error("❌ Error: userId is null before making the API request.");return}try{await A({userId:C,newPermissions:v,grantedBy:x}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),k()}catch(r){console.error("❌ Error granting access:",r),alert("Failed to grant access.")}},q=async()=>{if(!C){console.error("❌ Error: userId is null before making the API request.");return}try{await _({userId:C,permissionsToRemove:v}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),k()}catch(r){console.error("❌ Error revoking access:",r),alert("Failed to revoke access.")}};return M?e.jsx("div",{children:"Loading permissions..."}):N?e.jsxs("div",{children:["Error loading permissions: ",N.toString()]}):e.jsxs(ee,{visible:w,onClose:k,onClick:j,children:[e.jsx(se,{onClick:j,children:"Manage Access Permission"}),e.jsxs(ae,{onClick:j,children:[e.jsx("h5",{children:"Grant Access"}),R.map(r=>e.jsx(J,{label:r.name,checked:v.includes(r.to),onChange:()=>P(r.to)},r.to)),e.jsx("h5",{children:"Revoke Access"}),z.map(r=>e.jsx(J,{label:r,checked:v.includes(r),onChange:()=>P(r)},r))]}),e.jsxs(oe,{onClick:j,children:[e.jsx(f,{color:"secondary",onClick:k,children:"Cancel"}),e.jsx(f,{color:"primary",onClick:G,children:"Grant Access"}),e.jsx(f,{color:"danger",onClick:q,children:"Revoke Access"})]})]})};ne.propTypes={visible:T.bool.isRequired,onClose:T.func.isRequired,userId:T.string.isRequired};const rs=()=>{const{data:w,isLoading:k,error:C}=fe(),[v]=Ce(),[U]=we(),[x,R]=l.useState(null),[p,M]=l.useState(""),[N,z]=l.useState({}),[A,_]=l.useState("all"),[j,P]=l.useState("all"),[G,q]=l.useState(!1),[r,D]=l.useState({userId:null,userName:null,newRole:null}),[H,We]=l.useState({userId:null,userName:null}),[re,I]=l.useState(!1),[O,V]=l.useState(!1),[te,$]=l.useState(!1),[W,le]=l.useState(""),[ie,ce]=l.useState(""),[Q,Z]=l.useState(!1),[Qe,X]=l.useState(!1),[de]=ke(),t=localStorage.getItem("role"),i=localStorage.getItem("department"),c=localStorage.getItem("name"),Y=localStorage.getItem("username"),F=t==="superadmin"&&i==="Administrative";if(l.useEffect(()=>{x&&(console.log("🟢 Opening Modal with userId:",x),I(!0))},[x]),l.useEffect(()=>{d({name:c,role:t,department:i,route:"/employees",action:"Page Visit",description:"User visited the Employees page"})},[]),k)return e.jsx("div",{children:"Loading..."});if(C)return e.jsxs("div",{children:["Error: ",C.message]});const me=async s=>{const a=N[s]||"";if(!a){alert("Please select a role before updating.");return}try{await v({userId:s,newRole:a}),alert("Role updated successfully!");const n=w.find(b=>b._id===s),g=n?n.name:"Unknown User";d({name:g,role:t,department:i,route:"/employees",action:"Role Change",description:`Changed role for ${(n==null?void 0:n.name)||"Unknown User"} to ${a}`})}catch{alert("Error updating role"),d({name:c,role:t,department:i,route:"/employees",action:"Role Change Failed",description:`Failed to change role for user ID: ${s}`})}},pe=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{const a=w.find(g=>g._id===s),n=a?a.name:"Unknown User";await U({userId:s}),alert("User deleted successfully!"),d({name:c,role:t,department:i,route:"/employees",action:"Delete User",description:`Deleted user: ${n}`})}catch{alert("Error deleting user"),d({name:c,role:t,department:i,route:"/employees",action:"Delete User Failed",description:`Failed to delete user ID: ${s}`})}},h=async s=>{try{X(!0);let a="",n={};switch(s){case"all":a="All_Employees";break;case"current-filter":a="Filtered_Employees",n={searchTerm:p,department:A,role:j};break}const g=await Ve.post("/management/downloadZip",{name:c,role:t,username:Y,downloadType:s,filterParams:n},{responseType:"blob"}),b=c.substring(0,2)+t.charAt(0)+Y.slice(-6);le(b),ce(`${a}_Protected.zip`),$(!0);const L=window.URL.createObjectURL(new Blob([g.data])),S=document.createElement("a");S.href=L,S.setAttribute("download",`${a}_Protected.zip`),document.body.appendChild(S),S.click(),document.body.removeChild(S),d({name:c,role:t,department:i,route:"/employees",action:"Download Protected Data",description:`Downloaded ${a} as password-protected zip`})}catch(a){console.error("Error creating protected zip:",a),alert("Failed to create protected download. Please try again.")}finally{X(!1)}},ue=()=>{navigator.clipboard.writeText(W),Z(!0),setTimeout(()=>Z(!1),3e3)},xe=w.filter(s=>{const a=s.username||"",n=s.email||"",g=a.toLowerCase().includes(p.toLowerCase())||n.toLowerCase().includes(p.toLowerCase()),b=A==="all"||s.department===A,L=j==="all"||s.role===j;return g&&b&&L}),he=async s=>{try{const a=w.find(g=>g._id===s);if(!a||!a.email){alert("User email not found");return}const n=await de(a.email).unwrap();alert(n.message||"Reset password link sent successfully"),d({name:c,role:t,department:i,route:"/employees",action:"Password Reset",description:`Sent password reset link to ${a.name} (${a.email})`})}catch(a){console.error("Error resetting password:",a),alert(a.message||"Failed to send reset password link"),d({name:c,role:t,department:i,route:"/employees",action:"Password Reset Failed",description:`Failed to send password reset link to user ID: ${s}`})}};return e.jsxs(_e,{m:"1.5rem 2.5rem",children:[e.jsxs(K,{children:[e.jsx(ve,{title:"Employees",subtitle:"List of Employees"}),e.jsx(E,{xs:"12",className:"mb-3",children:e.jsx(Ie,{placeholder:"Search by Username or Email",value:p,onChange:s=>{M(s.target.value),s.target.value&&s.target.value.length>=3&&d({name:c,role:t,department:i,route:"/employees",action:"Search",description:`User searched for: "${s.target.value}"`})}})}),e.jsxs(K,{className:"mb-3",children:[e.jsx(E,{xs:"4",children:e.jsxs(B,{value:A,onChange:s=>{_(s.target.value),s.target.value!=="all"&&d({name:c,role:t,department:i,route:"/employees",action:"Filter",description:`Filtered employees by department: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(E,{xs:"4",children:e.jsxs(B,{value:j,onChange:s=>{P(s.target.value),s.target.value!=="all"&&d({name:c,role:t,department:i,route:"/employees",action:"Filter",description:`Filtered employees by role: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(E,{xs:"4",className:"d-flex justify-content-end",children:e.jsx("div",{className:"d-flex align-items-center",children:F&&e.jsxs($e,{className:"download-dropdown",children:[e.jsxs(Le,{color:"primary",size:"sm",className:"d-flex align-items-center",children:[e.jsx(o,{icon:Ne,className:"me-2"}),e.jsx("span",{children:"Export Data"})]}),e.jsxs(Te,{className:"shadow-sm p-2",children:[e.jsx("h6",{className:"dropdown-header text-primary",children:"Quick Export"}),e.jsxs(m,{onClick:()=>h("all"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Ae,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"All Employees (Protected)"})]}),e.jsxs(m,{onClick:()=>h("current-filter"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:be,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Current Filter Results (Protected)"})]}),e.jsx(m,{divider:!0,className:"my-2"}),e.jsx(m,{header:!0,className:"text-primary",children:"By Department"}),e.jsxs("div",{className:"department-items",children:[e.jsxs(m,{onClick:()=>h("hr"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Se,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"HR"})]}),e.jsxs(m,{onClick:()=>h("finance"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Re,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Finance"})]}),e.jsxs(m,{onClick:()=>h("core"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Pe,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Core"})]}),e.jsxs(m,{onClick:()=>h("logistics"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:De,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Logistics"})]}),e.jsxs(m,{onClick:()=>h("administrative"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Fe,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Administrative"})]})]}),e.jsx(m,{divider:!0,className:"my-2"}),e.jsx(m,{header:!0,className:"text-primary",children:"By Role"}),e.jsxs("div",{className:"role-items",children:[e.jsxs(m,{onClick:()=>h("admin"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Ee,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Admins"})]}),e.jsxs(m,{onClick:()=>h("manager"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Ue,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Managers"})]}),e.jsxs(m,{onClick:()=>h("employee"),className:"d-flex align-items-center",children:[e.jsx(o,{icon:Me,className:"me-2 text-secondary"}),e.jsx(o,{icon:u,className:"me-1 text-secondary",size:"xs"}),e.jsx("span",{children:"Employees"})]})]})]})]})})})]}),xe.map(s=>e.jsxs(Be,{className:"mb-3",style:{cursor:"pointer"},onClick:a=>{a.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),x!==s._id&&d({name:c,role:t,department:i,route:"/employees",action:"View Employee",description:`Viewed details for employee: ${s.name}`}),R(n=>n===s._id?null:s._id),V(!1))},children:[e.jsxs(Ge,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),F&&e.jsx(f,{color:"primary",onClick:a=>{a.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),d({name:c,role:t,department:i,route:"/employees",action:"Access Management",description:`Opened access management for: ${s.name}`}),R(s._id),V(!0),setTimeout(()=>{I(!0)},100)},children:"Access"})]}),x&&O&&F&&e.jsx(ne,{visible:re,onClose:()=>{I(!1),d({name:c,role:t,department:i,route:"/employees",action:"Close Access Management",description:`Closed access management modal for employee ID: ${x}`})},userId:x}),x===s._id&&!O&&e.jsx(qe,{children:e.jsxs(He,{children:[e.jsxs(y,{children:["Email: ",s.email]}),e.jsxs(y,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(y,{children:["Country: ",s.country]}),e.jsxs(y,{children:["Occupation: ",s.occupation]}),e.jsxs(y,{children:["Role: ",s.role]}),e.jsxs(y,{children:["Department: ",s.department]}),F&&e.jsxs(e.Fragment,{children:[e.jsx(y,{children:e.jsxs(B,{value:N[s._id]||"",onClick:a=>a.stopPropagation(),onChange:a=>{const n=a.target.value;z({...N,[s._id]:n}),n&&d({name:c,role:t,department:i,route:"/employees",action:"Select Role",description:`Selected role ${n} for ${s.name}`})},children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(y,{children:[e.jsx(f,{color:"primary",size:"sm",onClick:a=>{a.stopPropagation(),me(s._id)},children:"Change Role"}),e.jsx(f,{color:"danger",size:"sm",className:"ms-2",onClick:a=>{a.stopPropagation(),pe(s._id)},children:"Fire User"})]}),e.jsx(y,{children:e.jsx(f,{color:"info",size:"sm",onClick:a=>{a.stopPropagation(),he(s._id)},children:"Send link to reset password"})})]})]})})]},s._id))]}),e.jsxs(ee,{visible:te,onClose:()=>$(!1),alignment:"center",children:[e.jsx(se,{closeButton:!0,children:e.jsx("h5",{className:"mb-0",children:"Secure Download Information"})}),e.jsxs(ae,{children:[e.jsxs(Oe,{color:"info",className:"d-flex align-items-center mb-3",children:[e.jsx(o,{icon:u,className:"me-2"}),e.jsxs("div",{children:["Your file ",e.jsx("strong",{children:ie})," is being downloaded as a password-protected zip file for security."]})]}),e.jsx("p",{className:"mb-4",children:"To open this file, you'll need the following password:"}),e.jsx("div",{className:"password-container p-3 bg-light border rounded mb-4",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("code",{className:"password-display fs-5",children:W}),e.jsxs(f,{color:"secondary",size:"sm",onClick:ue,disabled:Q,children:[e.jsx(o,{icon:ze,className:"me-1"}),Q?"Copied!":"Copy"]})]})}),e.jsx("p",{className:"small text-muted",children:"This password is securely generated based on your account details and is unique to you. Please keep it confidential and do not share it with unauthorized personnel."})]}),e.jsx(oe,{children:e.jsx(f,{color:"primary",onClick:()=>$(!1),children:"Close"})})]})]})};export{rs as default};
