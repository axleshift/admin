import{C as He,j as e}from"./index-Cx8KJ1ZF.js";import{r as c}from"./vendor-react-B6URQkMn.js";import{c as E,C as Pe,S as u,k as O,X as ce,o as a,j as m,l as B,ar as te,W as N,_ as Ae,y as n,ah as Ve,ai as U,s as T,t as $,ad as z,v as _,R as ne,a4 as Le,w as W,a7 as Fe,a8 as Ze,a5 as Ie}from"./vendor-coreui-DDUzhqJ9.js";import{l as b}from"./activityLogger-D6Lc4RsL.js";import{a as oe}from"./axiosInstance-Bq-uIJjs.js";import{c as De}from"./cil-lock-locked-DmxpJbVL.js";import{c as Ee,a as de,b as me}from"./cil-people-DOcwnkEl.js";import{c as Oe}from"./cil-clock-0brlqJOZ.js";import"./vendor-redux-C7peqcPR.js";import"./index-xsH4HHeE.js";var he=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M440,464V16H72V464H16v32H496V464Zm-32,0H272V400H240v64H104V48H408Z' class='ci-primary'/><rect width='32' height='32' x='160' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='160' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='160' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/>"],xe=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M426.072,86.928A238.75,238.75,0,0,0,88.428,424.572,238.75,238.75,0,0,0,426.072,86.928ZM257.25,462.5c-114,0-206.75-92.748-206.75-206.75S143.248,49,257.25,49,464,141.748,464,255.75,371.252,462.5,257.25,462.5Z' class='ci-primary'/><polygon fill='var(--ci-primary-color, currentColor)' points='221.27 305.808 147.857 232.396 125.23 255.023 221.27 351.063 388.77 183.564 366.142 160.937 221.27 305.808' class='ci-primary'/>"],Be=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M327.086,496.89l-142.6-142.6-11.258-11.15-85.6-85.6.054-.054,11.259-11.367,85.5-85.5.054.054,142.6-142.595L424,114.989,281.506,257.483,424,399.978ZM184.64,309.3l11.266,11.159,131.18,131.181,51.658-51.658L236.251,257.483,378.744,114.989,327.086,63.331,184.694,205.725l-.054-.054-51.813,51.812Z' class='ci-primary'/>"],Ue=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M183.505,496,86.237,398.73,229.412,255.556,86.237,112.38l97.268-97.27L326.732,158.338l11.316,11.209,85.9,85.9,0,0,.051.05-11.311,11.419-85.9,85.9-.055-.054Zm-52.013-97.27,52.013,52.014L326.629,307.62l.055.054L378.8,255.556l-52.127-52.128-11.308-11.2L183.505,60.366,131.492,112.38,274.667,255.556Z' class='ci-primary'/>"],Te=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M256.25,16A240,240,0,0,0,88,84.977V16H56V144H184V112H106.287A208,208,0,0,1,256.25,48C370.8,48,464,141.2,464,255.75S370.8,463.5,256.25,463.5,48.5,370.3,48.5,255.75h-32A239.75,239.75,0,0,0,425.779,425.279,239.75,239.75,0,0,0,256.25,16Z' class='ci-primary'/><polygon fill='var(--ci-primary-color, currentColor)' points='240 111.951 239.465 288 368 288 368 256 271.563 256 272 112.049 240 111.951' class='ci-primary'/>"],$e=["512 512","<rect width='288' height='32' x='112' y='152' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='288' height='32' x='112' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='152' height='32' x='112' y='328' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M480,48H32V464H480ZM448,432H64V80H448Z' class='ci-primary'/>"],ze=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M479.6,399.716l-81.084-81.084-62.368-25.767A175.014,175.014,0,0,0,368,192c0-97.047-78.953-176-176-176S16,94.953,16,192,94.953,368,192,368a175.034,175.034,0,0,0,101.619-32.377l25.7,62.2L400.4,478.911a56,56,0,1,0,79.2-79.195ZM48,192c0-79.4,64.6-144,144-144s144,64.6,144,144S271.4,336,192,336,48,271.4,48,192ZM456.971,456.284a24.028,24.028,0,0,1-33.942,0l-76.572-76.572-23.894-57.835L380.4,345.771l76.573,76.572A24.028,24.028,0,0,1,456.971,456.284Z' class='ci-primary'/>"],je=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M473.605,88.081c-1.352-.137-135.958-14.259-199.218-68.251L269.9,16H242.1l-4.488,3.83C174.464,73.727,39.744,87.944,38.4,88.081L24,89.532V104c0,89.133,14.643,165.443,43.523,226.813,38.105,80.973,100.1,133.669,184.267,156.623l4.21,1.148,4.21-1.148c84.165-22.954,146.162-75.65,184.267-156.623C473.357,269.443,488,193.133,488,104V89.532ZM455.87,118.113q-.237,12.789-.948,25.887H272V57.915C331.921,97.482,421.024,113.237,455.87,118.113ZM272,320H414.266A288.233,288.233,0,0,1,390.9,360H272Zm0-32V248H439.9a402.662,402.662,0,0,1-13.236,42.884V288Zm0-72V176H452.378c-1.4,13.307-3.256,26.682-5.639,40ZM56.13,118.113c34.846-4.876,123.949-20.631,183.87-60.2V450.224C94.012,398.389,58.492,245.387,56.13,118.113ZM272,450.224V392h92.347C340.049,416.7,309.708,436.836,272,450.224Z' class='ci-primary'/>"];const ss=()=>{var ae;const{data:t,error:R,isLoading:ue,refetch:G}=He(),[d,h]=c.useState(1),[S,pe]=c.useState(!0),[M,ve]=c.useState(!1),[f,ge]=c.useState(null),[fe,y]=c.useState(!1),[r,q]=c.useState(null),[x,k]=c.useState([]),[J,Q]=c.useState(""),[ye,H]=c.useState(!1),[we,w]=c.useState(!1),[p,X]=c.useState(""),[v,Y]=c.useState(""),[P,g]=c.useState(null),A=10,V=localStorage.getItem("role"),L=localStorage.getItem("department");localStorage.getItem("userId");const F=localStorage.getItem("name");c.useEffect(()=>{try{const s=localStorage.getItem("currentUser");if(s){const i=JSON.parse(s);ge(i),b({name:F,role:V,department:L,route:"admin/access-review",action:"VIEW",description:"Accessed permission review page"})}}catch(s){console.error("Failed to get current user:",s)}},[]);const K=s=>{switch(s==null?void 0:s.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"user":return"info";default:return"secondary"}},ee=s=>{switch(s==null?void 0:s.toLowerCase()){case"it":return je;case"hr":return de;case"finance":return me;case"marketing":return ze;default:return he}},se=(s,i=!1,l=null)=>{let o="info";if(s.includes("delete")||s.includes("admin")?o="danger":s.includes("edit")||s.includes("create")||s.includes("write")?o="warning":(s.includes("view")||s.includes("read"))&&(o="success"),i){const D=x.includes(s);return e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(Ie,{id:`${l}-${s}`,checked:!D,onChange:()=>Se(s),className:"me-2"}),e.jsx(n,{color:D?"secondary":o,className:D?"text-decoration-line-through":"",children:s})]})}return e.jsx(n,{color:o,className:"me-1 mb-1",children:s})},Ce=s=>{switch(s){case"Completed":return e.jsx(n,{color:"success",children:"Completed"});case"Pending":return e.jsx(n,{color:"warning",children:"Pending Review"});case"Overdue":return e.jsx(n,{color:"danger",children:"Overdue"});default:return e.jsx(n,{color:"secondary",children:"Not Reviewed"})}},j=((ae=t==null?void 0:t.users)==null?void 0:ae.filter(s=>!(S&&(!s.permissions||s.permissions.length===0)||M&&s.reviewStatus!=="Pending"||p&&s.department!==p||v&&s.role!==v)))||[],C=(j==null?void 0:j.length)||0,Z=Math.ceil(C/A),I=d*A,re=I-A,Ne=(j==null?void 0:j.slice(re,I))||[],be=s=>{q(s),k([]),Q(""),y(!0),b({name:F,role:V,department:L,route:"access-review",action:"OPEN_REVIEW",description:`Opened access review for user: ${s.name}`})},Re=s=>{q(s),H(!0),b({name:F,role:V,department:L,route:"admin/access-review",action:"VIEW_HISTORY",description:`Viewed access review history for user: ${s.name}`})},Se=s=>{x.includes(s)?k(x.filter(i=>i!==s)):k([...x,s])},Me=async()=>{var s,i;try{const l=await oe.post("/general/recertify",{userId:r._id,approved:r.permissions.filter(o=>!x.includes(o)),rejected:x,notes:J});g({type:"success",message:"User access has been successfully recertified!"}),y(!1),G()}catch(l){console.error("Failed to submit review:",l),g({type:"danger",message:`Error: ${((i=(s=l.response)==null?void 0:s.data)==null?void 0:i.message)||l.message}`})}},ke=async()=>{var s,i;try{const l=await oe.post("/general/initiate-review",{},{params:{department:p||void 0,role:v||void 0}});g({type:"success",message:`Access review initiated for ${l.data.usersAffected} users`}),w(!1),G()}catch(l){console.error("Failed to initiate review:",l),g({type:"danger",message:`Error: ${((i=(s=l.response)==null?void 0:s.data)==null?void 0:i.message)||l.message}`})}},ie=t!=null&&t.users?[...new Set(t.users.map(s=>s.department))].filter(Boolean):[],le=t!=null&&t.users?[...new Set(t.users.map(s=>s.role))].filter(Boolean):[];return ue?e.jsx(E,{className:"d-flex justify-content-center align-items-center",style:{minHeight:"300px"},children:e.jsx(Pe,{color:"primary"})}):R?(f&&b({name:f.name||"Unknown User",role:f.role||"Unknown Role",department:f.department||"Unknown Department",route:"admin/access-review",action:"ERROR",description:`Error loading permissions: ${R.message}`}),e.jsx(E,{className:"mt-4",children:e.jsxs(u,{color:"danger",children:["Error: ",R.message]})})):e.jsxs(E,{className:"mt-4",children:[P&&e.jsx(u,{color:P.type,dismissible:!0,onClose:()=>g(null),children:P.message}),e.jsxs(O,{className:"mb-4 shadow-sm",children:[e.jsxs(ce,{className:"bg-primary text-white d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(a,{icon:De,size:"xl",className:"me-2"}),e.jsx("h3",{className:"mb-0",children:"Access Control Review"})]}),e.jsxs(m,{color:"light",onClick:()=>w(!0),children:[e.jsx(a,{icon:Ee,className:"me-2"}),"Initiate Review"]})]}),e.jsxs(B,{children:[e.jsx("div",{className:"mb-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center",children:[e.jsx("div",{className:"me-4 mb-2",children:e.jsx(te,{id:"permissionFilter",label:"Show only users with permissions",checked:S,onChange:()=>{pe(!S),h(1)}})}),e.jsx("div",{className:"me-4 mb-2",children:e.jsx(te,{id:"pendingReviewFilter",label:"Show only pending reviews",checked:M,onChange:()=>{ve(!M),h(1)}})}),e.jsx("div",{className:"me-3 mb-2",children:e.jsxs(N,{id:"departmentFilter",size:"sm",value:p,onChange:s=>{X(s.target.value),h(1)},children:[e.jsx("option",{value:"",children:"All Departments"}),ie.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx("div",{className:"mb-2",children:e.jsxs(N,{id:"roleFilter",size:"sm",value:v,onChange:s=>{Y(s.target.value),h(1)},children:[e.jsx("option",{value:"",children:"All Roles"}),le.map(s=>e.jsx("option",{value:s,children:s},s))]})})]})}),C>0?e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{hover:!0,responsive:!0,striped:!0,className:"border",children:[e.jsx("thead",{className:"bg-light",children:e.jsxs("tr",{children:[e.jsxs("th",{children:[e.jsx(a,{icon:de,className:"me-2"}),"Name"]}),e.jsxs("th",{children:[e.jsx(a,{icon:me,className:"me-2"}),"Role"]}),e.jsxs("th",{children:[e.jsx(a,{icon:he,className:"me-2"}),"Department"]}),e.jsxs("th",{children:[e.jsx(a,{icon:je,className:"me-2"}),"Permissions"]}),e.jsxs("th",{children:[e.jsx(a,{icon:Oe,className:"me-2"}),"Review Status"]}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Ne.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"align-middle font-weight-bold",children:s.name}),e.jsx("td",{className:"align-middle",children:e.jsx(n,{color:K(s.role),children:s.role})}),e.jsx("td",{className:"align-middle",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(a,{icon:ee(s.department),className:"me-2"}),s.department]})}),e.jsx("td",{children:e.jsx(O,{className:"border-0 shadow-sm",children:e.jsx(B,{className:"p-3",children:e.jsx("div",{className:"d-flex flex-wrap",children:s.permissions&&s.permissions.length>0?s.permissions.map((i,l)=>e.jsx("div",{className:"me-1 mb-1",children:se(i)},l)):e.jsx(n,{color:"secondary",className:"text-muted",children:"No permissions assigned"})})})})}),e.jsx("td",{className:"align-middle",children:e.jsxs("div",{className:"d-flex flex-column",children:[Ce(s.reviewStatus),s.lastReviewDate&&e.jsxs("small",{className:"text-muted mt-1",children:["Last review: ",new Date(s.lastReviewDate).toLocaleDateString()]})]})}),e.jsxs("td",{className:"align-middle",children:[e.jsxs(m,{color:"primary",size:"sm",className:"me-2",onClick:()=>be(s),children:[e.jsx(a,{icon:xe,className:"me-1"}),"Review"]}),e.jsxs(m,{color:"secondary",size:"sm",onClick:()=>Re(s),children:[e.jsx(a,{icon:Te,className:"me-1"}),"History"]})]})]},s._id))})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-4",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",re+1,"-",Math.min(I,C)," of ",C," users"]}),e.jsxs(Ve,{"aria-label":"Page navigation",children:[e.jsx(U,{disabled:d===1,onClick:()=>d>1&&h(d-1),children:e.jsx(a,{icon:Be})},"prev"),Array.from({length:Z},(s,i)=>i+1).map(s=>e.jsx(U,{active:s===d,onClick:()=>h(s),children:s},s)),e.jsx(U,{disabled:d===Z,onClick:()=>d<Z&&h(d+1),children:e.jsx(a,{icon:Ue})},"next")]})]})]}):e.jsx(u,{color:"info",children:"No users match the current filter criteria"})]})]}),e.jsxs(T,{visible:fe,onClose:()=>y(!1),size:"lg",children:[e.jsx($,{children:e.jsxs(z,{children:["Access Review for ",r==null?void 0:r.name]})}),e.jsx(_,{children:r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("strong",{className:"me-2",children:"Role:"}),e.jsx(n,{color:K(r.role),children:r.role})]}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("strong",{className:"me-2",children:"Department:"}),e.jsxs("span",{children:[e.jsx(a,{icon:ee(r.department),className:"me-1"}),r.department]})]})]}),e.jsxs(O,{className:"mb-3",children:[e.jsxs(ce,{children:[e.jsx("strong",{children:"Review Permissions"}),e.jsx("div",{className:"text-muted small",children:"Uncheck permissions that should be revoked"})]}),e.jsx(B,{children:r.permissions&&r.permissions.length>0?e.jsx("div",{className:"row",children:r.permissions.map((s,i)=>e.jsx("div",{className:"col-md-6 mb-2",children:se(s,!0,r._id)},i))}):e.jsx(u,{color:"info",children:"User has no permissions to review"})})]}),e.jsx(ne,{children:e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"reviewNotes",className:"form-label",children:[e.jsx(a,{icon:$e,className:"me-1"}),"Review Notes"]}),e.jsx(Le,{id:"reviewNotes",rows:3,value:J,onChange:s=>Q(s.target.value),placeholder:"Add notes about this review (optional)"})]})})]})}),e.jsxs(W,{children:[e.jsx(m,{color:"secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsxs(m,{color:"primary",onClick:Me,children:[e.jsx(a,{icon:xe,className:"me-1"}),"Complete Review"]})]})]}),e.jsxs(T,{visible:ye,onClose:()=>H(!1),size:"lg",children:[e.jsx($,{children:e.jsxs(z,{children:["Access Review History for ",r==null?void 0:r.name]})}),e.jsx(_,{children:r&&e.jsx(e.Fragment,{children:r.reviewHistory&&r.reviewHistory.length>0?e.jsx(Fe,{children:r.reviewHistory.map((s,i)=>e.jsxs(Ze,{className:"mb-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Reviewed by:"})," ",s.reviewerName]}),e.jsxs(n,{color:"info",children:[new Date(s.date).toLocaleDateString()," at ",new Date(s.date).toLocaleTimeString()]})]}),s.notes&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]}),s.rejectedPermissions&&s.rejectedPermissions.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Revoked Permissions:"}),e.jsx("div",{className:"mt-1",children:s.rejectedPermissions.map((l,o)=>e.jsx(n,{color:"danger",className:"me-1 mb-1",children:l},o))})]})]},i))}):e.jsx(u,{color:"info",children:"No review history available for this user"})})}),e.jsx(W,{children:e.jsx(m,{color:"secondary",onClick:()=>H(!1),children:"Close"})})]}),e.jsxs(T,{visible:we,onClose:()=>w(!1),children:[e.jsx($,{children:e.jsx(z,{children:"Initiate Access Review"})}),e.jsxs(_,{children:[e.jsx("p",{children:"Select criteria for the access review. Leave blank to include all users."}),e.jsxs(ne,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"reviewDepartment",className:"form-label",children:"Department"}),e.jsxs(N,{id:"reviewDepartment",value:p,onChange:s=>X(s.target.value),children:[e.jsx("option",{value:"",children:"All Departments"}),ie.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"reviewRole",className:"form-label",children:"Role"}),e.jsxs(N,{id:"reviewRole",value:v,onChange:s=>Y(s.target.value),children:[e.jsx("option",{value:"",children:"All Roles"}),le.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsx(u,{color:"info",children:"This will mark users as requiring review and set their review status to 'Pending'."})]}),e.jsxs(W,{children:[e.jsx(m,{color:"secondary",onClick:()=>w(!1),children:"Cancel"}),e.jsx(m,{color:"primary",onClick:ke,children:"Initiate Review"})]})]})]})};export{ss as default};
