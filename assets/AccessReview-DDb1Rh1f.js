import{J as Me,j as e}from"./index-BRiklXPP.js";import{r as c}from"./vendor-react-B6URQkMn.js";import{g as E,d as Pe,W as u,o as O,$ as ce,s as l,n as m,p as B,as as te,_ as N,a1 as Ae,D as n,ac as Ve,ad as U,x as $,y as z,a8 as T,z as _,V as ne,a7 as Fe,A as W,ae as De,af as Ie,a9 as Le}from"./vendor-coreui-C9cgcUrA.js";import{l as b}from"./activityLogger-rfhpGTNf.js";import{a as oe}from"./axiosInstance-BZJzjIBE.js";import{c as Ze}from"./cil-lock-locked-DmxpJbVL.js";import{c as Ee,a as de,b as me}from"./cil-people-DOcwnkEl.js";import{c as Oe}from"./cil-clock-0brlqJOZ.js";import{c as Be,a as Ue}from"./cil-chevron-right-DSvcss7_.js";import"./vendor-redux-DipIbRRz.js";var he=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M440,464V16H72V464H16v32H496V464Zm-32,0H272V400H240v64H104V48H408Z' class='ci-primary'/><rect width='32' height='32' x='160' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='304' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='160' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='160' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='320' y='112' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/>"],xe=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M426.072,86.928A238.75,238.75,0,0,0,88.428,424.572,238.75,238.75,0,0,0,426.072,86.928ZM257.25,462.5c-114,0-206.75-92.748-206.75-206.75S143.248,49,257.25,49,464,141.748,464,255.75,371.252,462.5,257.25,462.5Z' class='ci-primary'/><polygon fill='var(--ci-primary-color, currentColor)' points='221.27 305.808 147.857 232.396 125.23 255.023 221.27 351.063 388.77 183.564 366.142 160.937 221.27 305.808' class='ci-primary'/>"],$e=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M256.25,16A240,240,0,0,0,88,84.977V16H56V144H184V112H106.287A208,208,0,0,1,256.25,48C370.8,48,464,141.2,464,255.75S370.8,463.5,256.25,463.5,48.5,370.3,48.5,255.75h-32A239.75,239.75,0,0,0,425.779,425.279,239.75,239.75,0,0,0,256.25,16Z' class='ci-primary'/><polygon fill='var(--ci-primary-color, currentColor)' points='240 111.951 239.465 288 368 288 368 256 271.563 256 272 112.049 240 111.951' class='ci-primary'/>"],ze=["512 512","<rect width='288' height='32' x='112' y='152' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='288' height='32' x='112' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='152' height='32' x='112' y='328' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M480,48H32V464H480ZM448,432H64V80H448Z' class='ci-primary'/>"],Te=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M479.6,399.716l-81.084-81.084-62.368-25.767A175.014,175.014,0,0,0,368,192c0-97.047-78.953-176-176-176S16,94.953,16,192,94.953,368,192,368a175.034,175.034,0,0,0,101.619-32.377l25.7,62.2L400.4,478.911a56,56,0,1,0,79.2-79.195ZM48,192c0-79.4,64.6-144,144-144s144,64.6,144,144S271.4,336,192,336,48,271.4,48,192ZM456.971,456.284a24.028,24.028,0,0,1-33.942,0l-76.572-76.572-23.894-57.835L380.4,345.771l76.573,76.572A24.028,24.028,0,0,1,456.971,456.284Z' class='ci-primary'/>"],je=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M473.605,88.081c-1.352-.137-135.958-14.259-199.218-68.251L269.9,16H242.1l-4.488,3.83C174.464,73.727,39.744,87.944,38.4,88.081L24,89.532V104c0,89.133,14.643,165.443,43.523,226.813,38.105,80.973,100.1,133.669,184.267,156.623l4.21,1.148,4.21-1.148c84.165-22.954,146.162-75.65,184.267-156.623C473.357,269.443,488,193.133,488,104V89.532ZM455.87,118.113q-.237,12.789-.948,25.887H272V57.915C331.921,97.482,421.024,113.237,455.87,118.113ZM272,320H414.266A288.233,288.233,0,0,1,390.9,360H272Zm0-32V248H439.9a402.662,402.662,0,0,1-13.236,42.884V288Zm0-72V176H452.378c-1.4,13.307-3.256,26.682-5.639,40ZM56.13,118.113c34.846-4.876,123.949-20.631,183.87-60.2V450.224C94.012,398.389,58.492,245.387,56.13,118.113ZM272,450.224V392h92.347C340.049,416.7,309.708,436.836,272,450.224Z' class='ci-primary'/>"];const ss=()=>{var le;const{data:t,error:R,isLoading:ue,refetch:G}=Me(),[d,h]=c.useState(1),[S,pe]=c.useState(!0),[H,ve]=c.useState(!1),[f,ge]=c.useState(null),[fe,w]=c.useState(!1),[r,q]=c.useState(null),[x,k]=c.useState([]),[J,Q]=c.useState(""),[we,M]=c.useState(!1),[ye,y]=c.useState(!1),[p,Y]=c.useState(""),[v,K]=c.useState(""),[P,g]=c.useState(null),A=10,V=localStorage.getItem("role"),F=localStorage.getItem("department");localStorage.getItem("userId");const D=localStorage.getItem("name");c.useEffect(()=>{try{const s=localStorage.getItem("currentUser");if(s){const i=JSON.parse(s);ge(i),b({name:D,role:V,department:F,route:"admin/access-review",action:"VIEW",description:"Accessed permission review page"})}}catch(s){console.error("Failed to get current user:",s)}},[]);const X=s=>{switch(s==null?void 0:s.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"user":return"info";default:return"secondary"}},ee=s=>{switch(s==null?void 0:s.toLowerCase()){case"it":return je;case"hr":return de;case"finance":return me;case"marketing":return Te;default:return he}},se=(s,i=!1,a=null)=>{let o="info";if(s.includes("delete")||s.includes("admin")?o="danger":s.includes("edit")||s.includes("create")||s.includes("write")?o="warning":(s.includes("view")||s.includes("read"))&&(o="success"),i){const Z=x.includes(s);return e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(Le,{id:`${a}-${s}`,checked:!Z,onChange:()=>Se(s),className:"me-2"}),e.jsx(n,{color:Z?"secondary":o,className:Z?"text-decoration-line-through":"",children:s})]})}return e.jsx(n,{color:o,className:"me-1 mb-1",children:s})},Ce=s=>{switch(s){case"Completed":return e.jsx(n,{color:"success",children:"Completed"});case"Pending":return e.jsx(n,{color:"warning",children:"Pending Review"});case"Overdue":return e.jsx(n,{color:"danger",children:"Overdue"});default:return e.jsx(n,{color:"secondary",children:"Not Reviewed"})}},j=((le=t==null?void 0:t.users)==null?void 0:le.filter(s=>!(S&&(!s.permissions||s.permissions.length===0)||H&&s.reviewStatus!=="Pending"||p&&s.department!==p||v&&s.role!==v)))||[],C=(j==null?void 0:j.length)||0,I=Math.ceil(C/A),L=d*A,re=L-A,Ne=(j==null?void 0:j.slice(re,L))||[],be=s=>{q(s),k([]),Q(""),w(!0),b({name:D,role:V,department:F,route:"access-review",action:"OPEN_REVIEW",description:`Opened access review for user: ${s.name}`})},Re=s=>{q(s),M(!0),b({name:D,role:V,department:F,route:"admin/access-review",action:"VIEW_HISTORY",description:`Viewed access review history for user: ${s.name}`})},Se=s=>{x.includes(s)?k(x.filter(i=>i!==s)):k([...x,s])},He=async()=>{var s,i;try{const a=await oe.post("/general/recertify",{userId:r._id,approved:r.permissions.filter(o=>!x.includes(o)),rejected:x,notes:J});g({type:"success",message:"User access has been successfully recertified!"}),w(!1),G()}catch(a){console.error("Failed to submit review:",a),g({type:"danger",message:`Error: ${((i=(s=a.response)==null?void 0:s.data)==null?void 0:i.message)||a.message}`})}},ke=async()=>{var s,i;try{const a=await oe.post("/general/initiate-review",{},{params:{department:p||void 0,role:v||void 0}});g({type:"success",message:`Access review initiated for ${a.data.usersAffected} users`}),y(!1),G()}catch(a){console.error("Failed to initiate review:",a),g({type:"danger",message:`Error: ${((i=(s=a.response)==null?void 0:s.data)==null?void 0:i.message)||a.message}`})}},ie=t!=null&&t.users?[...new Set(t.users.map(s=>s.department))].filter(Boolean):[],ae=t!=null&&t.users?[...new Set(t.users.map(s=>s.role))].filter(Boolean):[];return ue?e.jsx(E,{className:"d-flex justify-content-center align-items-center",style:{minHeight:"300px"},children:e.jsx(Pe,{color:"primary"})}):R?(f&&b({name:f.name||"Unknown User",role:f.role||"Unknown Role",department:f.department||"Unknown Department",route:"admin/access-review",action:"ERROR",description:`Error loading permissions: ${R.message}`}),e.jsx(E,{className:"mt-4",children:e.jsxs(u,{color:"danger",children:["Error: ",R.message]})})):e.jsxs(E,{className:"mt-4",children:[P&&e.jsx(u,{color:P.type,dismissible:!0,onClose:()=>g(null),children:P.message}),e.jsxs(O,{className:"mb-4 shadow-sm",children:[e.jsxs(ce,{className:"bg-primary text-white d-flex align-items-center justify-content-between",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(l,{icon:Ze,size:"xl",className:"me-2"}),e.jsx("h3",{className:"mb-0",children:"Access Control Review"})]}),e.jsxs(m,{color:"light",onClick:()=>y(!0),children:[e.jsx(l,{icon:Ee,className:"me-2"}),"Initiate Review"]})]}),e.jsxs(B,{children:[e.jsx("div",{className:"mb-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center",children:[e.jsx("div",{className:"me-4 mb-2",children:e.jsx(te,{id:"permissionFilter",label:"Show only users with permissions",checked:S,onChange:()=>{pe(!S),h(1)}})}),e.jsx("div",{className:"me-4 mb-2",children:e.jsx(te,{id:"pendingReviewFilter",label:"Show only pending reviews",checked:H,onChange:()=>{ve(!H),h(1)}})}),e.jsx("div",{className:"me-3 mb-2",children:e.jsxs(N,{id:"departmentFilter",size:"sm",value:p,onChange:s=>{Y(s.target.value),h(1)},children:[e.jsx("option",{value:"",children:"All Departments"}),ie.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx("div",{className:"mb-2",children:e.jsxs(N,{id:"roleFilter",size:"sm",value:v,onChange:s=>{K(s.target.value),h(1)},children:[e.jsx("option",{value:"",children:"All Roles"}),ae.map(s=>e.jsx("option",{value:s,children:s},s))]})})]})}),C>0?e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{hover:!0,responsive:!0,striped:!0,className:"border",children:[e.jsx("thead",{className:"bg-light",children:e.jsxs("tr",{children:[e.jsxs("th",{children:[e.jsx(l,{icon:de,className:"me-2"}),"Name"]}),e.jsxs("th",{children:[e.jsx(l,{icon:me,className:"me-2"}),"Role"]}),e.jsxs("th",{children:[e.jsx(l,{icon:he,className:"me-2"}),"Department"]}),e.jsxs("th",{children:[e.jsx(l,{icon:je,className:"me-2"}),"Permissions"]}),e.jsxs("th",{children:[e.jsx(l,{icon:Oe,className:"me-2"}),"Review Status"]}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Ne.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"align-middle font-weight-bold",children:s.name}),e.jsx("td",{className:"align-middle",children:e.jsx(n,{color:X(s.role),children:s.role})}),e.jsx("td",{className:"align-middle",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(l,{icon:ee(s.department),className:"me-2"}),s.department]})}),e.jsx("td",{children:e.jsx(O,{className:"border-0 shadow-sm",children:e.jsx(B,{className:"p-3",children:e.jsx("div",{className:"d-flex flex-wrap",children:s.permissions&&s.permissions.length>0?s.permissions.map((i,a)=>e.jsx("div",{className:"me-1 mb-1",children:se(i)},a)):e.jsx(n,{color:"secondary",className:"text-muted",children:"No permissions assigned"})})})})}),e.jsx("td",{className:"align-middle",children:e.jsxs("div",{className:"d-flex flex-column",children:[Ce(s.reviewStatus),s.lastReviewDate&&e.jsxs("small",{className:"text-muted mt-1",children:["Last review: ",new Date(s.lastReviewDate).toLocaleDateString()]})]})}),e.jsxs("td",{className:"align-middle",children:[e.jsxs(m,{color:"primary",size:"sm",className:"me-2",onClick:()=>be(s),children:[e.jsx(l,{icon:xe,className:"me-1"}),"Review"]}),e.jsxs(m,{color:"secondary",size:"sm",onClick:()=>Re(s),children:[e.jsx(l,{icon:$e,className:"me-1"}),"History"]})]})]},s._id))})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-4",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",re+1,"-",Math.min(L,C)," of ",C," users"]}),e.jsxs(Ve,{"aria-label":"Page navigation",children:[e.jsx(U,{disabled:d===1,onClick:()=>d>1&&h(d-1),children:e.jsx(l,{icon:Be})},"prev"),Array.from({length:I},(s,i)=>i+1).map(s=>e.jsx(U,{active:s===d,onClick:()=>h(s),children:s},s)),e.jsx(U,{disabled:d===I,onClick:()=>d<I&&h(d+1),children:e.jsx(l,{icon:Ue})},"next")]})]})]}):e.jsx(u,{color:"info",children:"No users match the current filter criteria"})]})]}),e.jsxs($,{visible:fe,onClose:()=>w(!1),size:"lg",children:[e.jsx(z,{children:e.jsxs(T,{children:["Access Review for ",r==null?void 0:r.name]})}),e.jsx(_,{children:r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("strong",{className:"me-2",children:"Role:"}),e.jsx(n,{color:X(r.role),children:r.role})]}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("strong",{className:"me-2",children:"Department:"}),e.jsxs("span",{children:[e.jsx(l,{icon:ee(r.department),className:"me-1"}),r.department]})]})]}),e.jsxs(O,{className:"mb-3",children:[e.jsxs(ce,{children:[e.jsx("strong",{children:"Review Permissions"}),e.jsx("div",{className:"text-muted small",children:"Uncheck permissions that should be revoked"})]}),e.jsx(B,{children:r.permissions&&r.permissions.length>0?e.jsx("div",{className:"row",children:r.permissions.map((s,i)=>e.jsx("div",{className:"col-md-6 mb-2",children:se(s,!0,r._id)},i))}):e.jsx(u,{color:"info",children:"User has no permissions to review"})})]}),e.jsx(ne,{children:e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"reviewNotes",className:"form-label",children:[e.jsx(l,{icon:ze,className:"me-1"}),"Review Notes"]}),e.jsx(Fe,{id:"reviewNotes",rows:3,value:J,onChange:s=>Q(s.target.value),placeholder:"Add notes about this review (optional)"})]})})]})}),e.jsxs(W,{children:[e.jsx(m,{color:"secondary",onClick:()=>w(!1),children:"Cancel"}),e.jsxs(m,{color:"primary",onClick:He,children:[e.jsx(l,{icon:xe,className:"me-1"}),"Complete Review"]})]})]}),e.jsxs($,{visible:we,onClose:()=>M(!1),size:"lg",children:[e.jsx(z,{children:e.jsxs(T,{children:["Access Review History for ",r==null?void 0:r.name]})}),e.jsx(_,{children:r&&e.jsx(e.Fragment,{children:r.reviewHistory&&r.reviewHistory.length>0?e.jsx(De,{children:r.reviewHistory.map((s,i)=>e.jsxs(Ie,{className:"mb-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Reviewed by:"})," ",s.reviewerName]}),e.jsxs(n,{color:"info",children:[new Date(s.date).toLocaleDateString()," at ",new Date(s.date).toLocaleTimeString()]})]}),s.notes&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]}),s.rejectedPermissions&&s.rejectedPermissions.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Revoked Permissions:"}),e.jsx("div",{className:"mt-1",children:s.rejectedPermissions.map((a,o)=>e.jsx(n,{color:"danger",className:"me-1 mb-1",children:a},o))})]})]},i))}):e.jsx(u,{color:"info",children:"No review history available for this user"})})}),e.jsx(W,{children:e.jsx(m,{color:"secondary",onClick:()=>M(!1),children:"Close"})})]}),e.jsxs($,{visible:ye,onClose:()=>y(!1),children:[e.jsx(z,{children:e.jsx(T,{children:"Initiate Access Review"})}),e.jsxs(_,{children:[e.jsx("p",{children:"Select criteria for the access review. Leave blank to include all users."}),e.jsxs(ne,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"reviewDepartment",className:"form-label",children:"Department"}),e.jsxs(N,{id:"reviewDepartment",value:p,onChange:s=>Y(s.target.value),children:[e.jsx("option",{value:"",children:"All Departments"}),ie.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"reviewRole",className:"form-label",children:"Role"}),e.jsxs(N,{id:"reviewRole",value:v,onChange:s=>K(s.target.value),children:[e.jsx("option",{value:"",children:"All Roles"}),ae.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsx(u,{color:"info",children:"This will mark users as requiring review and set their review status to 'Pending'."})]}),e.jsxs(W,{children:[e.jsx(m,{color:"secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsx(m,{color:"primary",onClick:ke,children:"Initiate Review"})]})]})]})};export{ss as default};
