import{j as e}from"./index-EtLHJ1Gn.js";import{r as o,R as ne}from"./vendor-react-B6URQkMn.js";import{a as V}from"./axiosInstance-Dv2jt_v_.js";import{F as g,M as le,E as ce,Y as ie,Z as de,_ as he}from"./index-CXm47NjJ.js";import{a9 as T,aa as F,ab as M,ac as me,s as ue,t as pe,ad as xe,v as ye,w as je,j as w,N as Y,O as _,k as ge,X as Ce,e as fe,f as we,g as Pe,h as y,l as Ne,T as Se,U as be,V as ke,C as Ie,S as ve,_ as De,$ as Te,a0 as A,a1 as d,a2 as Fe,a3 as l,y as Me,ah as _e,ai as E}from"./vendor-coreui-DGBpOIqK.js";import{l as q}from"./activityLogger-dj-FpP-1.js";import"./vendor-redux-C7peqcPR.js";import"./index-t--hEgTQ.js";const Je=()=>{const[C,P]=o.useState([]),[N,R]=o.useState(!0),[f,L]=o.useState(null),[B,z]=o.useState(""),[a,K]=o.useState({key:"id",direction:"ascending"}),[p,S]=o.useState(1),[W,b]=o.useState(null),[Ae,X]=o.useState(null),k=10,[Q,I]=o.useState(!1),[ee,se]=o.useState(""),h=localStorage.getItem("role"),m=localStorage.getItem("department"),U=localStorage.getItem("username"),O=localStorage.getItem("userId");JSON.parse(localStorage.getItem("permissions")||"[]");const x=localStorage.getItem("name");o.useEffect(()=>{Z(),re()},[]);const re=async()=>{try{O&&x&&h&&m&&await q({name:x,role:h,department:m,route:"payroll",action:"Page View",description:"User viewed the Payroll page"})}catch(s){console.warn("Error logging page view:",s)}},Z=async()=>{try{R(!0);const s=await V.get("/hr/payroll");if(s.data&&Array.isArray(s.data)){const r=h==="superadmin"?s.data:s.data.filter(t=>t.department.toLowerCase()===m.toLowerCase());P(r),b(e.jsxs(T,{autohide:!0,delay:5e3,children:[e.jsx(F,{closeButton:!0,children:e.jsx("strong",{className:"me-auto",children:"Success"})}),e.jsxs(M,{children:["Successfully loaded ",r.length," payroll records!"]})]}))}else console.warn("Unexpected API response format:",s.data),P([]),b(e.jsxs(T,{autohide:!0,delay:5e3,color:"warning",children:[e.jsx(F,{closeButton:!0,children:e.jsx("strong",{className:"me-auto",children:"Warning"})}),e.jsx(M,{children:"Received unexpected data format. Please contact support if this persists."})]}));L(null)}catch(s){L("Failed to fetch payroll data. Please try again later."),console.error("Error fetching payroll data:",s),P([]),b(e.jsxs(T,{autohide:!0,delay:5e3,color:"danger",children:[e.jsx(F,{closeButton:!0,children:e.jsx("strong",{className:"me-auto",children:"Error"})}),e.jsx(M,{children:"Failed to fetch payroll data. Please try again later."})]}))}finally{R(!1)}},H=async()=>{await Z();try{O&&x&&h&&m&&await q({name:x,role:h,department:m,route:"/hr/payroll",action:"Refresh Data",description:"User refreshed the Payroll data"})}catch(s){console.warn("Error logging refresh action:",s)}},u=async s=>{try{const r=x.substring(0,2)+h.charAt(0)+U.slice(-6);se(r);const t=await V.post("/management/downloadPayrollZip",{name:x,role:h,username:U,department:m,downloadType:s},{responseType:"blob"}),n=window.URL.createObjectURL(new Blob([t.data])),j=document.createElement("a");j.href=n,j.setAttribute("download","Payroll_Protected.zip"),document.body.appendChild(j),j.click(),document.body.removeChild(j),I(!0)}catch(r){r.response&&r.response.status===404?alert("No payroll data found for the selected department."):(console.error("Error downloading payroll ZIP:",r),alert("Failed to download payroll ZIP. Please try again."))}},c=s=>{let r="ascending";a.key===s&&a.direction==="ascending"&&(r="descending"),K({key:s,direction:r})},i=s=>a.key!==s?e.jsx(g,{icon:ie,className:"ms-1 text-gray-400"}):a.direction==="ascending"?e.jsx(g,{icon:de,className:"ms-1"}):e.jsx(g,{icon:he,className:"ms-1"}),v=ne.useMemo(()=>a.key?[...C].sort((s,r)=>{const t=s[a.key],n=r[a.key];return!isNaN(parseFloat(t))&&!isNaN(parseFloat(n))?a.direction==="ascending"?parseFloat(t)-parseFloat(n):parseFloat(n)-parseFloat(t):typeof t=="string"&&typeof n=="string"?a.direction==="ascending"?t.localeCompare(n):n.localeCompare(t):t<n?a.direction==="ascending"?-1:1:t>n?a.direction==="ascending"?1:-1:0}):C,[C,a]).filter(s=>Object.values(s).some(r=>r&&r.toString().toLowerCase().includes(B.toLowerCase()))),G=p*k,ae=G-k,J=v.slice(ae,G),D=Math.ceil(v.length/k),$=s=>s==null?"N/A":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(s),te=s=>["January","February","March","April","May","June","July","August","September","October","November","December"][s-1]||`Month ${s}`,oe=s=>{switch(s==null?void 0:s.toLowerCase()){case"approved":return"success";case"paid":return"success";case"pending":return"warning";case"rejected":return"danger";case"failed":return"danger";default:return"secondary"}};return e.jsxs("div",{className:"mb-4",children:[e.jsx(me,{ref:X,push:W,placement:"top-end"}),e.jsxs(ue,{visible:Q,onClose:()=>I(!1),children:[e.jsx(pe,{children:e.jsx(xe,{children:"Download Successful"})}),e.jsxs(ye,{children:[e.jsx("p",{children:"Your ZIP file has been downloaded successfully."}),e.jsxs("p",{children:[e.jsx("strong",{children:"Password:"})," ",ee]}),e.jsx("p",{children:"Please save this password securely to access the ZIP file."})]}),e.jsx(je,{children:e.jsx(w,{color:"primary",onClick:()=>I(!1),children:"OK"})})]}),e.jsx(Y,{children:e.jsx(_,{children:e.jsxs(ge,{className:"mb-4",children:[e.jsxs(Ce,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h4",{className:"mb-0",children:"Payroll Management"}),e.jsx("div",{children:e.jsxs(w,{color:"light",className:"me-2",onClick:H,children:[e.jsx(g,{icon:le,className:"me-1"})," Refresh"]})}),h==="superadmin"?e.jsxs(fe,{children:[e.jsx(we,{color:"primary",children:"Download Payroll"}),e.jsxs(Pe,{children:[e.jsx(y,{onClick:()=>u("all"),children:"All Payroll"}),e.jsx(y,{onClick:()=>u("logistics"),children:"Logistics Payroll"}),e.jsx(y,{onClick:()=>u("hr"),children:"HR Payroll"}),e.jsx(y,{onClick:()=>u("core"),children:"Core Payroll"}),e.jsx(y,{onClick:()=>u("finance"),children:"Finance Payroll"}),e.jsx(y,{onClick:()=>u("admin"),children:"Admin Payroll"})]})]}):e.jsxs(w,{color:"primary",onClick:()=>u(m.toLowerCase()),children:["Download ",m," Payroll"]})]}),e.jsxs(Ne,{children:[e.jsxs(Y,{className:"mb-3",children:[e.jsx(_,{md:6,children:e.jsxs(Se,{children:[e.jsx(be,{children:e.jsx(g,{icon:ce})}),e.jsx(ke,{placeholder:"Search payroll...",value:B,onChange:s=>z(s.target.value)})]})}),e.jsx(_,{md:6,className:"d-flex justify-content-end align-items-center",children:!N&&!f&&e.jsxs("small",{className:"text-medium-emphasis",children:["Showing ",v.length," of ",C.length," records"]})})]}),N&&e.jsxs("div",{className:"text-center p-5",children:[e.jsx(Ie,{color:"primary"}),e.jsx("div",{className:"mt-3",children:"Loading payroll data..."})]}),f&&e.jsxs(ve,{color:"danger",children:[f,e.jsx(w,{color:"link",className:"p-0 ms-2",onClick:H,children:"Try again"})]}),!N&&!f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs(De,{hover:!0,bordered:!0,children:[e.jsx(Te,{color:"light",children:e.jsxs(A,{children:[e.jsxs(d,{onClick:()=>c("id"),style:{cursor:"pointer"},children:["ID ",i("id")]}),e.jsxs(d,{onClick:()=>c("employee_id"),style:{cursor:"pointer"},children:["Employee ID ",i("employee_id")]}),e.jsxs(d,{onClick:()=>c("name"),style:{cursor:"pointer"},children:["Employee ",i("name")]}),e.jsxs(d,{onClick:()=>c("department"),style:{cursor:"pointer"},children:["Department ",i("department")]}),e.jsxs(d,{onClick:()=>c("job_position"),style:{cursor:"pointer"},children:["Position ",i("job_position")]}),e.jsxs(d,{onClick:()=>c("gross_salary"),style:{cursor:"pointer"},className:"text-end",children:["Gross Pay ",i("gross_salary")]}),e.jsxs(d,{onClick:()=>c("net_salary"),style:{cursor:"pointer"},className:"text-end",children:["Net Pay ",i("net_salary")]}),e.jsxs(d,{onClick:()=>c("year"),style:{cursor:"pointer"},className:"text-center",children:["Period ",i("year")]}),e.jsxs(d,{onClick:()=>c("status"),style:{cursor:"pointer"},className:"text-center",children:["Status ",i("status")]})]})}),e.jsx(Fe,{children:J.length>0?J.map((s,r)=>e.jsxs(A,{children:[e.jsx(l,{children:s.id||"—"}),e.jsx(l,{children:s.employee_id||"—"}),e.jsx(l,{children:s.name||"—"}),e.jsx(l,{children:s.department||"—"}),e.jsx(l,{children:s.job_position||"—"}),e.jsx(l,{className:"text-end",children:$(s.gross_salary)}),e.jsx(l,{className:"text-end",children:$(s.net_salary)}),e.jsx(l,{className:"text-center",children:`${te(s.month)}, ${s.year}`}),e.jsx(l,{className:"text-center",children:e.jsx(Me,{color:oe(s.status),children:s.status||"Pending"})})]},s.id||r)):e.jsx(A,{children:e.jsx(l,{colSpan:"10",className:"text-center p-4 text-medium-emphasis",children:"No payroll records found."})})})]})}),D>1&&e.jsxs(_e,{className:"mt-3 justify-content-center","aria-label":"Page navigation",children:[e.jsx(E,{disabled:p===1,onClick:()=>S(p-1),children:"Previous"}),Array.from({length:D},(s,r)=>r+1).map(s=>e.jsx(E,{active:s===p,onClick:()=>S(s),children:s},s)),e.jsx(E,{disabled:p===D,onClick:()=>S(p+1),children:"Next"})]})]})]})]})})})]})};export{Je as default};
