import{d as J,j as e,_ as V}from"./index-Creopves.js";import{r as c,i as Y,L as z}from"./vendor-react-B6URQkMn.js";import{g as W,S as C,T as y,U as X,o as Z,p as H,V as K,W as L,X as F,Y as M,s as D,Z as R,n as v,d as Q}from"./vendor-coreui-C9cgcUrA.js";import{c as ee}from"./cil-user-Ddrdy7PS.js";import{c as se}from"./cil-lock-locked-DmxpJbVL.js";import"./vendor-redux-DipIbRRz.js";const le=()=>{const[a,I]=c.useState({identifier:"",password:""}),[T,l]=c.useState(null),[j,S]=c.useState(!1),[f,k]=c.useState(0),[b,N]=c.useState(null),[A,E]=c.useState(null),[re,$]=c.useState(!1),d=Y(),[q,{isLoading:x}]=J();c.useEffect(()=>{let r=null;return j&&f>0&&(r=setInterval(()=>{k(u=>{const p=u-1;return p<=0?(clearInterval(r),S(!1),0):p})},1e3)),()=>{r&&clearInterval(r)}},[j,f]);const B=async r=>{var u,p,U,P,O;if(r.preventDefault(),l(null),E(null),!a.identifier||!a.password){l("Both username/email and password are required.");return}try{const s=await q(a).unwrap();console.log("Login Success:",s),localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("refreshToken",s.refreshToken);const{id:t,name:w,username:g,role:h,email:_,department:n}=s.user;let o=[];if(s.user.permissions)if(Array.isArray(s.user.permissions))o=s.user.permissions,console.log("✅ User permissions array:",o);else{console.warn("⚠️ Server returned permissions in unexpected format:",s.user.permissions);try{const i=typeof s.user.permissions=="string"?JSON.parse(s.user.permissions):s.user.permissions;Array.isArray(i)&&(o=i,console.log("✅ Converted permissions to array:",o))}catch(i){console.error("❌ Failed to parse permissions:",i)}}else console.warn("⚠️ No permissions found in user data");if(o.length===0&&h&&n)try{const i=await V(()=>import("./permissionConfig-Bwn9U3L8.js"),[]);(u=i.accessPermissions[h])!=null&&u[n]&&(o=i.accessPermissions[h][n],console.log("✅ Using default role-based permissions:",o))}catch(i){console.error("❌ Failed to import permissions config:",i)}switch(localStorage.setItem("userId",t),localStorage.setItem("username",g||""),localStorage.setItem("name",w||""),localStorage.setItem("email",_||""),localStorage.setItem("role",h||""),localStorage.setItem("department",n||""),localStorage.setItem("permissions",JSON.stringify(o)),console.log("📦 Local Storage after login:",{userId:t,username:g||"",name:w||"",email:_||"",role:h||"",department:n||"",permissions:o}),s.securityAlert&&E(s.securityAlert.message||"Unusual activity detected on your account."),n==null?void 0:n.toLowerCase()){case"administrative":d("/employeedash");break;case"hr":d("/hrdash");break;case"core":d("/coredash");break;case"finance":d("/financedash");break;case"logistics":d("/logisticdash");break;default:d("/dashboard")}}catch(s){if(console.error("Login Failed:",s),s.status===429){if(S(!0),(p=s.data)!=null&&p.lockedUntil){const t=new Date(s.data.lockedUntil),g=Math.ceil((t-new Date)/1e3);k(g>0?g:900),N(t)}else{k(900);const t=new Date;t.setMinutes(t.getMinutes()+15),N(t)}l(((U=s.data)==null?void 0:U.message)||"Too many failed login attempts. This account is temporarily locked."),$(!0)}else{const t=(P=s.data)==null?void 0:P.remainingAttempts;l(t!==void 0?`Invalid credentials. You have ${t} ${t===1?"attempt":"attempts"} remaining.`:((O=s.data)==null?void 0:O.message)||"Login failed. Please check your credentials and try again.")}}},G=()=>{const r=Math.floor(f/60),u=f%60;return`${r.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`},m=j&&a.identifier!=="";return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(W,{children:e.jsx(C,{className:"justify-content-center",children:e.jsx(y,{md:8,children:e.jsx(X,{children:e.jsx(Z,{className:"p-4",children:e.jsx(H,{children:e.jsxs(K,{onSubmit:B,children:[e.jsx("h1",{children:"Login"}),e.jsx("p",{className:"text-body-secondary",children:"Sign In to your account"}),A&&e.jsxs(L,{color:"warning",children:[e.jsx("strong",{children:"Security Notice:"})," ",A]}),m&&e.jsxs(L,{color:"danger",children:[e.jsx("strong",{children:"Account Temporarily Locked"}),e.jsxs("p",{children:["This account (",a.identifier,") has been temporarily locked due to too many failed login attempts. Please try again in ",G(),"."]}),b&&e.jsxs("small",{children:["Lockout expires at: ",b.toLocaleTimeString()]})]}),!m&&T&&e.jsx(L,{color:"danger",children:T}),e.jsxs(F,{className:"mb-3",children:[e.jsx(M,{children:e.jsx(D,{icon:ee})}),e.jsx(R,{type:"text",placeholder:"Email or Username",autoComplete:"email",value:a.identifier,onChange:r=>{r.target.value!==a.identifier&&(S(!1),l(null)),I({...a,identifier:r.target.value})},disabled:x,required:!0})]}),e.jsxs(F,{className:"mb-4",children:[e.jsx(M,{children:e.jsx(D,{icon:se})}),e.jsx(R,{type:"password",placeholder:"Password",autoComplete:"current-password",value:a.password,onChange:r=>I({...a,password:r.target.value}),disabled:x||m,required:!0})]}),e.jsxs(C,{children:[e.jsx(y,{xs:6,children:e.jsx(v,{type:"submit",color:"primary",className:"px-4",disabled:x||m,children:x?e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:"sm",className:"me-2"})," Logging in..."]}):m?"Account Locked":"Login"})}),e.jsx(y,{xs:6,className:"text-end",children:e.jsx(z,{to:"/forgotpass",children:e.jsx(v,{color:"link",className:"px-0",children:"Forgot password?"})})})]}),m&&e.jsx(C,{className:"mt-3",children:e.jsx(y,{xs:12,children:e.jsx(v,{type:"button",color:"secondary",className:"w-100",onClick:()=>window.location.href="/OTP",children:"Use OTP to Unlock Account"})})})]})})})})})})})})};export{le as default};
