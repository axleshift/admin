import{j as e}from"./index-B-osFWpa.js";import{r as c,i as ee}from"./vendor-react-B6URQkMn.js";import{a as f}from"./axiosInstance-BfyP_x82.js";import{l as u}from"./activityLogger-B79z5mY8.js";import{g as te,W as se,S as D,T as j,o as g,$ as C,n as S,p as b,V as re,aa as ae,Z as ce,d as x,ab as T,ac as w}from"./vendor-coreui-BDhfDOiu.js";import"./vendor-redux-DipIbRRz.js";const me=()=>{const[y,p]=c.useState(""),[B,A]=c.useState([]),[r,H]=c.useState(null),[L,k]=c.useState([]),[n,G]=c.useState(null),[_,v]=c.useState([]),[m,O]=c.useState(null),[h,i]=c.useState(!1),[F,U]=c.useState(!1),[P,a]=c.useState(""),[E,N]=c.useState(!1),z=ee(),K=sessionStorage.getItem("role"),V=sessionStorage.getItem("department");sessionStorage.getItem("userId");const M=sessionStorage.getItem("name"),l=()=>({name:M||"Unknown User",role:K||"Unknown Role",department:V||"Unknown Department"});c.useEffect(()=>{i(!0),f.get("/admin/get-directory").then(t=>{if(t.data&&t.data.directory){p(t.data.directory),N(!0),localStorage.setItem("backupDirectory",t.data.directory);const s=l();u({...s,route:"/recovery",action:"GET_SERVER_DIRECTORY",description:`Retrieved server backup directory: ${t.data.directory}`}),I()}else{const s=localStorage.getItem("backupDirectory");s&&(p(s),R(s))}}).catch(t=>{console.error("Error fetching server directory:",t);const s=localStorage.getItem("backupDirectory");s&&(p(s),R(s))}).finally(()=>i(!1))},[]),c.useEffect(()=>{E&&I()},[E]),c.useEffect(()=>{if(r){Y(r);const t=l();u({...t,route:"/recovery",action:"SELECT_BACKUP",description:`Selected backup: ${r.name}`})}else k([])},[r]),c.useEffect(()=>{if(n&&r){W(r,n);const t=l();u({...t,route:"/recovery",action:"SELECT_DATABASE",description:`Selected database: ${n} from backup: ${r.name}`})}else v([])},[n,r]);const I=async()=>{var t;i(!0),a("");try{const s=await f.get("/admin/list-backups");A(s.data.backups||[]);const d=l();u({...d,route:"/recovery",action:"FETCH_BACKUPS",description:`Retrieved ${((t=s.data.backups)==null?void 0:t.length)||0} backups from directory: ${y}`})}catch{a("Error fetching backups"),A([])}finally{i(!1)}},Y=async t=>{var s,d;if(t){i(!0),a("");try{const o=await f.get(`/admin/list-collections/${t.name}`);if(o.data.databases){k(o.data.databases);const $=l();u({...$,route:"/recovery",action:"FETCH_DATABASES",description:`Retrieved ${o.data.databases.length} databases from backup: ${t.name}`})}else k([]),a("No databases found in this backup.")}catch(o){console.error("Error fetching databases:",o),a(((d=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:d.message)||"Error fetching databases"),k([])}finally{i(!1)}}},W=async(t,s)=>{var d;if(!t||!s){v([]);return}i(!0),a("");try{const o=await f.get(`/admin/list-collections/${t.name}?databaseName=${s}`);v(o.data.collections||[]);const $=l();u({...$,route:"/recovery",action:"FETCH_COLLECTIONS",description:`Retrieved ${((d=o.data.collections)==null?void 0:d.length)||0} collections from database: ${s} in backup: ${t.name}`})}catch{a("Error fetching collections"),v([])}finally{i(!1)}},R=async(t=null)=>{const s=t||y;if(!s){a("Please enter a directory.");return}i(!0),a("");try{const d=await f.post("/admin/set-directory",{directory:s});d.data&&d.data.directory?p(d.data.directory):p(s),localStorage.setItem("backupDirectory",s),N(!0),I();const o=l();u({...o,route:"/recovery",action:"SET_DIRECTORY",description:`Set backup directory to: ${s}`})}catch{a("Error setting directory"),N(!1)}finally{i(!1)}},Z=async()=>{U(!0),a("");try{await f.post("/admin/backup"),I();const t=l();u({...t,route:"/recovery",action:"CREATE_BACKUP",description:`Created new backup in directory: ${y}`})}catch{a("Error during backup")}finally{U(!1)}},q=async()=>{if(!r||!n||!m){a("Please select a backup, database, and collection.");return}if(window.confirm(`Are you sure you want to restore collection "${m}" from database "${n}"? This will replace the current data.`)){i(!0),a("");try{await f.post("/admin/restore",{timestamp:r.name,filename:m,databaseName:n});const t=l();u({...t,route:"/recovery",action:"RESTORE_COLLECTION",description:`Restored collection: ${m} from database: ${n} in backup: ${r.name}`}),alert("Restore successful!")}catch{a("Restore failed.")}finally{i(!1)}}},J=async()=>{const t=l();u({...t,route:"/recovery",action:"NAVIGATE_TO_SCHEDULER",description:"Navigated to backup scheduler page"}),z("/cron")},Q=t=>{O(t);const s=l();u({...s,route:"/recovery",action:"SELECT_COLLECTION",description:`Selected collection: ${t} from database: ${n} in backup: ${r.name}`})},X=()=>{const t=l();u({...t,route:"/recovery",action:"CHANGE_COLLECTION",description:`Changed selection from collection: ${m}`}),O(null)};return e.jsxs(te,{children:[P&&e.jsx(se,{color:"danger",className:"mt-3",children:P}),e.jsx(D,{className:"mb-4 mt-3",children:e.jsx(j,{children:e.jsxs(g,{children:[e.jsxs(C,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Backup Configuration"}),e.jsx(S,{className:"ms-auto",color:"primary",onClick:J,children:"Schedule Backup"})]}),e.jsxs(b,{children:[e.jsxs(re,{children:[e.jsx(ae,{children:"Backup Directory"}),e.jsxs("div",{className:"d-flex",children:[e.jsx(ce,{type:"text",placeholder:"Enter directory path",value:y,onChange:t=>p(t.target.value),disabled:h}),e.jsx(S,{className:"ms-2",onClick:()=>R(),disabled:h,children:h?e.jsx(x,{size:"sm"}):"Set Directory"})]}),E&&e.jsxs("small",{className:"text-muted mt-1",children:["Using directory: ",y]})]}),e.jsx(S,{color:"primary",className:"mt-3",onClick:Z,disabled:!E||F,children:F?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm"})," Creating Backup..."]}):"Create New Backup"})]})]})})}),e.jsxs(D,{children:[e.jsx(j,{md:"4",children:e.jsxs(g,{children:[e.jsx(C,{children:"Available Backups"}),e.jsx(b,{children:h?e.jsx(x,{}):e.jsx(e.Fragment,{children:B.length===0?e.jsx("div",{className:"text-center p-3",children:"No backups available"}):e.jsx(T,{children:B.map(t=>e.jsxs(w,{active:(r==null?void 0:r.name)===t.name,onClick:()=>H(t),style:{cursor:"pointer"},children:[t.name,e.jsxs("small",{className:"d-block text-muted",children:[new Date(t.created).toLocaleString()," - ",Math.round(t.size/1024/1024),"MB"]})]},t.name))})})})]})}),e.jsx(j,{md:"4",children:e.jsxs(g,{children:[e.jsx(C,{children:"Select Database"}),e.jsx(b,{children:h?e.jsx(x,{}):e.jsx(e.Fragment,{children:r?L.length===0?e.jsx("div",{className:"text-center p-3",children:"No databases found in this backup"}):e.jsx(T,{children:L.map(t=>e.jsx(w,{active:n===t,onClick:()=>G(t),style:{cursor:"pointer"},children:t},t))}):e.jsx("div",{className:"text-center p-3",children:"Select a backup first"})})})]})}),e.jsx(j,{md:"4",children:e.jsxs(g,{children:[e.jsx(C,{children:"Select Collection"}),e.jsx(b,{children:h?e.jsx(x,{}):e.jsx(e.Fragment,{children:n?_.length===0?e.jsx("div",{className:"text-center p-3",children:"No collections found in this database"}):e.jsx(T,{children:_.map(t=>e.jsx(w,{active:m===t,onClick:()=>Q(t),style:{cursor:"pointer"},children:t},t))}):e.jsx("div",{className:"text-center p-3",children:"Select a database first"})})})]})})]}),e.jsx(D,{className:"mt-4",children:e.jsx(j,{children:e.jsxs(g,{children:[e.jsx(C,{children:"Restore Options"}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-3",children:[r&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Backup:"})," ",r.name]}),n&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Database:"})," ",n]}),m&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Collection:"})," ",m]})]}),r&&n&&m?e.jsx(S,{color:"warning",onClick:q,disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm"})," Restoring..."]}):"Restore Collection"}):e.jsx("div",{className:"text-muted",children:"Please select a backup, database, and collection to restore"}),m&&e.jsx(S,{color:"link",className:"ms-3",onClick:X,children:"Change Selection"})]})]})})})]})};export{me as default};
