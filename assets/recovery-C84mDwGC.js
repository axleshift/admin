import{j as e}from"./index-DP5FNfKy.js";import{r as o,i as de}from"./vendor-react-B6URQkMn.js";import{a as x}from"./axiosInstance-4uoCCw6P.js";import{l as m}from"./activityLogger-CP8e6OX7.js";import{g as ue,W as M,S as A,T as j,o as D,$ as R,n as v,p as T,V as me,aa as X,_ as he,X as fe,Y as pe,Z as xe,d as S,ab as _,ac as O}from"./vendor-coreui-BDhfDOiu.js";import"./vendor-redux-DipIbRRz.js";const Se=()=>{const[k,h]=o.useState(""),[F,U]=o.useState([]),[n,G]=o.useState(null),[z,E]=o.useState([]),[i,H]=o.useState(null),[W,I]=o.useState([]),[f,B]=o.useState(null),[p,l]=o.useState(!1),[K,V]=o.useState(!1),[Y,c]=o.useState(""),[$,L]=o.useState(!1),[b,Z]=o.useState({}),[g,C]=o.useState("custom"),q=de(),J=sessionStorage.getItem("role"),Q=sessionStorage.getItem("department");sessionStorage.getItem("userId");const ee=sessionStorage.getItem("name"),w={relative:"./storage/backups",absolute:"/home/backup/mongodb"},d=()=>({name:ee||"Unknown User",role:J||"Unknown Role",department:Q||"Unknown Department"});o.useEffect(()=>{l(!0),x.get("/admin/get-directory").then(t=>{if(t.data&&t.data.directory){h(t.data.directory),L(!0),localStorage.setItem("backupDirectory",t.data.directory),t.data.serverInfo&&Z(t.data.serverInfo),t.data.directory.startsWith("./")?C("relative"):t.data.directory.startsWith("/")?C("absolute"):C("custom");const s=d();m({...s,route:"/recovery",action:"GET_SERVER_DIRECTORY",description:`Retrieved server backup directory: ${t.data.directory}`}),N()}else{const s=localStorage.getItem("backupDirectory");s?(h(s),P(s)):(C("relative"),h(w.relative))}}).catch(t=>{console.error("Error fetching server directory:",t);const s=localStorage.getItem("backupDirectory");s?(h(s),P(s)):(C("relative"),h(w.relative))}).finally(()=>l(!1))},[]),o.useEffect(()=>{$&&N()},[$]),o.useEffect(()=>{if(n){te(n);const t=d();m({...t,route:"/recovery",action:"SELECT_BACKUP",description:`Selected backup: ${n.name}`})}else E([])},[n]),o.useEffect(()=>{if(i&&n){se(n,i);const t=d();m({...t,route:"/recovery",action:"SELECT_DATABASE",description:`Selected database: ${i} from backup: ${n.name}`})}else I([])},[i,n]),o.useEffect(()=>{g==="relative"?h(w.relative):g==="absolute"&&h(w.absolute)},[g]);const N=async()=>{var t,s,a;l(!0),c("");try{const r=await x.get("/admin/list-backups");U(r.data.backups||[]);const u=d();m({...u,route:"/recovery",action:"FETCH_BACKUPS",description:`Retrieved ${((t=r.data.backups)==null?void 0:t.length)||0} backups from directory: ${k}`})}catch(r){c("Error fetching backups: "+(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||r.message)),U([])}finally{l(!1)}},te=async t=>{var s,a;if(t){l(!0),c("");try{const r=await x.get(`/admin/list-collections/${t.name}`);if(r.data.databases){E(r.data.databases);const u=d();m({...u,route:"/recovery",action:"FETCH_DATABASES",description:`Retrieved ${r.data.databases.length} databases from backup: ${t.name}`})}else E([]),c("No databases found in this backup.")}catch(r){console.error("Error fetching databases:",r),c(((a=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:a.message)||"Error fetching databases"),E([])}finally{l(!1)}}},se=async(t,s)=>{var a,r,u;if(!t||!s){I([]);return}l(!0),c("");try{const y=await x.get(`/admin/list-collections/${t.name}?databaseName=${s}`);I(y.data.collections||[]);const le=d();m({...le,route:"/recovery",action:"FETCH_COLLECTIONS",description:`Retrieved ${((a=y.data.collections)==null?void 0:a.length)||0} collections from database: ${s} in backup: ${t.name}`})}catch(y){c("Error fetching collections: "+(((u=(r=y.response)==null?void 0:r.data)==null?void 0:u.message)||y.message)),I([])}finally{l(!1)}},P=async(t=null)=>{var a,r;const s=t||k;if(!s){c("Please enter a directory.");return}l(!0),c("");try{const u=await x.post("/admin/set-directory",{directory:s});u.data&&u.data.directory?h(u.data.directory):h(s),localStorage.setItem("backupDirectory",s),L(!0),N();const y=d();m({...y,route:"/recovery",action:"SET_DIRECTORY",description:`Set backup directory to: ${s}`})}catch(u){c("Error setting directory: "+(((r=(a=u.response)==null?void 0:a.data)==null?void 0:r.message)||u.message)),L(!1)}finally{l(!1)}},re=async()=>{var t,s;V(!0),c("");try{const a=await x.post("/admin/backup");N();const r=d();m({...r,route:"/recovery",action:"CREATE_BACKUP",description:`Created new backup in directory: ${k}`})}catch(a){c("Error during backup: "+(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||a.message))}finally{V(!1)}},ae=async()=>{var t,s;if(!n||!i||!f){c("Please select a backup, database, and collection.");return}if(window.confirm(`Are you sure you want to restore collection "${f}" from database "${i}"? This will replace the current data.`)){l(!0),c("");try{await x.post("/admin/restore",{timestamp:n.name,filename:f,databaseName:i});const a=d();m({...a,route:"/recovery",action:"RESTORE_COLLECTION",description:`Restored collection: ${f} from database: ${i} in backup: ${n.name}`}),alert("Restore successful!")}catch(a){c("Restore failed: "+(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||a.message))}finally{l(!1)}}},ne=async t=>{var s,a;if(window.confirm(`Are you sure you want to delete backup "${t.name}"? This action cannot be undone.`)){l(!0),c("");try{await x.delete(`/admin/delete-backup/${t.name}`),N(),(n==null?void 0:n.name)===t.name&&(G(null),E([]),I([]),H(null),B(null));const r=d();m({...r,route:"/recovery",action:"DELETE_BACKUP",description:`Deleted backup: ${t.name}`})}catch(r){c("Failed to delete backup: "+(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||r.message))}finally{l(!1)}}},oe=async()=>{const t=d();m({...t,route:"/recovery",action:"NAVIGATE_TO_SCHEDULER",description:"Navigated to backup scheduler page"}),q("/cron")},ce=t=>{B(t);const s=d();m({...s,route:"/recovery",action:"SELECT_COLLECTION",description:`Selected collection: ${t} from database: ${i} in backup: ${n.name}`})},ie=()=>{const t=d();m({...t,route:"/recovery",action:"CHANGE_COLLECTION",description:`Changed selection from collection: ${f}`}),B(null)};return e.jsxs(ue,{children:[Y&&e.jsx(M,{color:"danger",className:"mt-3",children:Y}),e.jsx(A,{className:"mb-4 mt-3",children:e.jsx(j,{children:e.jsxs(D,{children:[e.jsxs(R,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Backup Configuration"}),e.jsx(v,{className:"ms-auto",color:"primary",onClick:oe,children:"Schedule Backup"})]}),e.jsx(T,{children:e.jsxs(me,{children:[e.jsxs(A,{className:"mb-3",children:[e.jsxs(j,{md:"3",children:[e.jsx(X,{children:"Directory Type"}),e.jsxs(he,{value:g,onChange:t=>C(t.target.value),disabled:p,children:[e.jsx("option",{value:"relative",children:"Application Relative (Recommended for CyberPanel)"}),e.jsx("option",{value:"absolute",children:"Server Absolute Path"}),e.jsx("option",{value:"custom",children:"Custom Path"})]})]}),e.jsxs(j,{md:"9",children:[e.jsx(X,{children:"Backup Directory"}),e.jsxs(fe,{children:[g==="relative"&&e.jsxs(pe,{children:[b.currentWorkingDir||"app root","/"]}),e.jsx(xe,{type:"text",placeholder:g==="relative"?"./storage/backups":"/path/to/backups",value:k,onChange:t=>h(t.target.value),disabled:p||g!=="custom"}),e.jsx(v,{onClick:()=>P(),disabled:p,children:p?e.jsx(S,{size:"sm"}):"Set Directory"})]}),$&&e.jsxs("small",{className:"text-muted mt-1",children:["Using directory: ",k]})]})]}),Object.keys(b).length>0&&e.jsxs(M,{color:"info",className:"mt-3 small",children:[e.jsx("strong",{children:"Server Information:"}),e.jsx("br",{}),"Running as user: ",b.processUser,e.jsx("br",{}),"Platform: ",b.serverPlatform,e.jsx("br",{}),"Node version: ",b.nodeVersion,e.jsx("br",{}),"Working directory: ",b.currentWorkingDir]}),e.jsx(v,{color:"primary",className:"mt-3",onClick:re,disabled:!$||K,children:K?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:"sm"})," Creating Backup..."]}):"Create New Backup"})]})})]})})}),e.jsxs(A,{children:[e.jsx(j,{md:"4",children:e.jsxs(D,{children:[e.jsx(R,{children:"Available Backups"}),e.jsx(T,{children:p?e.jsx(S,{}):e.jsx(e.Fragment,{children:F.length===0?e.jsx("div",{className:"text-center p-3",children:"No backups available"}):e.jsx(_,{children:F.map(t=>e.jsxs(O,{active:(n==null?void 0:n.name)===t.name,className:"d-flex justify-content-between align-items-center",style:{cursor:"pointer"},children:[e.jsxs("div",{onClick:()=>G(t),className:"flex-grow-1",children:[t.name,e.jsxs("small",{className:"d-block text-muted",children:[new Date(t.created).toLocaleString()," - ",Math.round(t.size/1024/1024),"MB"]})]}),e.jsx(v,{color:"danger",size:"sm",onClick:s=>{s.stopPropagation(),ne(t)},disabled:p,children:"Delete"})]},t.name))})})})]})}),e.jsx(j,{md:"4",children:e.jsxs(D,{children:[e.jsx(R,{children:"Select Database"}),e.jsx(T,{children:p?e.jsx(S,{}):e.jsx(e.Fragment,{children:n?z.length===0?e.jsx("div",{className:"text-center p-3",children:"No databases found in this backup"}):e.jsx(_,{children:z.map(t=>e.jsx(O,{active:i===t,onClick:()=>H(t),style:{cursor:"pointer"},children:t},t))}):e.jsx("div",{className:"text-center p-3",children:"Select a backup first"})})})]})}),e.jsx(j,{md:"4",children:e.jsxs(D,{children:[e.jsx(R,{children:"Select Collection"}),e.jsx(T,{children:p?e.jsx(S,{}):e.jsx(e.Fragment,{children:i?W.length===0?e.jsx("div",{className:"text-center p-3",children:"No collections found in this database"}):f?e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:f}),e.jsx(v,{color:"link",onClick:ie,size:"sm",children:"Change"})]})}):e.jsx(_,{children:W.map(t=>e.jsx(O,{onClick:()=>ce(t),style:{cursor:"pointer"},children:t},t))}):e.jsx("div",{className:"text-center p-3",children:"Select a database first"})})})]})})]}),e.jsx(A,{className:"mt-4",children:e.jsx(j,{children:e.jsxs(D,{children:[e.jsx(R,{children:"Restore Options"}),e.jsxs(T,{children:[e.jsxs("div",{className:"mb-3",children:[n&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Backup:"})," ",n.name]}),i&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Database:"})," ",i]}),f&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Collection:"})," ",f]})]}),n&&i&&f?e.jsx(v,{color:"warning",onClick:ae,disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:"sm"})," Restoring..."]}):"Restore Collection"}):e.jsx("div",{className:"text-muted",children:"Please select a backup, database, and collection to restore"})]})]})})})]})};export{Se as default};
