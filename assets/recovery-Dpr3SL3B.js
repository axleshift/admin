import{j as t}from"./index-nln47cCr.js";import{r as a,i as ee}from"./vendor-react-B6URQkMn.js";import{a as f}from"./axiosInstance-Dv2jt_v_.js";import{l}from"./activityLogger-CswLieGG.js";import{c as te,S as se,N as O,O as S,k as E,a2 as b,j as C,l as k,R as re,aa as ae,V as oe,C as y,a7 as $,a8 as R}from"./vendor-coreui-vXCAeGSv.js";import"./vendor-redux-DipIbRRz.js";import"./index-t--hEgTQ.js";const fe=()=>{const[u,T]=a.useState(""),[_,D]=a.useState([]),[r,U]=a.useState(null),[P,x]=a.useState([]),[d,F]=a.useState(null),[H,j]=a.useState([]),[h,A]=a.useState(null),[p,c]=a.useState(!1),[B,L]=a.useState(!1),[w,s]=a.useState(""),[v,I]=a.useState(!1),G=ee(),K=sessionStorage.getItem("role"),z=sessionStorage.getItem("department");sessionStorage.getItem("userId");const V=sessionStorage.getItem("name"),n=()=>({name:V||"Unknown User",role:K||"Unknown Role",department:z||"Unknown Department"});a.useEffect(()=>{const e=localStorage.getItem("backupDirectory");e&&(T(e),c(!0),f.post("/admin/set-directory",{directory:e}).then(()=>{I(!0),g();const o=n();l({...o,route:"/recovery",action:"AUTO_SET_DIRECTORY",description:`Auto-loaded saved directory: ${e}`})}).catch(()=>s("Could not restore saved directory. Please set it manually.")).finally(()=>c(!1)))},[]),a.useEffect(()=>{v&&g()},[v]),a.useEffect(()=>{if(r){Y(r);const e=n();l({...e,route:"/recovery",action:"SELECT_BACKUP",description:`Selected backup: ${r.name}`})}else x([])},[r]),a.useEffect(()=>{if(d&&r){q(r,d);const e=n();l({...e,route:"/recovery",action:"SELECT_DATABASE",description:`Selected database: ${d} from backup: ${r.name}`})}else j([])},[d,r]);const g=async()=>{var e;c(!0),s("");try{const o=await f.get("/admin/list-backups");D(o.data.backups||[]);const m=n();l({...m,route:"/recovery",action:"FETCH_BACKUPS",description:`Retrieved ${((e=o.data.backups)==null?void 0:e.length)||0} backups from directory: ${u}`})}catch{s("Error fetching backups"),D([])}finally{c(!1)}},Y=async e=>{var o,m;if(e){c(!0),s("");try{const i=await f.get(`/admin/list-collections/${e.name}`);if(i.data.databases){x(i.data.databases);const N=n();l({...N,route:"/recovery",action:"FETCH_DATABASES",description:`Retrieved ${i.data.databases.length} databases from backup: ${e.name}`})}else x([]),s("No databases found in this backup.")}catch(i){console.error("Error fetching databases:",i),s(((m=(o=i==null?void 0:i.response)==null?void 0:o.data)==null?void 0:m.message)||"Error fetching databases"),x([])}finally{c(!1)}}},q=async(e,o)=>{var m;if(!e||!o){j([]);return}c(!0),s("");try{const i=await f.get(`/admin/list-collections/${e.name}?databaseName=${o}`);j(i.data.collections||[]);const N=n();l({...N,route:"/recovery",action:"FETCH_COLLECTIONS",description:`Retrieved ${((m=i.data.collections)==null?void 0:m.length)||0} collections from database: ${o} in backup: ${e.name}`})}catch{s("Error fetching collections"),j([])}finally{c(!1)}},J=async()=>{if(!u){s("Please enter a directory.");return}c(!0),s("");try{await f.post("/admin/set-directory",{directory:u}),localStorage.setItem("backupDirectory",u),I(!0),g();const e=n();l({...e,route:"/recovery",action:"SET_DIRECTORY",description:`Set backup directory to: ${u}`})}catch{s("Error setting directory"),I(!1)}finally{c(!1)}},M=async()=>{L(!0),s("");try{await f.post("/admin/backup"),g();const e=n();l({...e,route:"/recovery",action:"CREATE_BACKUP",description:`Created new backup in directory: ${u}`})}catch{s("Error during backup")}finally{L(!1)}},Q=async()=>{if(!r||!d||!h){s("Please select a backup, database, and collection.");return}c(!0),s("");try{await f.post("/admin/restore",{timestamp:r.name,filename:h,databaseName:d});const e=n();l({...e,route:"/recovery",action:"RESTORE_COLLECTION",description:`Restored collection: ${h} from database: ${d} in backup: ${r.name}`}),alert("Restore successful!")}catch{s("Restore failed.")}finally{c(!1)}},W=async()=>{const e=n();l({...e,route:"/recovery",action:"NAVIGATE_TO_SCHEDULER",description:"Navigated to backup scheduler page"}),G("/cron")},X=e=>{A(e);const o=n();l({...o,route:"/recovery",action:"SELECT_COLLECTION",description:`Selected collection: ${e} from database: ${d} in backup: ${r.name}`})},Z=()=>{const e=n();l({...e,route:"/recovery",action:"CHANGE_COLLECTION",description:`Changed selection from collection: ${h}`}),A(null)};return t.jsxs(te,{children:[w&&t.jsx(se,{color:"danger",className:"mt-3",children:w}),t.jsx(O,{className:"mb-4 mt-3",children:t.jsx(S,{children:t.jsxs(E,{children:[t.jsxs(b,{className:"d-flex justify-content-between align-items-center",children:[t.jsx("div",{children:"Backup Configuration"}),t.jsx(C,{className:"ms-auto",color:"primary",onClick:W,children:"Schedule Backup"})]}),t.jsxs(k,{children:[t.jsxs(re,{children:[t.jsx(ae,{children:"Set Backup Directory"}),t.jsxs("div",{className:"d-flex",children:[t.jsx(oe,{type:"text",placeholder:"Enter directory path",value:u,onChange:e=>T(e.target.value)}),t.jsx(C,{className:"ms-2",onClick:J,disabled:p,children:p?t.jsx(y,{size:"sm"}):"Set Directory"})]})]}),t.jsx(C,{color:"primary",className:"mt-3",onClick:M,disabled:!v||B,children:B?t.jsxs(t.Fragment,{children:[t.jsx(y,{size:"sm"})," Creating Backup..."]}):"Create New Backup"})]})]})})}),t.jsxs(O,{children:[t.jsx(S,{md:"4",children:t.jsxs(E,{children:[t.jsx(b,{children:"Available Backups"}),t.jsx(k,{children:p?t.jsx(y,{}):t.jsx($,{children:_.map(e=>t.jsx(R,{active:(r==null?void 0:r.name)===e.name,onClick:()=>U(e),style:{cursor:"pointer"},children:e.name},e.name))})})]})}),t.jsx(S,{md:"4",children:t.jsxs(E,{children:[t.jsx(b,{children:"Select Database"}),t.jsx(k,{children:p?t.jsx(y,{}):t.jsx($,{children:P.map(e=>t.jsx(R,{active:d===e,onClick:()=>F(e),style:{cursor:"pointer"},children:e},e))})})]})}),t.jsx(S,{md:"4",children:t.jsxs(E,{children:[t.jsx(b,{children:"Select Collection"}),t.jsx(k,{children:p?t.jsx(y,{}):t.jsx(t.Fragment,{children:h?t.jsxs("div",{className:"mb-3",children:[t.jsx("h5",{children:"Selected Collection:"}),t.jsx("div",{className:"p-3 bg-light border rounded",children:h}),t.jsxs("div",{className:"d-flex mt-3",children:[t.jsx(C,{color:"warning",className:"me-2",onClick:Q,children:"Restore"}),t.jsx(C,{color:"secondary",onClick:Z,children:"Change Collection"})]})]}):t.jsx($,{children:H.map(e=>t.jsx(R,{onClick:()=>X(e),style:{cursor:"pointer"},children:e},e))})})})]})})]})]})};export{fe as default};
