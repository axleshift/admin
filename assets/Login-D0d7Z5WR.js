import{d as G,j as e,_ as J}from"./index-mI93jahP.js";import{r as u,i as V,R as Y,L as z}from"./vendor-react-B6URQkMn.js";import{g as W,S as w,T as y,U as X,o as Z,p as H,V as K,W as v,X as F,Y as M,s as O,Z as D,n as L,d as Q}from"./vendor-coreui-BDhfDOiu.js";import{c as ee}from"./cil-user-Ddrdy7PS.js";import{c as se}from"./cil-lock-locked-DmxpJbVL.js";import"./vendor-redux-DipIbRRz.js";const ce=()=>{const[o,I]=u.useState({identifier:"",password:""}),[T,c]=u.useState(null),[j,S]=u.useState(!1),[f,k]=u.useState(0),[b,N]=u.useState(null),[A,E]=u.useState(null),l=V(),[$,{isLoading:x}]=G();Y.useEffect(()=>{let r=null;return j&&f>0&&(r=setInterval(()=>{k(m=>{const p=m-1;return p<=0?(clearInterval(r),S(!1),0):p})},1e3)),()=>{r&&clearInterval(r)}},[j,f]);const q=async r=>{var m,p,U,P,R;if(r.preventDefault(),c(null),E(null),!o.identifier||!o.password){c("Both username/email and password are required.");return}try{const s=await $(o).unwrap();console.log("Login Success:",s),localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("refreshToken",s.refreshToken);const{id:t,name:C,username:g,role:h,email:_,department:n}=s.user;let a=[];if(s.user.permissions)if(Array.isArray(s.user.permissions))a=s.user.permissions,console.log("✅ User permissions array:",a);else{console.warn("⚠️ Server returned permissions in unexpected format:",s.user.permissions);try{const i=typeof s.user.permissions=="string"?JSON.parse(s.user.permissions):s.user.permissions;Array.isArray(i)&&(a=i,console.log("✅ Converted permissions to array:",a))}catch(i){console.error("❌ Failed to parse permissions:",i)}}else console.warn("⚠️ No permissions found in user data");if(a.length===0&&h&&n)try{const i=await J(()=>import("./permissionConfig-DLItbach.js"),[],import.meta.url);(m=i.accessPermissions[h])!=null&&m[n]&&(a=i.accessPermissions[h][n],console.log("✅ Using default role-based permissions:",a))}catch(i){console.error("❌ Failed to import permissions config:",i)}switch(sessionStorage.setItem("userId",t),sessionStorage.setItem("username",g||""),sessionStorage.setItem("name",C||""),sessionStorage.setItem("email",_||""),sessionStorage.setItem("role",h||""),sessionStorage.setItem("department",n||""),sessionStorage.setItem("permissions",JSON.stringify(a)),console.log("📦 Session Storage after login:",{userId:t,username:g||"",name:C||"",email:_||"",role:h||"",department:n||"",permissions:a}),s.securityAlert&&E(s.securityAlert.message||"Unusual activity detected on your account."),n==null?void 0:n.toLowerCase()){case"administrative":l("/employeedash");break;case"hr":l("/hrdash");break;case"core":l("/coredash");break;case"finance":l("/financedash");break;case"logistics":l("/logisticdash");break;default:l("/dashboard")}}catch(s){if(console.error("Login Failed:",s),s.status===429){if(S(!0),(p=s.data)!=null&&p.lockedUntil){const t=new Date(s.data.lockedUntil),g=Math.ceil((t-new Date)/1e3);k(g>0?g:900),N(t)}else{k(900);const t=new Date;t.setMinutes(t.getMinutes()+15),N(t)}c(((U=s.data)==null?void 0:U.message)||"Too many failed login attempts. This account is temporarily locked."),setShowOtpOption(!0)}else{const t=(P=s.data)==null?void 0:P.remainingAttempts;c(t!==void 0?`Invalid credentials. You have ${t} ${t===1?"attempt":"attempts"} remaining.`:((R=s.data)==null?void 0:R.message)||"Login failed. Please check your credentials and try again.")}}},B=()=>{const r=Math.floor(f/60),m=f%60;return`${r.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`},d=j&&o.identifier!=="";return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(W,{children:e.jsx(w,{className:"justify-content-center",children:e.jsx(y,{md:8,children:e.jsx(X,{children:e.jsx(Z,{className:"p-4",children:e.jsx(H,{children:e.jsxs(K,{onSubmit:q,children:[e.jsx("h1",{children:"Login"}),e.jsx("p",{className:"text-body-secondary",children:"Sign In to your account"}),A&&e.jsxs(v,{color:"warning",children:[e.jsx("strong",{children:"Security Notice:"})," ",A]}),d&&e.jsxs(v,{color:"danger",children:[e.jsx("strong",{children:"Account Temporarily Locked"}),e.jsxs("p",{children:["This account (",o.identifier,") has been temporarily locked due to too many failed login attempts. Please try again in ",B(),"."]}),b&&e.jsxs("small",{children:["Lockout expires at: ",b.toLocaleTimeString()]})]}),!d&&T&&e.jsx(v,{color:"danger",children:T}),e.jsxs(F,{className:"mb-3",children:[e.jsx(M,{children:e.jsx(O,{icon:ee})}),e.jsx(D,{type:"text",placeholder:"Email or Username",autoComplete:"email",value:o.identifier,onChange:r=>{r.target.value!==o.identifier&&(S(!1),c(null)),I({...o,identifier:r.target.value})},disabled:x,required:!0})]}),e.jsxs(F,{className:"mb-4",children:[e.jsx(M,{children:e.jsx(O,{icon:se})}),e.jsx(D,{type:"password",placeholder:"Password",autoComplete:"current-password",value:o.password,onChange:r=>I({...o,password:r.target.value}),disabled:x||d,required:!0})]}),e.jsxs(w,{children:[e.jsx(y,{xs:6,children:e.jsx(L,{type:"submit",color:"primary",className:"px-4",disabled:x||d,children:x?e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:"sm",className:"me-2"})," Logging in..."]}):d?"Account Locked":"Login"})}),e.jsx(y,{xs:6,className:"text-end",children:e.jsx(z,{to:"/forgotpass",children:e.jsx(L,{color:"link",className:"px-0",children:"Forgot password?"})})})]}),d&&e.jsx(w,{className:"mt-3",children:e.jsx(y,{xs:12,children:e.jsx(L,{type:"button",color:"secondary",className:"w-100",onClick:()=>window.location.href="/OTP",children:"Use OTP to Unlock Account"})})})]})})})})})})})})};export{ce as default};
