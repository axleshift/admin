import{q as X,r as Y,s as ee,j as e,t as se,v as oe,w as re,x as ne}from"./index-Ngt4IgIB.js";import{r as c}from"./vendor-react-B6URQkMn.js";import{C as ae}from"./customhead-hUmmCiWJ.js";import{P as te}from"./papaparse.min-CPTD01QN.js";import{F as le,B as ie}from"./index-BPaG30GW.js";import{x as ce,y as de,z as me,a9 as q,A as ue,n as x,P as _,g as pe,S as H,T as D,Z as he,_ as $,o as ge,$ as ye,p as xe,ae as fe,af as p}from"./vendor-coreui-C9cgcUrA.js";import{l}from"./activityLogger-D0TolUUb.js";import"./vendor-redux-DipIbRRz.js";import"./axiosInstance-CKhgb2PG.js";const O=({visible:f,onClose:C,userId:h})=>{const[j,F]=c.useState([]),d=localStorage.getItem("name"),R=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:m,isLoading:E,error:v}=X(h),U=Array.isArray(m==null?void 0:m.permissions)?m.permissions:Array.isArray(m)?m:[],[k]=Y(),[M]=ee(),g=r=>{r.stopPropagation()},S=r=>{F(P=>P.includes(r)?P.filter(B=>B!==r):[...P,r])},I=async()=>{if(!h){console.error("❌ Error: userId is null before making the API request.");return}try{await k({userId:h,newPermissions:j,grantedBy:d}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),C()}catch(r){console.error("❌ Error granting access:",r),alert("Failed to grant access.")}},T=async()=>{if(!h){console.error("❌ Error: userId is null before making the API request.");return}try{await M({userId:h,permissionsToRemove:j}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),C()}catch(r){console.error("❌ Error revoking access:",r),alert("Failed to revoke access.")}};return E?e.jsx("div",{children:"Loading permissions..."}):v?e.jsxs("div",{children:["Error loading permissions: ",v.toString()]}):e.jsxs(ce,{visible:f,onClose:C,onClick:g,children:[e.jsx(de,{onClick:g,children:"Manage Access Permission"}),e.jsxs(me,{onClick:g,children:[e.jsx("h5",{children:"Grant Access"}),R.map(r=>e.jsx(q,{label:r.name,checked:j.includes(r.to),onChange:()=>S(r.to)},r.to)),e.jsx("h5",{children:"Revoke Access"}),U.map(r=>e.jsx(q,{label:r,checked:j.includes(r),onChange:()=>S(r)},r))]}),e.jsxs(ue,{onClick:g,children:[e.jsx(x,{color:"secondary",onClick:C,children:"Cancel"}),e.jsx(x,{color:"primary",onClick:I,children:"Grant Access"}),e.jsx(x,{color:"danger",onClick:T,children:"Revoke Access"})]})]})};O.propTypes={visible:_.bool.isRequired,onClose:_.func.isRequired,userId:_.string.isRequired};const De=()=>{const{data:f,isLoading:C,error:h}=se(),[j]=oe(),[F]=re(),[d,R]=c.useState(null),[m,E]=c.useState(""),[v,U]=c.useState({}),[k,M]=c.useState("all"),[g,S]=c.useState("all"),[I,T]=c.useState(!1),[r,P]=c.useState({userId:null,userName:null,newRole:null}),[B,Ce]=c.useState({userId:null,userName:null}),[V,N]=c.useState(!1),[G,z]=c.useState(!1),[Q]=ne(),a=localStorage.getItem("role"),t=localStorage.getItem("department"),i=localStorage.getItem("name"),b=a==="superadmin"&&t==="Administrative";if(c.useEffect(()=>{d&&(console.log("🟢 Opening Modal with userId:",d),N(!0))},[d]),c.useEffect(()=>{l({name:i,role:a,department:t,route:"/employees",action:"Page Visit",description:"User visited the Employees page"})},[]),C)return e.jsx("div",{children:"Loading..."});if(h)return e.jsxs("div",{children:["Error: ",h.message]});const W=async s=>{const o=v[s]||"";if(!o){alert("Please select a role before updating.");return}try{await j({userId:s,newRole:o}),alert("Role updated successfully!");const n=f.find(w=>w._id===s),u=n?n.name:"Unknown User";l({name:u,role:a,department:t,route:"/employees",action:"Role Change",description:`Changed role for ${(n==null?void 0:n.name)||"Unknown User"} to ${o}`})}catch{alert("Error updating role"),l({name:i,role:a,department:t,route:"/employees",action:"Role Change Failed",description:`Failed to change role for user ID: ${s}`})}},Z=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{const o=f.find(u=>u._id===s),n=o?o.name:"Unknown User";await F({userId:s}),alert("User deleted successfully!"),l({name:i,role:a,department:t,route:"/employees",action:"Delete User",description:`Deleted user: ${n}`})}catch{alert("Error deleting user"),l({name:i,role:a,department:t,route:"/employees",action:"Delete User Failed",description:`Failed to delete user ID: ${s}`})}},J=()=>{const s=["Username","Name","Email","Phone Number","Country","Occupation","Role","Department"],o=L.map(y=>[y.username,y.name,y.email,y.phoneNumber,y.country,y.occupation,y.role,y.department]),n=te.unparse([s,...o]),u=new Blob([n],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(u),A=document.createElement("a");A.href=w,A.download="All_Employees.csv",A.click(),URL.revokeObjectURL(w),l({name:i,role:a,department:t,route:"/employees",action:"Download Data",description:`Downloaded employee data (${L.length} records)`})},L=f.filter(s=>{const o=s.username||"",n=s.email||"",u=o.toLowerCase().includes(m.toLowerCase())||n.toLowerCase().includes(m.toLowerCase()),w=k==="all"||s.department===k,A=g==="all"||s.role===g;return u&&w&&A}),K=async s=>{try{const o=f.find(u=>u._id===s);if(!o||!o.email){alert("User email not found");return}const n=await Q(o.email).unwrap();alert(n.message||"Reset password link sent successfully"),l({name:i,role:a,department:t,route:"/employees",action:"Password Reset",description:`Sent password reset link to ${o.name} (${o.email})`})}catch(o){console.error("Error resetting password:",o),alert(o.message||"Failed to send reset password link"),l({name:i,role:a,department:t,route:"/employees",action:"Password Reset Failed",description:`Failed to send password reset link to user ID: ${s}`})}};return e.jsx(pe,{m:"1.5rem 2.5rem",children:e.jsxs(H,{children:[e.jsx(ae,{title:"Employees",subtitle:"List of Employees"}),e.jsx(D,{xs:"12",className:"mb-3",children:e.jsx(he,{placeholder:"Search by Username or Email",value:m,onChange:s=>{E(s.target.value),s.target.value&&s.target.value.length>=3&&l({name:i,role:a,department:t,route:"/employees",action:"Search",description:`User searched for: "${s.target.value}"`})}})}),e.jsxs(H,{className:"mb-3",children:[e.jsx(D,{xs:"4",children:e.jsxs($,{value:k,onChange:s=>{M(s.target.value),s.target.value!=="all"&&l({name:i,role:a,department:t,route:"/employees",action:"Filter",description:`Filtered employees by department: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(D,{xs:"4",children:e.jsxs($,{value:g,onChange:s=>{S(s.target.value),s.target.value!=="all"&&l({name:i,role:a,department:t,route:"/employees",action:"Filter",description:`Filtered employees by role: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(D,{xs:"4",className:"d-flex justify-content-end",children:e.jsx("div",{className:"d-flex align-items-center",children:b&&e.jsxs(x,{color:"info",onClick:J,size:"sm",className:"me-2",children:[e.jsx(le,{icon:ie})," Download All"]})})})]}),L.map(s=>e.jsxs(ge,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),d!==s._id&&l({name:i,role:a,department:t,route:"/employees",action:"View Employee",description:`Viewed details for employee: ${s.name}`}),R(n=>n===s._id?null:s._id),z(!1))},children:[e.jsxs(ye,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),b&&e.jsx(x,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),l({name:i,role:a,department:t,route:"/employees",action:"Access Management",description:`Opened access management for: ${s.name}`}),R(s._id),z(!0),setTimeout(()=>{N(!0)},100)},children:"Access"})]}),d&&G&&b&&e.jsx(O,{visible:V,onClose:()=>{N(!1),l({name:i,role:a,department:t,route:"/employees",action:"Close Access Management",description:`Closed access management modal for employee ID: ${d}`})},userId:d}),d===s._id&&!G&&e.jsx(xe,{children:e.jsxs(fe,{children:[e.jsxs(p,{children:["Email: ",s.email]}),e.jsxs(p,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(p,{children:["Country: ",s.country]}),e.jsxs(p,{children:["Occupation: ",s.occupation]}),e.jsxs(p,{children:["Role: ",s.role]}),e.jsxs(p,{children:["Department: ",s.department]}),b&&e.jsxs(e.Fragment,{children:[e.jsx(p,{children:e.jsxs($,{value:v[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>{const n=o.target.value;U({...v,[s._id]:n}),n&&l({name:i,role:a,department:t,route:"/employees",action:"Select Role",description:`Selected role ${n} for ${s.name}`})},children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(p,{children:[e.jsx(x,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),W(s._id)},children:"Change Role"}),e.jsx(x,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),Z(s._id)},children:"Fire User"})]}),e.jsx(p,{children:e.jsx(x,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),K(s._id)},children:"Send link to reset password"})})]})]})})]},s._id))]})})};export{De as default};
