import{j as e}from"./index-DM1yPWM8.js";import{r as d}from"./vendor-react-B6URQkMn.js";import{a as I}from"./axiosInstance-Dv2jt_v_.js";import{l as x}from"./activityLogger-dj-FpP-1.js";import{F as t,G as g,ao as re,t as P,ap as ce,aq as oe,J as de,ar as me,as as he,f as xe,a6 as F,at as U,T as pe,v as T,au as ue,av as je,al as ge,aw as fe,ax as be,ay as we,a1 as Ne,L as ye,K as Ce}from"./index-qDEKtGai.js";import{j as p,C as $,S as k,k as L,X as B,e as z,f as O,g as H,h as o,N as ve,O as ke,l as Ve,as as De,aj as _e,s as Ae,t as Me,ac as Se,v as Ee,w as Re,y as Ie}from"./vendor-coreui-B7GHRQOS.js";import"./vendor-redux-C7peqcPR.js";import"./index-t--hEgTQ.js";const Oe=()=>{const[n,Y]=d.useState([]),[N,V]=d.useState(!0),[f,D]=d.useState(null),[b,_]=d.useState(null),[A,M]=d.useState(!1),[Z,q]=d.useState(""),[G,J]=d.useState(""),[K,y]=d.useState(!1),c=localStorage.getItem("role"),m=localStorage.getItem("department"),r=localStorage.getItem("name"),S=localStorage.getItem("username");localStorage.getItem("userId"),d.useEffect(()=>{(async()=>{try{V(!0);const s=await I.get("/logistics/vehicle");s.data.success&&s.data.data.success?(Y(s.data.data.data),x({name:r,role:c,department:m,route:"/vehicles",action:"View Vehicles",description:`${r} viewed vehicle fleet data`}).catch(console.warn)):D("Failed to fetch vehicle data")}catch(s){D(s.message||"An error occurred while fetching vehicle data"),console.error("Error fetching vehicles:",s)}finally{V(!1)}})()},[r,c,m]);const u=async a=>{try{M(!0);let s="";switch(a){case"all":s="All_Vehicles";break;case"available":s="Available_Vehicles";break;case"in_use":s="InUse_Vehicles";break;case"maintenance":s="Maintenance_Vehicles";break;case"forRegistration":s="ForRegistration_Vehicles";break;default:s="Vehicles"}const i=await I.post("/management/downloadVehicleZip",{name:r,role:c,username:S,downloadType:a},{responseType:"blob"}),E=r.substring(0,2)+c.charAt(0)+S.slice(-6);q(E),J(`${s}_Protected.zip`),y(!0);const w=window.URL.createObjectURL(new Blob([i.data])),h=document.createElement("a");h.href=w,h.setAttribute("download",`${s}_Protected.zip`),document.body.appendChild(h),h.click(),document.body.removeChild(h),x({name:r,role:c,department:m,route:"/vehicles",action:"Download Protected Data",description:`Downloaded ${s} as password-protected zip`}).catch(console.warn)}catch(s){console.error("Error creating protected zip:",s),alert("Failed to create protected download. Please try again.")}finally{M(!1)}},j=a=>{let s=[],i="";switch(a){case"all":s=n.filter(l=>!l.deleted),i="All_Vehicles";break;case"available":s=n.filter(l=>!l.deleted&&l.status==="available"),i="Available_Vehicles";break;case"in_use":s=n.filter(l=>!l.deleted&&l.status==="in_use"),i="InUse_Vehicles";break;case"maintenance":s=n.filter(l=>!l.deleted&&l.status==="maintenance"),i="Maintenance_Vehicles";break;case"forRegistration":s=n.filter(l=>!l.deleted&&l.status==="forRegistration"),i="ForRegistration_Vehicles";break;default:s=n.filter(l=>!l.deleted),i="Vehicles"}let w=["Registration Number","Brand","Model","Year","Type","Capacity","Fuel Type","Current Mileage","Driver","Status","Registration Expiry"].join(",")+`
`;s.forEach(l=>{const ne=[l.regisNumber||"",l.brand||"",l.model||"",l.year||"",l.type||"",l.capacity||"",l.fuelType||"",l.currentMileage||"",l.driver||"Not Assigned",l.status||"",l.regisExprationDate?new Date(l.regisExprationDate).toLocaleDateString():"N/A"].map(ie=>`"${String(ie).replace(/"/g,'""')}"`);w+=ne.join(",")+`
`});const h=new Blob([w],{type:"text/csv;charset=utf-8;"}),R=URL.createObjectURL(h),v=document.createElement("a");v.href=R,v.download=`${i}.csv`,v.click(),URL.revokeObjectURL(R),x({name:r,role:c,department:m,route:"/vehicles",action:"Download CSV",description:`Downloaded ${i} data as CSV (${s.length} records)`}).catch(console.warn)},W=()=>{window.print(),x({name:r,role:c,department:m,route:"/vehicles",action:"Print Vehicle List",description:`Printed vehicle fleet list (${n.filter(a=>!a.deleted).length} vehicles)`}).catch(console.warn)},X=()=>{x({name:r,role:c,department:m,route:"/vehicles",action:"Add Vehicle Initiated",description:"User initiated adding a new vehicle"}).catch(console.warn)},C=(a,s)=>{const i={view:`Viewed details for vehicle ${s.regisNumber||s._id}`,edit:`Initiated editing vehicle ${s.regisNumber||s._id}`,delete:`Initiated deletion of vehicle ${s.regisNumber||s._id}`};x({name:r,role:c,department:m,route:"/vehicles",action:`Vehicle ${a.charAt(0).toUpperCase()+a.slice(1)}`,description:i[a]}).catch(console.warn)},Q=a=>{if(b===a)_(null);else{_(a);const s=n.find(i=>i._id===a);s&&x({name:r,role:c,department:m,route:"/vehicles",action:"View Vehicle Details",description:`${r} Expanded details for vehicle ${s.regisNumber||a}`}).catch(console.warn)}},ee=a=>a?new Date(a).toLocaleDateString():"N/A",se=a=>({available:"success",in_use:"primary",forRegistration:"warning",maintenance:"danger"})[a]||"secondary",ae=a=>({available:ye,in_use:T,forRegistration:Ne,maintenance:we})[a]||Ce,le=a=>e.jsxs(Ie,{color:se(a),children:[e.jsx(t,{icon:ae(a),className:"me-1"}),a.replace("_"," ").replace(/\b\w/g,s=>s.toUpperCase())]}),te=[{key:"idNum",label:"ID",icon:pe},{key:"brand",label:"Brand",icon:U},{key:"model",label:"Model",icon:g},{key:"year",label:"Year",icon:F},{key:"type",label:"Type",icon:g},{key:"capacity",label:"Capacity (kg)",icon:T},{key:"fuelType",label:"Fuel Type",icon:ue},{key:"currentMileage",label:"Mileage (km)",icon:je}];return e.jsxs("div",{className:"container-fluid p-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsxs("h1",{children:[e.jsx(t,{icon:g,className:"me-3 text-primary"}),"Vehicle Fleet Management"]}),e.jsxs(p,{color:"primary",onClick:X,children:[e.jsx(t,{icon:re,className:"me-2"}),"Add Vehicle"]})]}),N&&e.jsx("div",{className:"d-flex justify-content-center py-5",children:e.jsx($,{color:"primary"})}),f&&e.jsxs(k,{color:"danger",className:"mb-4",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:f})]}),!N&&!f&&n&&n.length===0&&e.jsx(k,{color:"warning",className:"mb-4",children:e.jsx("p",{children:"No vehicle data available."})}),!N&&!f&&n&&n.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"shadow mb-4",children:e.jsx(B,{className:"bg-light",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("span",{className:"fw-bold",children:[e.jsx(t,{icon:g,className:"me-2 text-primary"}),"Total Vehicles: ",n.filter(a=>!a.deleted).length]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(z,{children:[e.jsxs(O,{color:"success",disabled:A,children:[e.jsx(t,{icon:P,className:"me-2"}),"Secure Download",A&&e.jsx($,{size:"sm",className:"ms-2"})]}),e.jsxs(H,{children:[e.jsx(o,{onClick:()=>u("all"),children:"All Vehicles"}),e.jsx(o,{onClick:()=>u("available"),children:"Available Vehicles"}),e.jsx(o,{onClick:()=>u("in_use"),children:"In-Use Vehicles"}),e.jsx(o,{onClick:()=>u("maintenance"),children:"Maintenance Vehicles"}),e.jsx(o,{onClick:()=>u("forRegistration"),children:"For Registration Vehicles"})]})]}),e.jsxs(z,{children:[e.jsxs(O,{color:"light",children:[e.jsx(t,{icon:ce,className:"me-2 text-success"}),"Export CSV"]}),e.jsxs(H,{children:[e.jsx(o,{onClick:()=>j("all"),children:"All Vehicles"}),e.jsx(o,{onClick:()=>j("available"),children:"Available Vehicles"}),e.jsx(o,{onClick:()=>j("in_use"),children:"In-Use Vehicles"}),e.jsx(o,{onClick:()=>j("maintenance"),children:"Maintenance Vehicles"}),e.jsx(o,{onClick:()=>j("forRegistration"),children:"For Registration Vehicles"})]})]}),e.jsxs(p,{color:"light",size:"sm",onClick:W,children:[e.jsx(t,{icon:oe,className:"me-2 text-primary"}),"Print List"]})]})]})})}),e.jsx(ve,{children:n.filter(a=>!a.deleted).map(a=>e.jsx(ke,{sm:12,className:"mb-4",children:e.jsx(L,{className:"shadow-sm border-top-0 border-left-0 border-right-0 border-bottom border-primary",style:{cursor:"pointer",borderWidth:"3px"},children:e.jsxs("div",{className:"d-flex flex-row",children:[e.jsx("div",{className:"bg-light d-flex align-items-center justify-content-center",style:{width:"120px",minHeight:"100%"},children:e.jsx(t,{icon:g,size:"3x",className:"text-primary"})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs(B,{className:"d-flex justify-content-between align-items-center bg-white border-0",children:[e.jsx("div",{children:e.jsxs("h5",{className:"mb-0",children:[e.jsx(t,{icon:de,className:"me-2 text-primary"}),a.regisNumber||"No Registration"]})}),e.jsxs("div",{className:"d-flex align-items-center",children:[le(a.status||"unknown"),e.jsx(p,{color:"link",className:"p-0 ms-3",onClick:()=>Q(a._id),children:e.jsx(t,{icon:b===a._id?me:he,size:"lg"})})]})]}),e.jsxs(Ve,{className:"py-2",children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"me-3",children:[e.jsx("div",{className:"text-muted small mb-1",children:"Driver"}),e.jsxs("div",{children:[e.jsx(t,{icon:xe,className:"me-2 text-info"}),e.jsx("strong",{children:a.driver||"Not Assigned"})]})]}),e.jsxs("div",{className:"me-3",children:[e.jsx("div",{className:"text-muted small mb-1",children:"Registration Expiry"}),e.jsxs("div",{children:[e.jsx(t,{icon:F,className:"me-2 text-warning"}),e.jsx("strong",{children:ee(a.regisExprationDate)})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted small mb-1",children:"Brand & Model"}),e.jsxs("div",{children:[e.jsx(t,{icon:U,className:"me-2 text-secondary"}),e.jsx("strong",{children:(a.brand||"")+" "+(a.model||"")})]})]})]}),e.jsxs(De,{visible:b===a._id,children:[e.jsx("hr",{className:"my-3"}),e.jsx("div",{className:"row",children:te.filter(s=>!["regisNumber","driver","regisExprationDate","status","brand","model"].includes(s.key)).map(s=>e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("div",{className:"text-muted small mb-1",children:s.label}),e.jsxs("div",{children:[s.icon&&e.jsx(t,{icon:s.icon,className:"me-2 text-primary"}),e.jsx("strong",{children:a[s.key]||"N/A"})]})]},s.key))})]})]}),b===a._id&&e.jsxs(_e,{className:"bg-white d-flex justify-content-end gap-2 py-2",children:[e.jsxs(p,{color:"info",size:"sm",onClick:()=>C("view",a),children:[e.jsx(t,{icon:ge,className:"me-1"})," View"]}),e.jsxs(p,{color:"success",size:"sm",onClick:()=>C("edit",a),children:[e.jsx(t,{icon:fe,className:"me-1"})," Edit"]}),e.jsxs(p,{color:"danger",size:"sm",onClick:()=>C("delete",a),children:[e.jsx(t,{icon:be,className:"me-1"})," Delete"]})]})]})]})})},a._id))})]}),e.jsxs(Ae,{visible:K,onClose:()=>y(!1),children:[e.jsx(Me,{closeButton:!0,children:e.jsx(Se,{children:"Password Protected File"})}),e.jsxs(Ee,{children:[e.jsxs("p",{children:["Your file ",e.jsx("strong",{children:G})," has been downloaded successfully."]}),e.jsx("p",{children:"Use the following password to unlock the ZIP file:"}),e.jsxs(k,{color:"info",className:"d-flex align-items-center",children:[e.jsx(t,{icon:P,className:"me-3 fs-4"}),e.jsx("div",{className:"font-monospace fw-bold",children:Z})]}),e.jsx("p",{className:"text-muted small",children:"This password is unique to your account. Please keep it secure."})]}),e.jsx(Re,{children:e.jsx(p,{color:"secondary",onClick:()=>y(!1),children:"Close"})})]})]})};export{Oe as default};
