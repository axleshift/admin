import{r as t,D as se,E as oe,F as re,j as e,P as L,G as ne,H as ae,I as te,J as le,K as ce,M as ie,N as de,O as ue,Q as me}from"./index-BizKBI6a.js";import{C as he}from"./customhead-t2LJNxRX.js";import{E as pe}from"./exceljs.min-BPnPlXgj.js";import{C as xe,p as ge,q as Ce,r as ye,F as ke,t as fe}from"./DefaultLayout-CnpPbvhY.js";import{C as B}from"./CFormCheck-ChI44iH8.js";import{a as i,C as je}from"./CFormInput-BYAzJEzi.js";import{C as we,a as H,b}from"./index.esm-LX8wyrY9.js";import{C as N}from"./CFormSelect-BBQbi0Yz.js";import{C as ve,a as Ae}from"./CCardBody-cs6hLwSm.js";import{C as Re}from"./CCardHeader-CPTDb0Yp.js";import{C as be,a as c}from"./CListGroupItem-KEqkBqgX.js";import"./CCardTitle-DUMIo4Tm.js";import"./chatbox-V5kNCwUM.js";import"./cil-magnifying-glass-COgjSVTM.js";import"./CCloseButton-CGgGdGd-.js";import"./index-D8rVyQy1.js";const z=({visible:x,onClose:g,userId:m})=>{const[C,E]=t.useState([]),P=sessionStorage.getItem("name"),h=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:d,isLoading:w,error:A}=se(m),v=Array.isArray(d==null?void 0:d.permissions)?d.permissions:Array.isArray(d)?d:[],[S]=oe(),[u]=re(),y=r=>{r.stopPropagation()},k=r=>{E(R=>R.includes(r)?R.filter(D=>D!==r):[...R,r])},M=async()=>{if(!m){console.error("❌ Error: userId is null before making the API request.");return}try{await S({userId:m,newPermissions:C,grantedBy:P}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),g()}catch(r){console.error("❌ Error granting access:",r),alert("Failed to grant access.")}},U=async()=>{if(!m){console.error("❌ Error: userId is null before making the API request.");return}try{await u({userId:m,permissionsToRemove:C}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),g()}catch(r){console.error("❌ Error revoking access:",r),alert("Failed to revoke access.")}};return w?e.jsx("div",{children:"Loading permissions..."}):A?e.jsxs("div",{children:["Error loading permissions: ",A.toString()]}):e.jsxs(xe,{visible:x,onClose:g,onClick:y,children:[e.jsx(ge,{onClick:y,children:"Manage Access Permission"}),e.jsxs(Ce,{onClick:y,children:[e.jsx("h5",{children:"Grant Access"}),h.map(r=>e.jsx(B,{label:r.name,checked:C.includes(r.to),onChange:()=>k(r.to)},r.to)),e.jsx("h5",{children:"Revoke Access"}),v.map(r=>e.jsx(B,{label:r,checked:C.includes(r),onChange:()=>k(r)},r))]}),e.jsxs(ye,{onClick:y,children:[e.jsx(i,{color:"secondary",onClick:g,children:"Cancel"}),e.jsx(i,{color:"primary",onClick:M,children:"Grant Access"}),e.jsx(i,{color:"danger",onClick:U,children:"Revoke Access"})]})]})};z.propTypes={visible:L.bool.isRequired,onClose:L.func.isRequired,userId:L.string.isRequired};const Je=()=>{const{data:x,isLoading:g,error:m}=ne(),[C]=ae(),[E]=te(),[P]=le(),[h,d]=t.useState(null),[w,A]=t.useState(""),[v,S]=t.useState({}),[u,y]=t.useState("all"),[k,M]=t.useState("all"),[U,r]=t.useState(null),[R,D]=t.useState(!1),[Ee,Pe]=t.useState({userId:null,userName:null,newRole:null}),[Se,Me]=t.useState({userId:null,userName:null}),[O,T]=t.useState(!1),[_,G]=t.useState(!1),[q]=ce(),[W]=ie(),[Q]=de(),[J]=ue(),[K]=me();if(t.useEffect(()=>{h&&(console.log("🟢 Opening Modal with userId:",h),T(!0))},[h]),g)return e.jsx("div",{children:"Loading..."});if(m)return e.jsxs("div",{children:["Error: ",m.message]});const $=async s=>{const o=v[s]||"";if(!o){alert("Please select a role before updating.");return}try{await C({userId:s,newRole:o}),alert("Role updated successfully!");const n=x.find(p=>p._id===s),l=n?n.name:"Unknown User"}catch{alert("Error updating role")}},V=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{await E({userId:s}),alert("User deleted successfully!");const o=x.find(l=>l._id===s),n=o?o.name:"Unknown User"}catch{alert("Error deleting user")}},X=async()=>{const s=new pe.Workbook,o=s.addWorksheet("All Employees");o.columns=[{header:"Username",key:"username",width:30},{header:"Name",key:"name",width:30},{header:"Email",key:"email",width:30},{header:"Phone Number",key:"phoneNumber",width:20},{header:"Country",key:"country",width:20},{header:"Occupation",key:"occupation",width:20},{header:"Role",key:"role",width:20},{header:"Department",key:"department",width:20}],F.forEach(a=>{o.addRow({username:a.username,name:a.name,email:a.email,phoneNumber:a.phoneNumber,country:a.country,occupation:a.occupation,role:a.role,department:a.department})});const n=await s.xlsx.writeBuffer(),l=new Blob([n],{type:"application/octet-stream"}),p=URL.createObjectURL(l),f=document.createElement("a");f.href=p,f.download="All_Employees.xlsx",f.click(),URL.revokeObjectURL(p),D(!0)},F=x.filter(s=>{const o=s.username||"",n=s.email||"",l=o.toLowerCase().includes(w.toLowerCase())||n.toLowerCase().includes(w.toLowerCase()),p=u==="all"||s.department===u,f=k==="all"||s.role===k;return l&&p&&f}),I=async(s,o)=>{try{const n=await P(s).unwrap(),{token:l,message:p}=n;r(l),alert(p);const a={...x.find(ee=>ee._id===s),oauthToken:l,department:o.toUpperCase()};let j;switch(o.toLowerCase()){case"hr":j=await W({payload:a}).unwrap();break;case"finance":j=await Q({payload:a}).unwrap();break;case"core":j=await J({payload:a}).unwrap();break;case"logistics":j=await K({payload:a}).unwrap();break;default:throw new Error("Invalid department")}console.log(`Response from ${o}:`,j),alert(j.message)}catch(n){console.error("Error during generation and sending:",n),alert("Failed to generate token or send data.")}},Y=()=>{if(u==="all"){alert("Please select a department to generate token.");return}F.filter(o=>o.department===u).forEach(o=>{I(o._id,u)})},Z=async s=>{try{const o=x.find(l=>l._id===s);if(!o||!o.email){alert("User email not found");return}const n=await q(o.email).unwrap();alert(n.message||"Reset password link sent successfully")}catch(o){console.error("Error resetting password:",o),alert(o.message||"Failed to send reset password link")}};return e.jsx(we,{m:"1.5rem 2.5rem",children:e.jsxs(H,{children:[e.jsx(he,{title:"Employees",subtitle:"List of Employees"}),e.jsx(b,{xs:"12",className:"mb-3",children:e.jsx(je,{placeholder:"Search by Username or Email",value:w,onChange:s=>A(s.target.value)})}),e.jsxs(H,{className:"mb-3",children:[e.jsx(b,{xs:"4",children:e.jsxs(N,{value:u,onChange:s=>y(s.target.value),size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(b,{xs:"4",children:e.jsxs(N,{value:k,onChange:s=>M(s.target.value),size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(b,{xs:"4",className:"d-flex justify-content-end",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs(i,{color:"info",onClick:X,size:"sm",className:"me-2",children:[e.jsx(ke,{icon:fe})," Download All"]}),e.jsxs(i,{color:"success",onClick:Y,size:"sm",children:["Send to ",u," Department"]})]})})]}),F.map(s=>e.jsxs(ve,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),d(n=>n===s._id?null:s._id),G(!1))},children:[e.jsxs(Re,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),e.jsx(i,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),d(s._id),G(!0),setTimeout(()=>{T(!0)},100)},children:"Access"})]}),h&&_&&e.jsx(z,{visible:O,onClose:()=>T(!1),userId:h}),h===s._id&&!_&&e.jsx(Ae,{children:e.jsxs(be,{children:[e.jsxs(c,{children:["Email: ",s.email]}),e.jsxs(c,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(c,{children:["Country: ",s.country]}),e.jsxs(c,{children:["Occupation: ",s.occupation]}),e.jsxs(c,{children:["Role: ",s.role]}),e.jsxs(c,{children:["Department: ",s.department]}),e.jsx(c,{children:e.jsxs(N,{value:v[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>S({...v,[s._id]:o.target.value}),children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(c,{children:[e.jsx(i,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),$(s._id)},children:"Change Role"}),e.jsx(i,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),V(s._id)},children:"Fire User"})]}),e.jsx(c,{children:s.department!=="Administrative"&&e.jsxs(i,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),I(s._id,s.department)},children:["Send to ",s.department]})}),e.jsx(c,{children:e.jsx(i,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),Z(s._id)},children:"Send link to reset password"})})]})})]},s._id))]})})};export{Je as default};
