import{r as l,u as B,a as G,R as z,j as e,C as J,L as Y}from"./index-BizKBI6a.js";import{C as H,a as C,b as h,c as U,d as E,e as M}from"./index.esm-LX8wyrY9.js";import{C as K}from"./CCardGroup-vzqjpc4x.js";import{C as Q,a as V}from"./CCardBody-cs6hLwSm.js";import{C as W}from"./CForm-tPETyldd.js";import{C as y}from"./CAlert-CUEFZV7O.js";import{c as X}from"./cil-user-Ddrdy7PS.js";import{C as R,a as k}from"./CFormInput-BYAzJEzi.js";import{c as Z}from"./cil-lock-locked-DmxpJbVL.js";import"./CCloseButton-CGgGdGd-.js";const le=()=>{const[r,S]=l.useState({identifier:"",password:""}),[w,n]=l.useState(null),[x,f]=l.useState(!1),[m,j]=l.useState(0),[L,b]=l.useState(null),[v,I]=l.useState(null),o=B(),[D,{isLoading:u}]=G();z.useEffect(()=>{let t=null;return x&&m>0&&(t=setInterval(()=>{j(c=>{const d=c-1;return d<=0?(clearInterval(t),f(!1),0):d})},1e3)),()=>{t&&clearInterval(t)}},[x,m]);const F=async t=>{var c,d,T,N;if(t.preventDefault(),n(null),I(null),!r.identifier||!r.password){n("Both username/email and password are required.");return}try{const s=await D(r).unwrap();console.log("Login Success:",s),localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("refreshToken",s.refreshToken);const{id:a,name:A,username:p,role:P,email:$,department:g,permissions:q}=s.user;switch(sessionStorage.setItem("userId",a),sessionStorage.setItem("username",p||""),sessionStorage.setItem("name",A||""),sessionStorage.setItem("email",$||""),sessionStorage.setItem("role",P||""),sessionStorage.setItem("department",g||""),sessionStorage.setItem("permissions",JSON.stringify(q||[])),s.securityAlert&&I(s.securityAlert.message||"Unusual activity detected on your account."),g==null?void 0:g.toLowerCase()){case"administrative":o("/employeedash");break;case"hr":o("/hrdash");break;case"core":o("/coredash");break;case"finance":o("/financedash");break;case"logistics":o("/logisticdash");break;default:o("/dashboard")}}catch(s){if(console.error("Login Failed:",s),s.status===429){if(f(!0),(c=s.data)!=null&&c.lockedUntil){const a=new Date(s.data.lockedUntil),p=Math.ceil((a-new Date)/1e3);j(p>0?p:900),b(a)}else{j(900);const a=new Date;a.setMinutes(a.getMinutes()+15),b(a)}n(((d=s.data)==null?void 0:d.message)||"Too many failed login attempts. This account is temporarily locked."),setShowOtpOption(!0)}else{const a=(T=s.data)==null?void 0:T.remainingAttempts;n(a!==void 0?`Invalid credentials. You have ${a} ${a===1?"attempt":"attempts"} remaining.`:((N=s.data)==null?void 0:N.message)||"Login failed. Please check your credentials and try again.")}}},O=()=>{const t=Math.floor(m/60),c=m%60;return`${t.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`},i=x&&r.identifier!=="";return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(H,{children:e.jsx(C,{className:"justify-content-center",children:e.jsx(h,{md:8,children:e.jsx(K,{children:e.jsx(Q,{className:"p-4",children:e.jsx(V,{children:e.jsxs(W,{onSubmit:F,children:[e.jsx("h1",{children:"Login"}),e.jsx("p",{className:"text-body-secondary",children:"Sign In to your account"}),v&&e.jsxs(y,{color:"warning",children:[e.jsx("strong",{children:"Security Notice:"})," ",v]}),i&&e.jsxs(y,{color:"danger",children:[e.jsx("strong",{children:"Account Temporarily Locked"}),e.jsxs("p",{children:["This account (",r.identifier,") has been temporarily locked due to too many failed login attempts. Please try again in ",O(),"."]}),L&&e.jsxs("small",{children:["Lockout expires at: ",L.toLocaleTimeString()]})]}),!i&&w&&e.jsx(y,{color:"danger",children:w}),e.jsxs(U,{className:"mb-3",children:[e.jsx(E,{children:e.jsx(M,{icon:X})}),e.jsx(R,{type:"text",placeholder:"Email or Username",autoComplete:"email",value:r.identifier,onChange:t=>{t.target.value!==r.identifier&&(f(!1),n(null)),S({...r,identifier:t.target.value})},disabled:u,required:!0})]}),e.jsxs(U,{className:"mb-4",children:[e.jsx(E,{children:e.jsx(M,{icon:Z})}),e.jsx(R,{type:"password",placeholder:"Password",autoComplete:"current-password",value:r.password,onChange:t=>S({...r,password:t.target.value}),disabled:u||i,required:!0})]}),e.jsxs(C,{children:[e.jsx(h,{xs:6,children:e.jsx(k,{type:"submit",color:"primary",className:"px-4",disabled:u||i,children:u?e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"sm",className:"me-2"})," Logging in..."]}):i?"Account Locked":"Login"})}),e.jsx(h,{xs:6,className:"text-end",children:e.jsx(Y,{to:"/forgotpass",children:e.jsx(k,{color:"link",className:"px-0",children:"Forgot password?"})})})]}),i&&e.jsx(C,{className:"mt-3",children:e.jsx(h,{xs:12,children:e.jsx(k,{type:"button",color:"secondary",className:"w-100",onClick:()=>window.location.href="/OTP",children:"Use OTP to Unlock Account"})})})]})})})})})})})})};export{le as default};
