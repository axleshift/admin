import{r,_ as ue,E as me,R as t,J as X,B as _,D as U,ah as Z,P as u,j as e,c as x,a as B,ai as he,aj as pe,ak as fe,al as ke,am as ge,an as xe,ao as Ce,ap as be,b as ye,F as ve,s as je,S as W,e as we,f as Ee}from"./index-CKcFKU7h.js";import{C as Re}from"./customhead-DMsH-ZQR.js";import{E as Ae}from"./exceljs.min-CEW4BVYH.js";import{b as Fe,c as Pe,d as Se,e as Ne}from"./DefaultLayout-Xwng9yPx.js";import{C as De}from"./index.esm-DAwbp2WG.js";import{C as Y}from"./CRow-6GBEGtvd.js";import{C as I}from"./CCol-Bfnlt4mm.js";import{C as J}from"./CFormSelect-BKkxLTOG.js";import{C as Te}from"./CCardHeader-BJVPw31J.js";import{C as Le,a as g}from"./CListGroupItem-CUarwIc_.js";import"./CCardTitle-DlzJVczk.js";import"./CCardText-BWRHRdk1.js";import"./ex-CELXs5B0.js";var O=r.forwardRef(function(n,b){var d=n.className,c=n.button,S=n.feedback,N=n.feedbackInvalid,f=n.feedbackValid,R=n.floatingLabel,j=n.tooltipFeedback,C=n.hitArea,h=n.id,w=n.indeterminate,k=n.inline,a=n.invalid,l=n.label,D=n.reverse,H=n.type,V=H===void 0?"checkbox":H,T=n.valid,G=ue(n,["className","button","feedback","feedbackInvalid","feedbackValid","floatingLabel","tooltipFeedback","hitArea","id","indeterminate","inline","invalid","label","reverse","type","valid"]),y=r.useRef(null),$=me(b,y);r.useEffect(function(){y.current&&w&&(y.current.indeterminate=w)},[w,y.current]);var E=function(){return t.createElement("input",_({type:V,className:U(c?"btn-check":"form-check-input",{"is-invalid":a,"is-valid":T,"me-2":C}),id:h},G,{ref:$}))},L=function(){return t.createElement(Z,{describedby:G["aria-describedby"],feedback:S,feedbackInvalid:N,feedbackValid:f,floatingLabel:R,invalid:a,tooltipFeedback:j,valid:T})},z=function(){var A;return t.createElement(X,_({customClassName:U(c?U("btn",c.variant?"btn-".concat(c.variant,"-").concat(c.color):"btn-".concat(c.color),(A={},A["btn-".concat(c.size)]=c.size,A),"".concat(c.shape)):"form-check-label")},h&&{htmlFor:h}),l)},M=function(){return c?t.createElement(t.Fragment,null,t.createElement(E,null),l&&t.createElement(z,null),t.createElement(L,null)):l?C?t.createElement(t.Fragment,null,t.createElement(E,null),t.createElement(X,_({customClassName:U("form-check-label stretched-link",d)},h&&{htmlFor:h}),l),t.createElement(L,null)):t.createElement("div",{className:U("form-check",{"form-check-inline":k,"form-check-reverse":D,"is-invalid":a,"is-valid":T},d)},t.createElement(E,null),t.createElement(z,null),t.createElement(L,null)):t.createElement(E,null)};return t.createElement(M,null)});O.propTypes=_({button:u.object,className:u.string,hitArea:u.oneOf(["full"]),id:u.string,indeterminate:u.bool,inline:u.bool,label:u.oneOfType([u.string,u.node]),reverse:u.bool,type:u.oneOf(["checkbox","radio"])},Z.propTypes);O.displayName="CFormCheck";const ee=({visible:n,onClose:b,userId:d})=>{const[c,S]=r.useState([]),[N,f]=r.useState([]),R=sessionStorage.getItem("name"),j=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}];r.useEffect(()=>{(async()=>{if(d)try{const l=await B.get(`http://localhost:5053/hr/user/permissions/${d}`);f(l.data.permissions||[])}catch(l){console.error("Error fetching permissions:",l)}})()},[d]),r.useEffect(()=>{console.log("GrantAccessModal received userId:",d)},[d]);const C=a=>{a.stopPropagation()},h=a=>{S(l=>l.includes(a)?l.filter(D=>D!==a):[...l,a])},w=async()=>{if(!d){console.error("❌ Error: userId is null before making the API request.");return}try{const a=await B.post("http://localhost:5053/hr/user/grant-access",{userId:d,newPermissions:c,grantedBy:R});console.log("✅ Access granted:",a.data),alert("Permissions granted successfully"),b()}catch(a){console.error("❌ Error granting access:",a),alert("Failed to grant access.")}},k=async()=>{if(!d){console.error("❌ Error: userId is null before making the API request.");return}try{const a=await B.post("http://localhost:5053/hr/user/revoke-access",{userId:d,permissionsToRemove:c});console.log("✅ Access revoked:",a.data),alert("Permissions revoked successfully");const l=await B.get(`http://localhost:5053/hr/user/permissions/${d}`);f(l.data.permissions||[]),b()}catch(a){console.error("❌ Error revoking access:",a),alert("Failed to revoke access.")}};return e.jsxs(Fe,{visible:n,onClose:b,onClick:C,children:[e.jsx(Pe,{onClick:C,children:"Manage Access Permission"}),e.jsxs(Se,{onClick:C,children:[e.jsx("h5",{children:"Grant Access"}),j.map(a=>e.jsx(O,{label:a.name,checked:c.includes(a.to),onChange:()=>h(a.to)},a.to)),e.jsx("h5",{children:"Revoke Access"}),N.map(a=>e.jsx(O,{label:a,checked:c.includes(a),onChange:()=>h(a)},a))]}),e.jsxs(Ne,{onClick:C,children:[e.jsx(x,{color:"secondary",onClick:b,children:"Cancel"}),e.jsx(x,{color:"primary",onClick:w,children:"Grant Access"}),e.jsx(x,{color:"danger",onClick:k,children:"Revoke Access"})]})]})};ee.propTypes={visible:u.bool.isRequired,onClose:u.func.isRequired,userId:u.string.isRequired};const Je=()=>{const{data:n,isLoading:b,error:d}=he(),[c]=pe(),[S]=fe(),[N]=ke(),[f,R]=r.useState(null),[j,C]=r.useState(""),[h,w]=r.useState({}),[k,a]=r.useState("all"),[l,D]=r.useState("all"),[H,V]=r.useState(null),[T,G]=r.useState(!1),[y,$]=r.useState({userId:null,userName:null,newRole:null}),[E,L]=r.useState({userId:null,userName:null}),[z,M]=r.useState(!1),[A,Q]=r.useState(!1),[se]=ge(),[oe]=xe(),[ae]=Ce(),[ne]=be();if(r.useEffect(()=>{f&&(console.log("🟢 Opening Modal with userId:",f),M(!0))},[f]),b)return e.jsx("div",{children:"Loading..."});if(d)return e.jsxs("div",{children:["Error: ",d.message]});const te=async s=>{const o=h[s]||"";if(!o){alert("Please select a role before updating.");return}try{await c({userId:s,newRole:o}),alert("Role updated successfully!");const i=n.find(v=>v._id===s),p=i?i.name:"Unknown User";$({userId:s,userName:p,newRole:o})}catch{alert("Error updating role")}},re=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{await S({userId:s}),alert("User deleted successfully!");const o=n.find(p=>p._id===s),i=o?o.name:"Unknown User";L({userId:s,userName:i})}catch{alert("Error deleting user")}},le=async()=>{const s=new Ae.Workbook,o=s.addWorksheet("All Employees");o.columns=[{header:"Username",key:"username",width:30},{header:"Name",key:"name",width:30},{header:"Email",key:"email",width:30},{header:"Phone Number",key:"phoneNumber",width:20},{header:"Country",key:"country",width:20},{header:"Occupation",key:"occupation",width:20},{header:"Role",key:"role",width:20},{header:"Department",key:"department",width:20}],q.forEach(m=>{o.addRow({username:m.username,name:m.name,email:m.email,phoneNumber:m.phoneNumber,country:m.country,occupation:m.occupation,role:m.role,department:m.department})});const i=await s.xlsx.writeBuffer(),p=new Blob([i],{type:"application/octet-stream"}),v=URL.createObjectURL(p),F=document.createElement("a");F.href=v,F.download="All_Employees.xlsx",F.click(),URL.revokeObjectURL(v),G(!0)},q=n.filter(s=>{const o=s.username||"",i=s.email||"",p=o.toLowerCase().includes(j.toLowerCase())||i.toLowerCase().includes(j.toLowerCase()),v=k==="all"||s.department===k,F=l==="all"||s.role===l;return p&&v&&F}),K=async(s,o)=>{try{const i=await N(s).unwrap(),{token:p,message:v}=i;V(p),alert(v);const m={...n.find(de=>de._id===s),oauthToken:p,department:o.toUpperCase()};let P;switch(o.toLowerCase()){case"hr":P=await se({payload:m}).unwrap();break;case"finance":P=await oe({payload:m}).unwrap();break;case"core":P=await ae({payload:m}).unwrap();break;case"logistics":P=await ne({payload:m}).unwrap();break;default:throw new Error("Invalid department")}console.log(`Response from ${o}:`,P),alert(P.message)}catch(i){console.error("Error during generation and sending:",i),alert("Failed to generate token or send data.")}},ce=()=>{if(k==="all"){alert("Please select a department to generate token.");return}q.filter(o=>o.department===k).forEach(o=>{K(o._id,k)})},ie=async s=>{try{const o=n.find(p=>p._id===s),i=await B.post("http://localhost:5053/general/forgot-password",{email:o.email});alert(i.data.message)}catch(o){console.error("Error resetting password:",o),alert("Failed to send reset password link.")}};return e.jsx(De,{m:"1.5rem 2.5rem",children:e.jsxs(Y,{children:[e.jsx(Re,{title:"Employees",subtitle:"List of Employees"}),e.jsx(I,{xs:"12",className:"mb-3",children:e.jsx(ye,{placeholder:"Search by Username or Email",value:j,onChange:s=>C(s.target.value)})}),e.jsxs(Y,{className:"mb-3",children:[e.jsx(I,{xs:"4",children:e.jsxs(J,{value:k,onChange:s=>a(s.target.value),size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(I,{xs:"4",children:e.jsxs(J,{value:l,onChange:s=>D(s.target.value),size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(I,{xs:"4",className:"d-flex justify-content-end",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs(x,{color:"info",onClick:le,size:"sm",className:"me-2",children:[e.jsx(ve,{icon:je})," Download All"]}),e.jsxs(x,{color:"success",onClick:ce,size:"sm",children:["Send to ",k," Department"]})]})})]}),T&&e.jsx(W,{action:"Download All",description:"User downloaded all employee data as an Excel file"}),y.userId&&e.jsx(W,{action:"Change Role",description:`Changed role for user ${y.userName} to ${y.newRole}`}),E.userId&&e.jsx(W,{action:"Delete User",description:`Deleted user ${E.userName}`}),q.map(s=>e.jsxs(we,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),R(i=>i===s._id?null:s._id),Q(!1))},children:[e.jsxs(Te,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),e.jsx(x,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),R(s._id),Q(!0),setTimeout(()=>{M(!0)},100)},children:"Access"})]}),f&&A&&e.jsx(ee,{visible:z,onClose:()=>M(!1),userId:f}),f===s._id&&!A&&e.jsx(Ee,{children:e.jsxs(Le,{children:[e.jsxs(g,{children:["Email: ",s.email]}),e.jsxs(g,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(g,{children:["Country: ",s.country]}),e.jsxs(g,{children:["Occupation: ",s.occupation]}),e.jsxs(g,{children:["Role: ",s.role]}),e.jsxs(g,{children:["Department: ",s.department]}),e.jsx(g,{children:e.jsxs(J,{value:h[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>w({...h,[s._id]:o.target.value}),children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(g,{children:[e.jsx(x,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),te(s._id)},children:"Change Role"}),e.jsx(x,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),re(s._id)},children:"Fire User"})]}),e.jsx(g,{children:s.department!=="Administrative"&&e.jsxs(x,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),K(s._id,s.department)},children:["Send to ",s.department]})}),e.jsx(g,{children:e.jsx(x,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),ie(s._id)},children:"Send link to reset password"})})]})})]},s._id))]})})};export{Je as default};
