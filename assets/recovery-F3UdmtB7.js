import{j as e}from"./index-CqTYrJit.js";import{r as a,u as _}from"./vendor-react-BHxUanFt.js";import{a as m}from"./axiosInstance-Bq-uIJjs.js";import{l as u}from"./activityLogger-D6Lc4RsL.js";import{C as z,g as M,a as k,b as h,d as x,n as p,l as o,e as j,m as f,E as R,F as I}from"./vendor-coreui-CLDxaGvm.js";import"./vendor-redux-CSji-Y9p.js";import"./index-xsH4HHeE.js";const W=()=>{const[y,N]=a.useState([]),[t,b]=a.useState(null),[S,C]=a.useState([]),[c,g]=a.useState(null),[i,r]=a.useState(!1),[v,B]=a.useState(!1),[E,n]=a.useState(""),A=_(),L=localStorage.getItem("name"),d=()=>({name:L||"Unknown User"});a.useEffect(()=>{w()},[]),a.useEffect(()=>{if(t){P(t);const s=d();u({...s,route:"/recovery",action:"SELECT_BACKUP",description:`Selected backup: ${t.name}`})}else C([])},[t]);const w=async()=>{r(!0),n("");try{const s=await m.get("/admin/list-backups");N(s.data.backups||[])}catch{n("Error fetching backups"),N([])}finally{r(!1)}},P=async s=>{if(s){r(!0),n("");try{const l=await m.get(`/admin/list-collections/${s.name}`);C(l.data.collections||[])}catch{n("Error fetching collections"),C([])}finally{r(!1)}}},T=async()=>{B(!0),n("");try{await m.post("/admin/backup"),w();const s=d();u({...s,route:"/recovery",action:"CREATE_BACKUP",description:"Created new backup"})}catch{n("Error during backup")}finally{B(!1)}},U=async()=>{var s;if(!t||!c){n("Please select a backup and collection.");return}if(window.confirm(`Are you sure you want to restore collection "${c}"? This will replace the current data.`)){r(!0),n("");try{await m.post("/admin/restore",{timestamp:t.name,filename:`${c}.bson`,databaseName:"adminis"});const O=d();u({...O,route:"/recovery",action:"RESTORE_COLLECTION",description:`Restored collection: ${c} from backup: ${t.name}`}),alert("Restore successful!")}catch(l){console.error("Restore error:",((s=l.response)==null?void 0:s.data)||l.message),n("Restore failed. Please check the console for details.")}finally{r(!1)}}},$=async()=>{const s=d();u({...s,route:"/recovery",action:"NAVIGATE_TO_SCHEDULER",description:"Navigated to backup scheduler page"}),A("/cron")},D=()=>{b(null),g(null)},F=()=>{g(null)};return e.jsxs(z,{children:[E&&e.jsx(M,{color:"danger",className:"mt-3",children:E}),e.jsx(k,{className:"mb-4 mt-3",children:e.jsx(h,{children:e.jsxs(x,{children:[e.jsxs(p,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Backup Configuration"}),e.jsx(o,{className:"ms-auto",color:"primary",onClick:$,children:"Schedule Backup"})]}),e.jsx(j,{children:e.jsx(o,{color:"primary",className:"mt-3",onClick:T,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(f,{size:"sm"})," Creating Backup..."]}):"Create New Backup"})})]})})}),e.jsxs(k,{children:[e.jsx(h,{md:"6",children:e.jsxs(x,{children:[e.jsxs(p,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Available Backups"}),t&&e.jsx(o,{color:"link",className:"p-0",onClick:D,children:"Select Different"})]}),e.jsx(j,{children:i&&!t?e.jsx(f,{}):e.jsx(e.Fragment,{children:t?e.jsxs("div",{className:"p-3",children:[e.jsx("h5",{children:t.name}),e.jsxs("small",{className:"d-block text-muted",children:[new Date(t.created).toLocaleString()," - ",Math.round(t.size/1024/1024),"MB"]})]}):y.length===0?e.jsx("div",{className:"text-center p-3",children:"No backups available"}):e.jsx(R,{children:y.map(s=>e.jsxs(I,{onClick:()=>b(s),style:{cursor:"pointer"},children:[s.name,e.jsxs("small",{className:"d-block text-muted",children:[new Date(s.created).toLocaleString()," - ",Math.round(s.size/1024/1024),"MB"]})]},s.name))})})})]})}),e.jsx(h,{md:"6",children:e.jsxs(x,{children:[e.jsxs(p,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Select Collection"}),c&&e.jsx(o,{color:"link",className:"p-0",onClick:F,children:"Select Different"})]}),e.jsx(j,{children:i&&t&&!c?e.jsx(f,{}):e.jsx(e.Fragment,{children:t?c?e.jsx("div",{className:"p-3",children:e.jsx("h5",{children:c})}):S.length===0?e.jsx("div",{className:"text-center p-3",children:"No collections found in this backup"}):e.jsx(R,{children:S.map(s=>e.jsx(I,{onClick:()=>g(s),style:{cursor:"pointer"},children:s},s))}):e.jsx("div",{className:"text-center p-3",children:"Select a backup first"})})})]})})]}),e.jsx(k,{className:"mt-4",children:e.jsx(h,{children:e.jsxs(x,{children:[e.jsx(p,{children:"Restore Options"}),e.jsxs(j,{children:[e.jsxs("div",{className:"mb-3",children:[t&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Backup:"})," ",t.name]}),c&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Collection:"})," ",c]})]}),t&&c?e.jsx(o,{color:"warning",onClick:U,disabled:i,children:i?e.jsxs(e.Fragment,{children:[e.jsx(f,{size:"sm"})," Restoring..."]}):"Restore Collection"}):e.jsx("div",{className:"text-muted",children:"Please select a backup and collection to restore"})]})]})})})]})};export{W as default};
