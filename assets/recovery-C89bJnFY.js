import{j as e}from"./index-DGlCYBmm.js";import{r as n,i as J}from"./vendor-react-B6URQkMn.js";import{a as x}from"./axiosInstance-Dv2jt_v_.js";import{l as d}from"./activityLogger-dj-FpP-1.js";import{c as Q,S as W,N as v,O as p,k as f,X as j,j as y,l as C,C as g,a7 as E,a8 as N}from"./vendor-coreui-DDUzhqJ9.js";import"./vendor-redux-C7peqcPR.js";import"./index-t--hEgTQ.js";const oe=()=>{const[Y,Z]=n.useState(""),[I,$]=n.useState([]),[t,O]=n.useState(null),[w,b]=n.useState([]),[a,_]=n.useState(null),[R,S]=n.useState([]),[l,B]=n.useState(null),[h,u]=n.useState(!1),[A,T]=n.useState(!1),[L,r]=n.useState(""),U=J(),F=localStorage.getItem("role"),P=localStorage.getItem("department");localStorage.getItem("userId");const H=localStorage.getItem("name"),i=()=>({name:H||"Unknown User",role:F||"Unknown Role",department:P||"Unknown Department"});n.useEffect(()=>{D()},[]),n.useEffect(()=>{if(t){z(t);const s=i();d({...s,route:"/recovery",action:"SELECT_BACKUP",description:`Selected backup: ${t.name}`})}else b([])},[t]),n.useEffect(()=>{if(a&&t){G(t,a);const s=i();d({...s,route:"/recovery",action:"SELECT_DATABASE",description:`Selected database: ${a} from backup: ${t.name}`})}else S([])},[a,t]);const D=async()=>{var s;u(!0),r("");try{const c=await x.get("/admin/list-backups");$(c.data.backups||[]);const m=i();d({...m,route:"/recovery",action:"FETCH_BACKUPS",description:`Retrieved ${((s=c.data.backups)==null?void 0:s.length)||0} backups`})}catch{r("Error fetching backups"),$([])}finally{u(!1)}},z=async s=>{var c,m;if(s){u(!0),r("");try{const o=await x.get(`/admin/list-collections/${s.name}`);if(o.data.databases){b(o.data.databases);const k=i();d({...k,route:"/recovery",action:"FETCH_DATABASES",description:`Retrieved ${o.data.databases.length} databases from backup: ${s.name}`})}else b([]),r("No databases found in this backup.")}catch(o){console.error("Error fetching databases:",o),r(((m=(c=o==null?void 0:o.response)==null?void 0:c.data)==null?void 0:m.message)||"Error fetching databases"),b([])}finally{u(!1)}}},G=async(s,c)=>{var m;if(!s||!c){S([]);return}u(!0),r("");try{const o=await x.get(`/admin/list-collections/${s.name}?databaseName=${c}`);S(o.data.collections||[]);const k=i();d({...k,route:"/recovery",action:"FETCH_COLLECTIONS",description:`Retrieved ${((m=o.data.collections)==null?void 0:m.length)||0} collections from database: ${c} in backup: ${s.name}`})}catch{r("Error fetching collections"),S([])}finally{u(!1)}},K=async()=>{T(!0),r("");try{await x.post("/admin/backup"),D();const s=i();d({...s,route:"/recovery",action:"CREATE_BACKUP",description:"Created new backup"})}catch{r("Error during backup")}finally{T(!1)}},M=async()=>{if(!t||!a||!l){r("Please select a backup, database, and collection.");return}if(window.confirm(`Are you sure you want to restore collection "${l}" from database "${a}"? This will replace the current data.`)){u(!0),r("");try{await x.post("/admin/restore",{timestamp:t.name,filename:l,databaseName:a});const s=i();d({...s,route:"/recovery",action:"RESTORE_COLLECTION",description:`Restored collection: ${l} from database: ${a} in backup: ${t.name}`}),alert("Restore successful!")}catch{r("Restore failed.")}finally{u(!1)}}},V=async()=>{const s=i();d({...s,route:"/recovery",action:"NAVIGATE_TO_SCHEDULER",description:"Navigated to backup scheduler page"}),U("/cron")},X=s=>{B(s);const c=i();d({...c,route:"/recovery",action:"SELECT_COLLECTION",description:`Selected collection: ${s} from database: ${a} in backup: ${t.name}`})},q=()=>{const s=i();d({...s,route:"/recovery",action:"CHANGE_COLLECTION",description:`Changed selection from collection: ${l}`}),B(null)};return e.jsxs(Q,{children:[L&&e.jsx(W,{color:"danger",className:"mt-3",children:L}),e.jsx(v,{className:"mb-4 mt-3",children:e.jsx(p,{children:e.jsxs(f,{children:[e.jsxs(j,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{children:"Backup Configuration"}),e.jsx(y,{className:"ms-auto",color:"primary",onClick:V,children:"Schedule Backup"})]}),e.jsx(C,{children:e.jsx(y,{color:"primary",className:"mt-3",onClick:K,disabled:A,children:A?e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"sm"})," Creating Backup..."]}):"Create New Backup"})})]})})}),e.jsxs(v,{children:[e.jsx(p,{md:"4",children:e.jsxs(f,{children:[e.jsx(j,{children:"Available Backups"}),e.jsx(C,{children:h?e.jsx(g,{}):e.jsx(e.Fragment,{children:I.length===0?e.jsx("div",{className:"text-center p-3",children:"No backups available"}):e.jsx(E,{children:I.map(s=>e.jsxs(N,{active:(t==null?void 0:t.name)===s.name,onClick:()=>O(s),style:{cursor:"pointer"},children:[s.name,e.jsxs("small",{className:"d-block text-muted",children:[new Date(s.created).toLocaleString()," - ",Math.round(s.size/1024/1024),"MB"]})]},s.name))})})})]})}),e.jsx(p,{md:"4",children:e.jsxs(f,{children:[e.jsx(j,{children:"Select Database"}),e.jsx(C,{children:h?e.jsx(g,{}):e.jsx(e.Fragment,{children:t?w.length===0?e.jsx("div",{className:"text-center p-3",children:"No databases found in this backup"}):e.jsx(E,{children:w.map(s=>e.jsx(N,{active:a===s,onClick:()=>_(s),style:{cursor:"pointer"},children:s},s))}):e.jsx("div",{className:"text-center p-3",children:"Select a backup first"})})})]})}),e.jsx(p,{md:"4",children:e.jsxs(f,{children:[e.jsx(j,{children:"Select Collection"}),e.jsx(C,{children:h?e.jsx(g,{}):e.jsx(e.Fragment,{children:a?R.length===0?e.jsx("div",{className:"text-center p-3",children:"No collections found in this database"}):l?e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:l}),e.jsx(y,{color:"link",onClick:q,size:"sm",children:"Change"})]})}):e.jsx(E,{children:R.map(s=>e.jsx(N,{onClick:()=>X(s),style:{cursor:"pointer"},children:s},s))}):e.jsx("div",{className:"text-center p-3",children:"Select a database first"})})})]})})]}),e.jsx(v,{className:"mt-4",children:e.jsx(p,{children:e.jsxs(f,{children:[e.jsx(j,{children:"Restore Options"}),e.jsxs(C,{children:[e.jsxs("div",{className:"mb-3",children:[t&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Backup:"})," ",t.name]}),a&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Database:"})," ",a]}),l&&e.jsxs("div",{children:[e.jsx("strong",{children:"Selected Collection:"})," ",l]})]}),t&&a&&l?e.jsx(y,{color:"warning",onClick:M,disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"sm"})," Restoring..."]}):"Restore Collection"}):e.jsx("div",{className:"text-muted",children:"Please select a backup, database, and collection to restore"})]})]})})})]})};export{oe as default};
