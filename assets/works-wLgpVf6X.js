import{r as re,s as ae,t as le,j as e,v as ie,w as ce,x as de,y as me,z as ue,A as pe,B as he,C as ge,D as ye}from"./index-Ac1Taqs-.js";import{r as c}from"./vendor-react-B6URQkMn.js";import{C as fe}from"./customhead-ChH2OSKL.js";import{P as xe}from"./papaparse.min-CPTD01QN.js";import{F as Ce,f as je}from"./DefaultLayout-aTjn5MyB.js";import{s as we,t as ke,v as ve,a9 as O,w as Re,j as y,P as N,c as Se,N as q,O as E,V as Ae,W as _,k as Pe,a2 as De,l as be,a7 as Fe,a8 as g}from"./vendor-coreui-vXCAeGSv.js";import{l}from"./activityLogger-CswLieGG.js";import"./vendor-redux-DipIbRRz.js";import"./Page500-D45Ymm3G.js";import"./cil-magnifying-glass-COgjSVTM.js";import"./permissionConfig-DLItbach.js";import"./index-t--hEgTQ.js";import"./axiosInstance-Dv2jt_v_.js";const V=({visible:j,onClose:w,userId:x})=>{const[k,M]=c.useState([]),U=sessionStorage.getItem("name"),p=[{name:"HR Dashboard",to:"/hrdash"},{name:"Finance Dashboard",to:"/financedash"},{name:"Core Dashboard",to:"/coredash"},{name:"Logistic Dashboard",to:"/logisticdash"},{name:"Employees",to:"/worker"},{name:"Payroll",to:"/payroll"},{name:"Transactions",to:"/freight/transaction"},{name:"User Activity",to:"/useractivity/index"},{name:"Restore",to:"/restore"},{name:"Customer",to:"/customer"},{name:"Monthly",to:"/monthly"},{name:"Daily",to:"/daily"},{name:"Breakdown",to:"/breakdown"}],{data:f,isLoading:A,error:D}=re(x),P=Array.isArray(f==null?void 0:f.permissions)?f.permissions:Array.isArray(f)?f:[],[$]=ae(),[u]=le(),v=n=>{n.stopPropagation()},R=n=>{M(b=>b.includes(n)?b.filter(G=>G!==n):[...b,n])},T=async()=>{if(!x){console.error("❌ Error: userId is null before making the API request.");return}try{await $({userId:x,newPermissions:k,grantedBy:U}).unwrap(),console.log("✅ Access granted successfully"),alert("Permissions granted successfully"),w()}catch(n){console.error("❌ Error granting access:",n),alert("Failed to grant access.")}},I=async()=>{if(!x){console.error("❌ Error: userId is null before making the API request.");return}try{await u({userId:x,permissionsToRemove:k}).unwrap(),console.log("✅ Access revoked successfully"),alert("Permissions revoked successfully"),w()}catch(n){console.error("❌ Error revoking access:",n),alert("Failed to revoke access.")}};return A?e.jsx("div",{children:"Loading permissions..."}):D?e.jsxs("div",{children:["Error loading permissions: ",D.toString()]}):e.jsxs(we,{visible:j,onClose:w,onClick:v,children:[e.jsx(ke,{onClick:v,children:"Manage Access Permission"}),e.jsxs(ve,{onClick:v,children:[e.jsx("h5",{children:"Grant Access"}),p.map(n=>e.jsx(O,{label:n.name,checked:k.includes(n.to),onChange:()=>R(n.to)},n.to)),e.jsx("h5",{children:"Revoke Access"}),P.map(n=>e.jsx(O,{label:n,checked:k.includes(n),onChange:()=>R(n)},n))]}),e.jsxs(Re,{onClick:v,children:[e.jsx(y,{color:"secondary",onClick:w,children:"Cancel"}),e.jsx(y,{color:"primary",onClick:T,children:"Grant Access"}),e.jsx(y,{color:"danger",onClick:I,children:"Revoke Access"})]})]})};V.propTypes={visible:N.bool.isRequired,onClose:N.func.isRequired,userId:N.string.isRequired};const Qe=()=>{const{data:j,isLoading:w,error:x}=ie(),[k]=ce(),[M]=de(),[U]=me(),[p,f]=c.useState(null),[A,D]=c.useState(""),[P,$]=c.useState({}),[u,v]=c.useState("all"),[R,T]=c.useState("all"),[I,n]=c.useState(null),[b,G]=c.useState(!1),[Ee,Me]=c.useState({userId:null,userName:null,newRole:null}),[Ue,$e]=c.useState({userId:null,userName:null}),[W,L]=c.useState(!1),[B,z]=c.useState(!1),[Q]=ue(),r=sessionStorage.getItem("role"),a=sessionStorage.getItem("department"),i=sessionStorage.getItem("name"),[J]=pe(),[K]=he(),[X]=ge(),[Y]=ye();if(c.useEffect(()=>{p&&(console.log("🟢 Opening Modal with userId:",p),L(!0))},[p]),c.useEffect(()=>{l({name:i,role:r,department:a,route:"/employees",action:"Page Visit",description:"User visited the Employees page"})},[]),w)return e.jsx("div",{children:"Loading..."});if(x)return e.jsxs("div",{children:["Error: ",x.message]});const Z=async s=>{const o=P[s]||"";if(!o){alert("Please select a role before updating.");return}try{await k({userId:s,newRole:o}),alert("Role updated successfully!");const t=j.find(C=>C._id===s),m=t?t.name:"Unknown User";l({name:m,role:r,department:a,route:"/employees",action:"Role Change",description:`Changed role for ${(t==null?void 0:t.name)||"Unknown User"} to ${o}`})}catch{alert("Error updating role"),l({name:i,role:r,department:a,route:"/employees",action:"Role Change Failed",description:`Failed to change role for user ID: ${s}`})}},ee=async s=>{if(window.confirm("Are you sure you want to delete this user?"))try{const o=j.find(m=>m._id===s),t=o?o.name:"Unknown User";await M({userId:s}),alert("User deleted successfully!"),l({name:i,role:r,department:a,route:"/employees",action:"Delete User",description:`Deleted user: ${t}`})}catch{alert("Error deleting user"),l({name:i,role:r,department:a,route:"/employees",action:"Delete User Failed",description:`Failed to delete user ID: ${s}`})}},se=()=>{const s=["Username","Name","Email","Phone Number","Country","Occupation","Role","Department"],o=F.map(d=>[d.username,d.name,d.email,d.phoneNumber,d.country,d.occupation,d.role,d.department]),t=xe.unparse([s,...o]),m=new Blob([t],{type:"text/csv;charset=utf-8;"}),C=URL.createObjectURL(m),h=document.createElement("a");h.href=C,h.download="All_Employees.csv",h.click(),URL.revokeObjectURL(C),l({name:i,role:r,department:a,route:"/employees",action:"Download Data",description:`Downloaded employee data (${F.length} records)`})},F=j.filter(s=>{const o=s.username||"",t=s.email||"",m=o.toLowerCase().includes(A.toLowerCase())||t.toLowerCase().includes(A.toLowerCase()),C=u==="all"||s.department===u,h=R==="all"||s.role===R;return m&&C&&h}),H=async(s,o)=>{try{const t=await U(s).unwrap(),{token:m,message:C}=t;n(m),alert(C);const h=j.find(ne=>ne._id===s),d={...h,oauthToken:m,department:o.toUpperCase()};let S;switch(o.toLowerCase()){case"hr":S=await J({payload:d}).unwrap();break;case"finance":S=await K({payload:d}).unwrap();break;case"core":S=await X({payload:d}).unwrap();break;case"logistics":S=await Y({payload:d}).unwrap();break;default:throw new Error("Invalid department")}console.log(`Response from ${o}:`,S),alert(S.message),l({name:i,role:r,department:a,route:"/employees",action:"Send to Department",description:`Sent user ${(h==null?void 0:h.name)||"Unknown"} data to ${o} department`})}catch(t){console.error("Error during generation and sending:",t),alert("Failed to generate token or send data."),l({name:i,role:r,department:a,route:"/employees",action:"Send to Department Failed",description:`Failed to send user data to ${o} department`})}},oe=()=>{if(u==="all"){alert("Please select a department to generate token.");return}const s=F.filter(o=>o.department===u);if(s.length===0){alert(`No employees found in ${u} department.`);return}s.forEach(o=>{H(o._id,u)}),l({name:i,role:r,department:a,route:"/employees",action:"Bulk Send to Department",description:`Sent ${s.length} employees' data to ${u} department`})},te=async s=>{try{const o=j.find(m=>m._id===s);if(!o||!o.email){alert("User email not found");return}const t=await Q(o.email).unwrap();alert(t.message||"Reset password link sent successfully"),l({name:i,role:r,department:a,route:"/employees",action:"Password Reset",description:`Sent password reset link to ${o.name} (${o.email})`})}catch(o){console.error("Error resetting password:",o),alert(o.message||"Failed to send reset password link"),l({name:i,role:r,department:a,route:"/employees",action:"Password Reset Failed",description:`Failed to send password reset link to user ID: ${s}`})}};return e.jsx(Se,{m:"1.5rem 2.5rem",children:e.jsxs(q,{children:[e.jsx(fe,{title:"Employees",subtitle:"List of Employees"}),e.jsx(E,{xs:"12",className:"mb-3",children:e.jsx(Ae,{placeholder:"Search by Username or Email",value:A,onChange:s=>{D(s.target.value),s.target.value&&s.target.value.length>=3&&l({name:i,role:r,department:a,route:"/employees",action:"Search",description:`User searched for: "${s.target.value}"`})}})}),e.jsxs(q,{className:"mb-3",children:[e.jsx(E,{xs:"4",children:e.jsxs(_,{value:u,onChange:s=>{v(s.target.value),s.target.value!=="all"&&l({name:i,role:r,department:a,route:"/employees",action:"Filter",description:`Filtered employees by department: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Departments"}),e.jsx("option",{value:"HR",children:"HR"}),e.jsx("option",{value:"Finance",children:"Finance"}),e.jsx("option",{value:"Core",children:"Core"}),e.jsx("option",{value:"Logistics",children:"Logistics"}),e.jsx("option",{value:"Administrative",children:"Administrative"})]})}),e.jsx(E,{xs:"4",children:e.jsxs(_,{value:R,onChange:s=>{T(s.target.value),s.target.value!=="all"&&l({name:i,role:r,department:a,route:"/employees",action:"Filter",description:`Filtered employees by role: ${s.target.value}`})},size:"sm",style:{width:"120px"},children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsx(E,{xs:"4",className:"d-flex justify-content-end",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs(y,{color:"info",onClick:se,size:"sm",className:"me-2",children:[e.jsx(Ce,{icon:je})," Download All"]}),e.jsxs(y,{color:"success",onClick:oe,size:"sm",children:["Send to ",u," Department"]})]})})]}),F.map(s=>e.jsxs(Pe,{className:"mb-3",style:{cursor:"pointer"},onClick:o=>{o.target.closest("button")||(console.log("🟢 Card Clicked ID:",s._id),p!==s._id&&l({name:i,role:r,department:a,route:"/employees",action:"View Employee",description:`Viewed details for employee: ${s.name}`}),f(t=>t===s._id?null:s._id),z(!1))},children:[e.jsxs(De,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h4",{children:[s.username," - ",s.name]}),e.jsx(y,{color:"primary",onClick:o=>{o.stopPropagation(),console.log("✅ Button Clicked ID:",s._id),l({name:i,role:r,department:a,route:"/employees",action:"Access Management",description:`Opened access management for: ${s.name}`}),f(s._id),z(!0),setTimeout(()=>{L(!0)},100)},children:"Access"})]}),p&&B&&e.jsx(V,{visible:W,onClose:()=>{L(!1),l({name:i,role:r,department:a,route:"/employees",action:"Close Access Management",description:`Closed access management modal for employee ID: ${p}`})},userId:p}),p===s._id&&!B&&e.jsx(be,{children:e.jsxs(Fe,{children:[e.jsxs(g,{children:["Email: ",s.email]}),e.jsxs(g,{children:["Phone Number: ",s.phoneNumber||"N/A"]}),e.jsxs(g,{children:["Country: ",s.country]}),e.jsxs(g,{children:["Occupation: ",s.occupation]}),e.jsxs(g,{children:["Role: ",s.role]}),e.jsxs(g,{children:["Department: ",s.department]}),e.jsx(g,{children:e.jsxs(_,{value:P[s._id]||"",onClick:o=>o.stopPropagation(),onChange:o=>{const t=o.target.value;$({...P,[s._id]:t}),t&&l({name:i,role:r,department:a,route:"/employees",action:"Select Role",description:`Selected role ${t} for ${s.name}`})},children:[e.jsx("option",{value:"",children:"Select Role"}),e.jsx("option",{value:"superadmin",children:"Super Admin"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"employee",children:"Employee"})]})}),e.jsxs(g,{children:[e.jsx(y,{color:"primary",size:"sm",onClick:o=>{o.stopPropagation(),Z(s._id)},children:"Change Role"}),e.jsx(y,{color:"danger",size:"sm",className:"ms-2",onClick:o=>{o.stopPropagation(),ee(s._id)},children:"Fire User"})]}),e.jsx(g,{children:s.department!=="Administrative"&&e.jsxs(y,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),H(s._id,s.department)},children:["Send to ",s.department]})}),e.jsx(g,{children:e.jsx(y,{color:"info",size:"sm",onClick:o=>{o.stopPropagation(),te(s._id)},children:"Send link to reset password"})})]})})]},s._id))]})})};export{Qe as default};
