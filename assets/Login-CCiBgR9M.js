import{c as J,j as e,_ as V}from"./index-DxMhGMaw.js";import{r as l,i as z,L as Q}from"./vendor-react-B6URQkMn.js";import{c as Y,N as C,O as y,Q as H,k as K,l as W,R as X,S as b,T as _,U as M,o as R,V as D,j as v,C as Z}from"./vendor-coreui-BN8uYOBb.js";import{c as ee}from"./cil-user-Ddrdy7PS.js";import{c as se}from"./cil-lock-locked-DmxpJbVL.js";import"./vendor-redux-C7peqcPR.js";const le=()=>{const[o,L]=l.useState({identifier:"",password:""}),[I,u]=l.useState(null),[j,k]=l.useState(!1),[f,S]=l.useState(0),[T,N]=l.useState(null),[A,E]=l.useState(null),[te,$]=l.useState(!1),r=z(),[q,{isLoading:x}]=J();l.useEffect(()=>{(()=>{const d=localStorage.getItem("accessToken"),i=localStorage.getItem("department");if(d)switch(console.log("Found existing session, navigating to dashboard..."),i==null?void 0:i.toLowerCase()){case"administrative":r("/employeedash");break;case"hr":r("/hrdash");break;case"core":r("/coredash");break;case"finance":r("/financedash");break;case"logistics":r("/logisticdash");break;default:r("/dashboard")}})()},[r]),l.useEffect(()=>{let t=null;return j&&f>0&&(t=setInterval(()=>{S(d=>{const i=d-1;return i<=0?(clearInterval(t),k(!1),0):i})},1e3)),()=>{t&&clearInterval(t)}},[j,f]);const B=async t=>{var d,i,U,O,P;if(t.preventDefault(),u(null),E(null),!o.identifier||!o.password){u("Both username/email and password are required.");return}try{const s=await q(o).unwrap();console.log("Login Success:",s),localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("refreshToken",s.refreshToken);const{id:a,name:w,username:g,role:h,email:F,department:m}=s.user;let n=[];if(s.user.permissions)if(Array.isArray(s.user.permissions))n=s.user.permissions,console.log("âœ… User permissions array:",n);else{console.warn("âš ï¸ Server returned permissions in unexpected format:",s.user.permissions);try{const c=typeof s.user.permissions=="string"?JSON.parse(s.user.permissions):s.user.permissions;Array.isArray(c)&&(n=c,console.log("âœ… Converted permissions to array:",n))}catch(c){console.error("âŒ Failed to parse permissions:",c)}}else console.warn("âš ï¸ No permissions found in user data");if(n.length===0&&h&&m)try{const c=await V(()=>import("./permissionConfig-Bwn9U3L8.js"),[]);(d=c.accessPermissions[h])!=null&&d[m]&&(n=c.accessPermissions[h][m],console.log("âœ… Using default role-based permissions:",n))}catch(c){console.error("âŒ Failed to import permissions config:",c)}switch(localStorage.setItem("userId",a),localStorage.setItem("username",g||""),localStorage.setItem("name",w||""),localStorage.setItem("email",F||""),localStorage.setItem("role",h||""),localStorage.setItem("department",m||""),localStorage.setItem("permissions",JSON.stringify(n)),console.log("ðŸ“¦ Local Storage after login:",{userId:a,username:g||"",name:w||"",email:F||"",role:h||"",department:m||"",permissions:n}),s.securityAlert&&E(s.securityAlert.message||"Unusual activity detected on your account."),m==null?void 0:m.toLowerCase()){case"administrative":r("/employeedash");break;case"hr":r("/hrdash");break;case"core":r("/coredash");break;case"finance":r("/financedash");break;case"logistics":r("/logisticdash");break;default:r("/dashboard")}}catch(s){if(console.error("Login Failed:",s),s.status===429){if(k(!0),(i=s.data)!=null&&i.lockedUntil){const a=new Date(s.data.lockedUntil),g=Math.ceil((a-new Date)/1e3);S(g>0?g:900),N(a)}else{S(900);const a=new Date;a.setMinutes(a.getMinutes()+15),N(a)}u(((U=s.data)==null?void 0:U.message)||"Too many failed login attempts. This account is temporarily locked."),$(!0)}else{const a=(O=s.data)==null?void 0:O.remainingAttempts;u(a!==void 0?`Invalid credentials. You have ${a} ${a===1?"attempt":"attempts"} remaining.`:((P=s.data)==null?void 0:P.message)||"Login failed. Please check your credentials and try again.")}}},G=()=>{const t=Math.floor(f/60),d=f%60;return`${t.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`},p=j&&o.identifier!=="";return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(Y,{children:e.jsx(C,{className:"justify-content-center",children:e.jsx(y,{md:8,children:e.jsx(H,{children:e.jsx(K,{className:"p-4",children:e.jsx(W,{children:e.jsxs(X,{onSubmit:B,children:[e.jsx("h1",{children:"Login"}),e.jsx("p",{className:"text-body-secondary",children:"Sign In to your account"}),A&&e.jsxs(b,{color:"warning",children:[e.jsx("strong",{children:"Security Notice:"})," ",A]}),p&&e.jsxs(b,{color:"danger",children:[e.jsx("strong",{children:"Account Temporarily Locked"}),e.jsxs("p",{children:["This account (",o.identifier,") has been temporarily locked due to too many failed login attempts. Please try again in ",G(),"."]}),T&&e.jsxs("small",{children:["Lockout expires at: ",T.toLocaleTimeString()]})]}),!p&&I&&e.jsx(b,{color:"danger",children:I}),e.jsxs(_,{className:"mb-3",children:[e.jsx(M,{children:e.jsx(R,{icon:ee})}),e.jsx(D,{type:"text",placeholder:"Email or Username",autoComplete:"email",value:o.identifier,onChange:t=>{t.target.value!==o.identifier&&(k(!1),u(null)),L({...o,identifier:t.target.value})},disabled:x,required:!0})]}),e.jsxs(_,{className:"mb-4",children:[e.jsx(M,{children:e.jsx(R,{icon:se})}),e.jsx(D,{type:"password",placeholder:"Password",autoComplete:"current-password",value:o.password,onChange:t=>L({...o,password:t.target.value}),disabled:x||p,required:!0})]}),e.jsxs(C,{children:[e.jsx(y,{xs:6,children:e.jsx(v,{type:"submit",color:"primary",className:"px-4",disabled:x||p,children:x?e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:"sm",className:"me-2"})," Logging in..."]}):p?"Account Locked":"Login"})}),e.jsx(y,{xs:6,className:"text-end",children:e.jsx(Q,{to:"/forgotpass",children:e.jsx(v,{color:"link",className:"px-0",children:"Forgot password?"})})})]}),p&&e.jsx(C,{className:"mt-3",children:e.jsx(y,{xs:12,children:e.jsx(v,{type:"button",color:"secondary",className:"w-100",onClick:()=>window.location.href="/OTP",children:"Use OTP to Unlock Account"})})})]})})})})})})})})};export{le as default};
