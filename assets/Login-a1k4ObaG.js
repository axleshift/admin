import{c as Z,j as e,_ as ee}from"./index-EtLHJ1Gn.js";import{r as c,i as se,L as re}from"./vendor-react-B6URQkMn.js";import{c as ae,N as v,O as x,Q as te,k as oe,l as ie,R as ne,S as y,T as $,U as B,o as V,V as z,j as b,C as ce}from"./vendor-coreui-DGBpOIqK.js";import{c as le}from"./cil-user-Ddrdy7PS.js";import{c as de}from"./cil-lock-locked-DmxpJbVL.js";import"./vendor-redux-C7peqcPR.js";const P="6LdeRSErAAAAAO_tTaCq0sa9yVOtB3-jl6avr05G",Ce=()=>{const[l,L]=c.useState({identifier:"",password:""}),[E,p]=c.useState(null),[A,S]=c.useState(!1),[w,k]=c.useState(0),[I,N]=c.useState(null),[H,R]=c.useState(null),[ue,J]=c.useState(!1),[Y,j]=c.useState(!1),[T,U]=c.useState(null),i=se(),[K,{isLoading:C}]=Z();c.useEffect(()=>{(()=>{const r=localStorage.getItem("accessToken"),a=localStorage.getItem("department");if(r)switch(console.log("Found existing session, navigating to dashboard..."),a==null?void 0:a.toLowerCase()){case"administrative":i("/employeedash");break;case"hr":i("/hrdash");break;case"core":i("/coredash");break;case"finance":i("/financedash");break;case"logistics":i("/logisticdash");break;default:i("/dashboard")}})()},[i]),c.useEffect(()=>{(()=>{if(window.grecaptcha&&window.grecaptcha.enterprise||window.grecaptcha&&window.grecaptcha.ready){(window.grecaptcha.enterprise?window.grecaptcha.enterprise.ready:window.grecaptcha.ready)(()=>{j(!0),console.log("âœ… reCAPTCHA is ready")});return}const r=document.createElement("script");r.src=`https://www.google.com/recaptcha/enterprise.js?render=${P}`,r.async=!0,r.defer=!0,r.onload=()=>{window.grecaptcha&&window.grecaptcha.enterprise?window.grecaptcha.enterprise.ready(()=>{j(!0),console.log("âœ… reCAPTCHA Enterprise is ready")}):window.grecaptcha&&window.grecaptcha.ready?window.grecaptcha.ready(()=>{j(!0),console.log("âœ… reCAPTCHA v3 is ready")}):(U("Failed to initialize reCAPTCHA."),console.error("âŒ reCAPTCHA initialization failed"))},r.onerror=()=>{U("Failed to load reCAPTCHA script."),console.error("âŒ Failed to load reCAPTCHA script")},document.head.appendChild(r)})()},[]),c.useEffect(()=>{let s=null;return A&&w>0&&(s=setInterval(()=>{k(r=>{const a=r-1;return a<=0?(clearInterval(s),S(!1),0):a})},1e3)),()=>{s&&clearInterval(s)}},[A,w]);const Q=async()=>{var s,r;if(!Y||T)return console.warn("Skipping reCAPTCHA verification due to errors or not ready."),"recaptcha-unavailable";try{let a=null;return(s=window.grecaptcha)!=null&&s.enterprise?(console.log("Using reCAPTCHA Enterprise"),a=await window.grecaptcha.enterprise.execute(P,{action:"login"}),console.log("Generated enterprise reCAPTCHA token"),a):(r=window.grecaptcha)!=null&&r.execute?(console.log("Using reCAPTCHA v3"),a=await window.grecaptcha.execute(P,{action:"login"}),a):(console.warn("No reCAPTCHA method available"),"recaptcha-unavailable")}catch(a){return console.error("Error executing reCAPTCHA:",a),"recaptcha-unavailable"}},W=async s=>{var r,a,F,O,_,D;if(s.preventDefault(),p(null),R(null),!l.identifier||!l.password){p("Both username/email and password are required.");return}try{const t=await Q();t==="recaptcha-unavailable"?console.warn("reCAPTCHA unavailable, proceeding without verification"):console.log("Generated reCAPTCHA token:",t);const n={identifier:l.identifier,password:l.password,captchaToken:t};console.log("Login request payload:",n);const o=await K(n).unwrap();console.log("Login Success:",o),localStorage.setItem("accessToken",o.accessToken),localStorage.setItem("refreshToken",o.refreshToken);const{id:h,name:M,username:q,role:f,email:G,department:m}=o.user;let d=[];if(o.user.permissions)if(Array.isArray(o.user.permissions))d=o.user.permissions,console.log("âœ… User permissions array:",d);else{console.warn("âš ï¸ Server returned permissions in unexpected format:",o.user.permissions);try{const u=typeof o.user.permissions=="string"?JSON.parse(o.user.permissions):o.user.permissions;Array.isArray(u)&&(d=u,console.log("âœ… Converted permissions to array:",d))}catch(u){console.error("âŒ Failed to parse permissions:",u)}}else console.warn("âš ï¸ No permissions found in user data");if(d.length===0&&f&&m)try{const u=await ee(()=>import("./permissionConfig-Bwn9U3L8.js"),[]);(r=u.accessPermissions[f])!=null&&r[m]&&(d=u.accessPermissions[f][m],console.log("âœ… Using default role-based permissions:",d))}catch(u){console.error("âŒ Failed to import permissions config:",u)}switch(localStorage.setItem("userId",h),localStorage.setItem("username",q||""),localStorage.setItem("name",M||""),localStorage.setItem("email",G||""),localStorage.setItem("role",f||""),localStorage.setItem("department",m||""),localStorage.setItem("permissions",JSON.stringify(d)),console.log("ðŸ“¦ Local Storage after login:",{userId:h,username:q||"",name:M||"",email:G||"",role:f||"",department:m||"",permissions:d}),o.securityAlert&&R(o.securityAlert.message||"Unusual activity detected on your account."),m==null?void 0:m.toLowerCase()){case"administrative":i("/employeedash");break;case"hr":i("/hrdash");break;case"core":i("/coredash");break;case"finance":i("/financedash");break;case"logistics":i("/logisticdash");break;default:i("/dashboard")}}catch(t){if(console.error("Login Failed:",t),t.status===400)p(((a=t.data)==null?void 0:a.message)||"Invalid request. Please check your input.");else if(t.status===403)p("CAPTCHA verification failed. Please try again.");else if(t.status===429){if(S(!0),(F=t.data)!=null&&F.lockedUntil){const n=new Date(t.data.lockedUntil),h=Math.ceil((n-new Date)/1e3);k(h>0?h:900),N(n)}else{k(900);const n=new Date;n.setMinutes(n.getMinutes()+15),N(n)}p(((O=t.data)==null?void 0:O.message)||"Too many failed login attempts. This account is temporarily locked."),J(!0)}else{const n=(_=t.data)==null?void 0:_.remainingAttempts;p(n!==void 0?`Invalid credentials. You have ${n} ${n===1?"attempt":"attempts"} remaining.`:((D=t.data)==null?void 0:D.message)||"Login failed. Please check your credentials and try again.")}}},X=()=>{const s=Math.floor(w/60),r=w%60;return`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},g=A&&l.identifier!=="";return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(ae,{children:e.jsx(v,{className:"justify-content-center",children:e.jsx(x,{md:8,children:e.jsx(te,{children:e.jsx(oe,{className:"p-4",children:e.jsx(ie,{children:e.jsxs(ne,{onSubmit:W,children:[e.jsx("h1",{children:"Login"}),e.jsx("p",{className:"text-body-secondary",children:"Sign In to your account"}),H&&e.jsxs(y,{color:"warning",children:[e.jsx("strong",{children:"Security Notice:"})," ",H]}),g&&e.jsxs(y,{color:"danger",children:[e.jsx("strong",{children:"Account Temporarily Locked"}),e.jsxs("p",{children:["This account (",l.identifier,") has been temporarily locked due to too many failed login attempts. Please try again in ",X(),"."]}),I&&e.jsxs("small",{children:["Lockout expires at: ",I.toLocaleTimeString()]})]}),!g&&E&&e.jsx(y,{color:"danger",children:E}),T&&e.jsxs(y,{color:"warning",children:[e.jsx("strong",{children:"Security Verification Issue:"})," ",T]}),e.jsxs($,{className:"mb-3",children:[e.jsx(B,{children:e.jsx(V,{icon:le})}),e.jsx(z,{type:"text",placeholder:"Email or Username",autoComplete:"email",value:l.identifier,onChange:s=>{s.target.value!==l.identifier&&(S(!1),p(null)),L({...l,identifier:s.target.value})},disabled:C,required:!0})]}),e.jsxs($,{className:"mb-4",children:[e.jsx(B,{children:e.jsx(V,{icon:de})}),e.jsx(z,{type:"password",placeholder:"Password",autoComplete:"current-password",value:l.password,onChange:s=>L({...l,password:s.target.value}),disabled:C||g,required:!0})]}),e.jsxs(v,{children:[e.jsx(x,{xs:6,children:e.jsx(b,{type:"submit",color:"primary",className:"px-4",disabled:C||g,children:C?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-2"})," Logging in..."]}):g?"Account Locked":"Login"})}),e.jsx(x,{xs:6,className:"text-end",children:e.jsx(re,{to:"/forgotpass",children:e.jsx(b,{color:"link",className:"px-0",children:"Forgot password?"})})})]}),g&&e.jsx(v,{className:"mt-3",children:e.jsx(x,{xs:12,children:e.jsx(b,{type:"button",color:"secondary",className:"w-100",onClick:()=>window.location.href="/OTP",children:"Use OTP to Unlock Account"})})})]})})})})})})})})};export{Ce as default};
